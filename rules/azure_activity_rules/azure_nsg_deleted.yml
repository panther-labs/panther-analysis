AnalysisType: rule
Filename: azure_nsg_deleted.py
RuleID: "Azure.MonitorActivity.Network.NSGDeleted"
DisplayName: "Azure Network Security Group Deleted"
Enabled: true
LogTypes:
  - Azure.MonitorActivity
Severity: High
Status: Experimental
Description: >
  Detects when an Azure Network Security Group (NSG) is deleted.
  NSG deletion removes network security controls and firewall rules, which may indicate defense evasion tactics by attackers
  attempting to open network access for lateral movement or data exfiltration.
Reports:
  MITRE ATT&CK:
    - TA0005:T1562.007 # Defense Evasion: Impair Defenses - Disable or Modify Cloud Firewall
    - TA0040:T1485 # Impact: Data Destruction
Runbook: |
  1. Query Azure Monitor Activity logs for all NSG and firewall rule operations by the callerIpAddress in the 24 hours before and after the alert to identify if multiple network security controls are being disabled
  2. Find all network configuration changes and security group modifications from the same caller in the past 7 days to assess if this is part of a defense evasion pattern
  3. Check if the source IP matches known VPN ranges or corporate network addresses associated with authorized network administrators
Reference: https://attack.mitre.org/techniques/T1562/007/
SummaryAttributes:
  - resourceId
  - callerIpAddress
  - correlationId
Tests:
  - Name: NSG Deleted Successfully
    ExpectedResult: true
    Log:
      {
        "time": "2024-12-17T10:30:00.0000000Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Network/networkSecurityGroups/mynsg",
        "operationName": "Microsoft.Network/networkSecurityGroups/delete",
        "operationVersion": "2021-04-01",
        "category": "Administrative",
        "resultType": "Success",
        "resultSignature": "200",
        "callerIpAddress": "1.1.1.1",
        "correlationId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "location": "",
        "tenantId": "87654321-4321-4321-4321-111111111111"
      }
  - Name: Case Insensitive Match
    ExpectedResult: true
    Log:
      {
        "time": "2024-12-17T11:45:00.0000000Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/prod-rg/providers/Microsoft.Network/networkSecurityGroups/prodnsg",
        "operationName": "microsoft.network/networksecuritygroups/delete",
        "operationVersion": "2021-04-01",
        "category": "Administrative",
        "resultType": "Succeeded",
        "callerIpAddress": "1.2.3.4",
        "correlationId": "f9e8d7c6-b5a4-3210-9876-fedcba098765",
        "location": "eastus",
        "tenantId": "87654321-4321-4321-4321-111111111111"
      }
  - Name: Different Operation
    ExpectedResult: false
    Log:
      {
        "time": "2024-12-17T13:30:00.0000000Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Network/networkSecurityGroups/mynsg",
        "operationName": "Microsoft.Network/networkSecurityGroups/write",
        "operationVersion": "2021-04-01",
        "category": "Administrative",
        "resultType": "Success",
        "callerIpAddress": "1.2.3.4",
        "correlationId": "d4e5f6a7-b8c9-0123-def0-234567890123",
        "location": "westus",
        "tenantId": "87654321-4321-4321-4321-111111111111"
      }