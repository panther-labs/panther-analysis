AnalysisType: rule
Filename: azure_storage_blob_bulk_deletion.py
RuleID: "Azure.MonitorActivity.Storage.Blob.BulkDeletion"
DisplayName: "Azure Storage Blob Deletion"
Enabled: true
LogTypes:
  - Azure.MonitorActivity
Severity: Medium
Status: Experimental
Threshold: 10
DedupPeriodMinutes: 15
Description: >
  Detects when blobs are deleted from Azure Storage accounts via the DeleteBlob operation.
  Multiple deletion events in a short time frame may indicate ransomware activity, data destruction,
  or malicious insider activity. This rule fires on individual deletions and can be aggregated
  in Panther to detect bulk deletion patterns by configuring deduplication on storage account
  or caller IP address.
Reports:
  MITRE ATT&CK:
    - TA0040:T1485 # Impact: Data Destruction
    - TA0040:T1490 # Impact: Inhibit System Recovery
Runbook: |
  1. Query Azure Monitor Activity logs for all DeleteBlob operations from the same callerIpAddress in the past 1 hour to identify bulk deletion patterns
  2. Check the Azure Storage account's soft-delete and versioning settings to determine if deleted blobs can be recovered
  3. Review Azure AD sign-in logs for the identity associated with the caller IP to verify if the account is compromised
  4. Search for preceding ListAccountSAS or ListKeys operations that may indicate credential theft before the deletion
  5. Check if the same IP or user performed PutBlob operations before deletion (potential ransomware staging pattern)
  6. Verify if this activity aligns with scheduled maintenance, backup operations, or legitimate data lifecycle management
Reference: https://learn.microsoft.com/en-us/dotnet/api/azure.storage.blobs.blobcontainerclient.deleteblob?view=azure-dotnet
SummaryAttributes:
  - callerIpAddress
  - resourceId
  - p_any_usernames
Tags:
  - Ransomware
  - Data Destruction
  - Azure Storage
Tests:
  - Name: Successful Blob Deletion
    ExpectedResult: true
    Log:
      {
        "time": "2024-12-19T16:37:59.255Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "operationName": "DeleteBlob",
        "callerIpAddress": "5.5.5.5:28915",
        "location": "eastus",
        "category": "StorageWrite",
        "level": "Informational",
        "properties": {
          "accountName": "mystorageaccount",
          "clientRequestId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
          "metricResponseType": "Success",
          "objectKey": "/mystorageaccount/corporate-files/documents/internal_doc_13.txt",
          "serverLatencyMs": 22,
          "serviceType": "blob",
          "tlsVersion": "TLS 1.3",
          "userAgentHeader": "AZURECLI/2.79.0 (RPM) azsdk-python-storage-blob/12.16.0 Python/3.12.9 (Linux-6.6.6.6-microsoft-standard-x86_64-with-glibc2.38) cloud-shell/1.0"
        },
        "tenantId": "87654321-4321-4321-4321-111111111111"
      }
  - Name: Case Insensitive Match
    ExpectedResult: true
    Log:
      {
        "time": "2024-12-19T16:37:50.733Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "operationName": "deleteblob",
        "callerIpAddress": "5.5.5.5:3832",
        "location": "eastus",
        "properties": {
          "accountName": "mystorageaccount",
          "metricResponseType": "Success",
          "objectKey": "/mystorageaccount/corporate-files/documents/board_meeting_notes.docx",
          "userAgentHeader": "AZURECLI/2.79.0 (RPM) azsdk-python-storage-blob/12.16.0 Python/3.12.9"
        },
        "tenantId": "87654321-4321-4321-4321-111111111111"
      }
  - Name: Sensitive File Deletion
    ExpectedResult: true
    Log:
      {
        "time": "2024-12-19T16:37:52.928Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "operationName": "DeleteBlob",
        "callerIpAddress": "5.5.5.5:36589",
        "location": "eastus",
        "properties": {
          "accountName": "mystorageaccount",
          "metricResponseType": "Success",
          "objectKey": "/mystorageaccount/corporate-files/documents/employee_ssn.csv"
        },
        "tenantId": "87654321-4321-4321-4321-111111111111"
      }
  - Name: Different Operation PutBlob
    ExpectedResult: false
    Log:
      {
        "time": "2024-12-19T16:32:35.076Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "operationName": "PutBlob",
        "callerIpAddress": "5.5.5.5:23861",
        "location": "eastus",
        "properties": {
          "accountName": "mystorageaccount",
          "metricResponseType": "Success",
          "objectKey": "/mystorageaccount/corporate-files/documents/passwords.txt"
        },
        "tenantId": "87654321-4321-4321-4321-111111111111"
      }
  - Name: GetBlob Operation
    ExpectedResult: false
    Log:
      {
        "time": "2024-12-19T17:01:29.151Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "operationName": "GetBlobServiceProperties",
        "callerIpAddress": "10.0.0.1:42781",
        "location": "eastus",
        "properties": {
          "accountName": "mystorageaccount",
          "metricResponseType": "Success"
        },
        "tenantId": "87654321-4321-4321-4321-210987654321"
      }