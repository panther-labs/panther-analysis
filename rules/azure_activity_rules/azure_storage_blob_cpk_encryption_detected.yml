AnalysisType: rule
Filename: azure_storage_blob_cpk_encryption_detected.py
RuleID: "Azure.MonitorActivity.Storage.Blob.CPKEncryptionDetected"
DisplayName: "Azure Storage Blob CPK Encryption Detected"
Enabled: true
LogTypes:
  - Azure.MonitorActivity
Severity: High
Status: Experimental
Description: >
  Detects when users attempt to access Azure Storage blobs that are encrypted with
  Customer-Provided Keys (CPK) but fail because they don't have the encryption key.
  This may indicate a ransomware operation that is using CPK encryption to hold data hostage,
  as legitimate users cannot access their own encrypted blobs without the attacker's key.
  409 errors with "BlobUsesCustomerSpecifiedEncryption" indicate data has been
  encrypted and is inaccessible to the organization.
Reports:
  MITRE ATT&CK:
    - TA0040:T1486 # Impact: Data Encrypted for Impact
    - TA0040:T1490 # Impact: Inhibit System Recovery
Runbook: |
  1. Immediately investigate the source of PutBlob operations that preceded these errors to identify when and how files were encrypted
  2. Query for all PutBlob operations from the same IP/caller in the past 24 hours to identify the scope of encrypted blobs
  3. Check if blob versioning or soft-delete is enabled to potentially recover original unencrypted versions
  4. Review Azure AD sign-in logs for any compromised accounts or service principals that may have performed the encryption
  5. Search for ListAccountSAS or ListKeys operations that may indicate credential theft before encryption
  6. Isolate the attacker's access immediately by rotating storage account keys and revoking SAS tokens
  7. Contact Azure Support to understand recovery options for CPK-encrypted blobs (NOTE: Recovery without the key is not possible)
Reference: https://learn.microsoft.com/en-us/dotnet/api/azure.storage.blobs.models.bloberrorcode.blobusescustomerspecifiedencryption?view=azure-dotnet
SummaryAttributes:
  - callerIpAddress
  - resourceId
  - p_any_usernames
Tags:
  - Ransomware
  - CPK Encryption
  - Data Encrypted for Impact
  - Azure Storage
Tests:
  - Name: CPK Encrypted Blob Access Denied
    ExpectedResult: true
    Log:
      {
        "time": "2024-12-19T19:15:07.295Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "category": "StorageRead",
        "operationName": "GetBlobMetadata",
        "operationVersion": "2024-11-04",
        "schemaVersion": "1.0",
        "statusCode": 409,
        "statusText": "BlobUsesCustomerSpecifiedEncryption",
        "durationMs": 4,
        "callerIpAddress": "1.1.1.1:57485",
        "correlationId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "identity": {
          "type": "SAS",
          "tokenHash": "key1(EXAMPLE_HASH)"
        },
        "location": "westus2",
        "properties": {
          "accountName": "mystorageaccount",
          "userAgentHeader": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/7.7.7.7 Safari/537.36",
          "serviceType": "blob",
          "objectKey": "/mystorageaccount/corporate-files/documents/internal_doc_8.txt.ENCRYPTED",
          "metricResponseType": "ClientOtherError",
          "serverLatencyMs": 4,
          "tlsVersion": "TLS 1.3"
        },
        "protocol": "HTTPS"
      }
  - Name: GetBlobProperties CPK Error
    ExpectedResult: true
    Log:
      {
        "time": "2024-12-19T19:15:07.304Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "category": "StorageRead",
        "operationName": "GetBlobProperties",
        "statusCode": 409,
        "statusText": "BlobUsesCustomerSpecifiedEncryption",
        "durationMs": 2,
        "callerIpAddress": "1.1.1.1:57484",
        "properties": {
          "accountName": "mystorageaccount",
          "userAgentHeader": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
          "serviceType": "blob",
          "objectKey": "/mystorageaccount/corporate-files/documents/sensitive_data.xlsx.ENCRYPTED",
          "metricResponseType": "ClientOtherError"
        }
      }
  - Name: Successful Blob Read
    ExpectedResult: false
    Log:
      {
        "time": "2024-12-19T19:15:17.669Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "category": "StorageRead",
        "operationName": "GetBlobProperties",
        "statusCode": 200,
        "statusText": "Success",
        "durationMs": 1,
        "callerIpAddress": "1.1.1.1:57485",
        "properties": {
          "accountName": "mystorageaccount",
          "objectKey": "/mystorageaccount/corporate-files/documents/normal_document.docx",
          "metricResponseType": "Success"
        }
      }
  - Name: Different Error Code
    ExpectedResult: false
    Log:
      {
        "time": "2024-12-19T19:15:08.173Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "category": "StorageRead",
        "operationName": "GetBlobMetadata",
        "statusCode": 403,
        "statusText": "AuthorizationPermissionMismatch",
        "callerIpAddress": "1.1.1.1:57484",
        "properties": {
          "accountName": "mystorageaccount",
          "objectKey": "/mystorageaccount/test/documents/file.txt",
          "metricResponseType": "AuthorizationError"
        }
      }
  - Name: StorageWrite Category
    ExpectedResult: false
    Log:
      {
        "time": "2024-12-19T19:14:59.091Z",
        "resourceId": "/subscriptions/12345678-1234-1234-1234-123456789abc/resourceGroups/myresourcegroup/providers/Microsoft.Storage/storageAccounts/mystorageaccount/blobServices/default",
        "category": "StorageWrite",
        "operationName": "PutBlob",
        "statusCode": 201,
        "statusText": "Success",
        "callerIpAddress": "203.0.113.10:29713",
        "properties": {
          "accountName": "mystorageaccount",
          "objectKey": "/mystorageaccount/test/documents/internal_doc_15.txt.ENCRYPTED",
          "metricResponseType": "Success"
        }
      }