AnalysisType: rule
Filename: aws_guardduty_critical_sev_findings.py
RuleID: "AWS.GuardDuty.CriticalSeverityFinding"
DisplayName: "AWS GuardDuty Critical Severity Finding"
Enabled: true
LogTypes:
  - AWS.GuardDuty
Tags:
  - AWS
  - Threat Detection
  - Automated Security
  - Anomaly Detection
  - GuardDuty
  - Machine Learning
Severity: Critical
Reports:
  MITRE ATT&CK:
    - TA0001:T1078
DedupPeriodMinutes: 15
Description: >
  Detects critical-severity findings from AWS GuardDuty, Amazon's intelligent threat detection service that continuously monitors AWS accounts and workloads for malicious activity and unauthorized behavior. GuardDuty uses machine learning, anomaly detection, and integrated threat intelligence to identify threats such as compromised credentials, cryptocurrency mining, data exfiltration, unauthorized infrastructure deployments, reconnaissance activity, and communication with known malicious IPs. Critical severity findings (9.0 on GuardDuty's 0-9 scale) represent the most serious threats that indicate active compromise, imminent data loss, or ongoing attacks that require immediate investigation and response. These findings often include attack sequences showing multiple MITRE ATT&CK tactics and techniques, connections from malicious infrastructure (Tor nodes, botnets), or high-impact API calls targeting sensitive resources. This rule filters out sample/test data and alerts only on genuine critical findings to enable rapid incident response and minimize potential damage from confirmed threats.
Runbook: |
  1. Review the GuardDuty finding details from the alert including the finding type, title, description, affected resource, MITRE ATT&CK tactics/techniques, and timeline, then look up the specific finding type in AWS documentation at https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_finding-types-active.html
  2. Immediately assess the scope by identifying all affected resources (IAM users, roles, EC2 instances, S3 buckets) and determine if credentials or resources are actively compromised
  3. If credentials are compromised, immediately rotate or disable the affected access keys, passwords, or session tokens; if EC2 instances are compromised, isolate them by modifying security groups, create forensic snapshots, and consider terminating and rebuilding from clean AMIs
  4. Review CloudTrail logs for the affected principal/resource during the attack timeframe to identify all unauthorized actions, API calls, resource modifications, and potential data access or exfiltration
  5. Search application logs, VPC Flow Logs, and S3 access logs for evidence of data access, exfiltration attempts, lateral movement, or persistence mechanisms established by the attacker
  6. For Attack Sequence findings, investigate each signal in the sequence to understand the full attack chain and identify any additional compromised resources not explicitly listed in the finding
  7. Remediate based on finding type: revoke unauthorized permissions, delete malicious resources (backdoor users, roles, Lambda functions), remove data access policies, terminate cryptocurrency miners, etc.
  8. Enable additional logging and monitoring (CloudTrail Insights, VPC Flow Logs, S3 access logging) on affected resources to detect any recurring malicious activity
  9. Document the incident including attack timeline, affected resources, actions taken, data potentially accessed or exfiltrated, and root cause analysis
  10. Implement preventive measures such as enforcing MFA, enabling CloudTrail protection, implementing SCPs to restrict sensitive actions, and reviewing IAM permissions for least privilege
Reference: https://docs.aws.amazon.com/guardduty/latest/ug/guardduty_findings.html#guardduty_findings-severity
SummaryAttributes:
  - severity
  - type
  - title
  - p_any_domain_names
  - p_any_aws_arns
  - p_any_aws_account_ids
Tests:
  - Name: Critical Sev Finding
    ExpectedResult: true
    Log:
      {
        "accountId": "123456789012",
        "arn": "arn:aws:guardduty:us-east-1:123456789012:detector/111111bbbbbbbbbb5555555551111111/finding/8c258d654378414b9bc26f61a93eb816",
        "createdAt": "2025-02-25 20:40:06.721",
        "description": "A sequence of actions involving 4 signals indicating a possible credential compromise was observed for IAMUser/john_doe with principalId AIDA3UBBJ2K3TVEXAMPLE in account 111122223333\nbetween eventFirstSeen and eventLastSeen with the following behaviors:\n  - 5 MITRE ATT&CK tactics observed: Persistence, Privilege Escalation, Defense Evasion, Discovery, Initial Access\n  - 5 MITRE ATT&CK techniques observed: T1562.008 - Impair Defenses: Disable or Modify Cloud Logs, T1098.003 - Account Manipulation: Additional Cloud Roles, T1078.004 - Valid Accounts: Cloud Accounts, T1087.004 - Account Discovery: Cloud Account, T1098 - Account Manipulation\n  - Connected from a known Tor Exit Node: 10.0.0.1\n  - 4 sensitive APIs called: cloudtrail:DeleteTrail, iam:AttachRolePolicy, iam:CreateRole, iam:ListUsers\n",
        "id": "8c258d654378414b9bc26f61a93eb816",
        "partition": "aws",
        "region": "us-east-1",
        "resource": {
          "resourceType": "AttackSequence"
        },
        "schemaVersion": "2.0",
        "service": {
          "additionalInfo": {},
          "archived": false,
          "count": 1,
          "detectorId": "111111bbbbbbbbbb5555555551111111",
          "eventFirstSeen": "2025-02-25 20:40:06.000000000",
          "eventLastSeen": "2025-02-25 20:40:06.000000000",
          "featureName": "Correlation",
          "resourceRole": "TARGET",
          "serviceName": "guardduty"
        },
        "severity": 9,
        "title": "Potential credential compromise of IAMUser/john_doe indicated by a sequence of actions.",
        "type": "AttackSequence:IAM/CompromisedCredentials",
        "updatedAt": "2025-02-25 20:40:06.721"
      }
  - Name: Critical Sev Finding As Sample Data
    ExpectedResult: false
    Log:
      {
        "accountId": "123456789012",
        "arn": "arn:aws:guardduty:us-east-1:123456789012:detector/111111bbbbbbbbbb5555555551111111/finding/b174b38d16e34da0a4c66012083bd8f7",
        "createdAt": "2025-02-25 20:40:06.765",
        "description": "A sequence of actions involving 14 signals indicating a possible credential compromise one or more S3 bucket(s) was observed for IAMUser/john_doe with principalId AIDA3UBBJ2K3TVEXAMPLE in account 111122223333\nbetween eventFirstSeen and eventLastSeen with the following behaviors:\n  - 5 MITRE ATT&CK tactics observed: Exfiltration, Impact, Persistence, Defense Evasion, Discovery\n  - 5 MITRE ATT&CK techniques observed: T1526 - Cloud Service Discovery, T1098 - Account Manipulation, T1078.004 - Valid Accounts: Cloud Accounts, T1485 - Data Destruction, T1530 - Data from Cloud Storage\n  - Connected from a known Tor Exit Node: 10.0.0.1\n  - 7 sensitive APIs called: s3:DeleteObject, s3:GetObject, s3:PutBucketPublicAccessBlock, cloudtrail:DeleteTrail, iam:AttachUserPolicy, s3:ListObjects, s3:ListBuckets\n",
        "id": "b174b38d16e34da0a4c66012083bd8f7",
        "partition": "aws",
        "region": "us-east-1",
        "resource": {
          "resourceType": "AttackSequence"
        },
        "schemaVersion": "2.0",
        "service": {
          "additionalInfo": {
            "sample": true,
            "type": "default",
            "value": "{\"sample\":true}"
          },
          "archived": false,
          "count": 1,
          "detectorId": "111111bbbbbbbbbb5555555551111111",
          "eventFirstSeen": "2025-02-25 20:40:06.000000000",
          "eventLastSeen": "2025-02-25 20:40:06.000000000",
          "featureName": "Correlation",
          "resourceRole": "TARGET",
          "serviceName": "guardduty"
        },
        "severity": 9,
        "title": "Potential data compromise of one or more S3 buckets involving a sequence of actions associated with IAMUser/john_doe.",
        "type": "AttackSequence:S3/CompromisedData",
        "updatedAt": "2025-02-25 20:40:06.765"
      }
