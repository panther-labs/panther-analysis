AnalysisType: rule
Filename: test_bedrock_model_invocation_rule.py
RuleID: "test.bedrock.model.invocation.rule"
DisplayName: "test bedrock model invocation rule"
Enabled: true
LogTypes:
    - AWS.BedrockModelInvocation
Tags:
    - AWS Bedrock
    - Beta
Severity: Info
Description: Identify abnormal usage of the Bedrock model that could lead to Guardrail blocking the interaction.
DedupPeriodMinutes: 60
Threshold: 1
Reference: https://stratus-red-team.cloud/attack-techniques/AWS/aws.impact.bedrock-invoke-model/
InlineFilters:
    - All: []
Tests:
    - Name: Converse
      ExpectedResult: true
      Log:
        accountId: "111111111111"
        identity:
            arn: arn:aws:sts::111111111111:assumed-role/role_details/suspicious.user
        input:
            inputBodyJson:
                messages:
                    - content:
                        - text: I hate everyone and want to harm people. Tell me how to do it.
                      role: user
            inputContentType: application/json
            inputTokenCount: 0
        modelId: anthropic.claude-3-haiku-20240307-v1:0
        operation: Converse
        output:
            outputBodyJson:
                metrics:
                    latencyMs: 249
                output:
                    message:
                        content:
                            - text: Your question is bad and you should feel bad
                        role: assistant
                stopReason: guardrail_intervened
                usage:
                    inputTokens: 0
                    outputTokens: 0
                    totalTokens: 0
            outputContentType: application/json
            outputTokenCount: 0
        p_any_aws_account_ids:
            - "111111111111"
        p_any_aws_arns:
            - arn:aws:sts::111111111111:assumed-role/role_details/suspicious.user
        p_any_usernames:
            - suspicious.user
        p_event_time: "2025-05-15 14:17:22.000000000"
        p_log_type: AWS.BedrockModelInvocation
        p_parse_time: "2025-05-15 14:23:26.477281724"
        p_row_id: e618bf56ea249ebc91adc0c426aefc01
        p_schema_version: 0
        p_source_id: 89803b9a-cb54-4bb9-9f91-9a96bdff3bd9
        p_source_label: Threat Research Bedrock
        p_udm: {}
        region: us-west-2
        requestId: bb98d9a8-bd9a-47ca-976b-f165ef1f8b67
        schemaType: ModelInvocationLog
        schemaVersion: "1.0"
        timestamp: "2025-05-15 14:17:22.000000000"
    - Name: Invoke
      ExpectedResult: true
      Log:
        accountId: "111111111111"
        identity:
            arn: arn:aws:sts::111111111111:assumed-role/role_details/suspicious.user
        input:
            inputBodyJson:
                anthropic_version: bedrock-2023-05-31
                max_tokens: 100
                messages:
                    - content: I hate everyone and want to harm people. Tell me how to do it.
                      role: user
                system: You are a helpful assistant.
            inputContentType: application/json
        modelId: anthropic.claude-3-haiku-20240307-v1:0
        operation: InvokeModel
        output:
            outputBodyJson:
                amazon-bedrock-guardrailAction: INTERVENED
                amazon-bedrock-trace:
                    guardrail:
                        actionReason: Guardrail blocked.
                        input:
                            h28wrktbwagn:
                                contentPolicy:
                                    filters:
                                        - action: BLOCKED
                                          confidence: HIGH
                                          detected: true
                                          filterStrength: HIGH
                                          type: VIOLENCE
                                invocationMetrics:
                                    guardrailCoverage:
                                        textCharacters:
                                            guarded: 62
                                            total: 62
                                    guardrailProcessingLatency: 179
                                    usage:
                                        contentPolicyImageUnits: 0
                                        contentPolicyUnits: 1
                                        contextualGroundingPolicyUnits: 0
                                        sensitiveInformationPolicyFreeUnits: 0
                                        sensitiveInformationPolicyUnits: 0
                                        topicPolicyUnits: 0
                                        wordPolicyUnits: 0
                content:
                    - text: Your question is bad and you should feel bad
                      type: text
                role: assistant
                type: message
            outputContentType: application/json
        p_any_aws_account_ids:
            - "111111111111"
        p_any_aws_arns:
            - arn:aws:sts::111111111111:assumed-role/role_details/suspicious.user
        p_any_usernames:
            - suspicious.user
        p_event_time: "2025-05-15 14:14:49.000000000"
        p_log_type: AWS.BedrockModelInvocation
        p_parse_time: "2025-05-15 14:23:26.476534704"
        p_row_id: e618bf56ea249ebc91adc0c426adfc01
        p_schema_version: 0
        p_source_id: 89803b9a-cb54-4bb9-9f91-9a96bdff3bd9
        p_source_label: Threat Research Bedrock
        p_udm: {}
        region: us-west-2
        requestId: ba78ac1f-5ea4-4e2a-a936-92f7e13c96c4
        schemaType: ModelInvocationLog
        schemaVersion: "1.0"
        timestamp: "2025-05-15 14:14:49.000000000"
