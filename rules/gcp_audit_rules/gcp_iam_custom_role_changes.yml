AnalysisType: rule
DedupPeriodMinutes: 1440
Description: >-
  A custom role has been created, deleted, or updated.
DisplayName: "GCP IAM Role Has Changed"
Enabled: true
Filename: gcp_iam_custom_role_changes.py
LogTypes:
  - GCP.AuditLog
Reference: https://cloud.google.com/iam/docs/creating-custom-roles
Reports:
  CIS:
    - 2.6
  MITRE ATT&CK:
    - TA0004:T1078
RuleID: "GCP.IAM.CustomRoleChanges"
Runbook: >-
  No action needed, informational
Severity: Info
SummaryAttributes:
  - severity
  - p_any_ip_addresses
  - p_any_domain_names
Tags:
  - GCP
  - Identity & Access Management
  - Privilege Escalation:Valid Accounts
Tests:
  - ExpectedResult: true
    Log:
      "insertId": "y4nffme2rory"
      "logName": "projects/western-verve-123456/logs/cloudaudit.googleapis.com%2Factivity"
      "protoPayload":
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "user.name@runpanther.io"
          "principalSubject": "user:user.name@runpanther.io"
        "authorizationInfo":
          - "granted": true
            "permission": "iam.roles.create"
            "resource": "projects/western-verve-123456"
            "resourceAttributes": {}
        "methodName": "google.iam.admin.v1.CreateRole"
        "request":
          "@type": "type.googleapis.com/google.iam.admin.v1.CreateRoleRequest"
          "parent": "projects/western-verve-123456"
          "role":
            "description": "Created on: 2020-05-14"
            "included_permissions":
              - "apigee.apiproducts.create"
              - "apigee.apiproducts.delete"
              - "apigee.apiproducts.get"
            "stage": 1
            "title": "Jack's custom role"
          "role_id": "CustomRole"
        "requestMetadata":
          "callerIp": "136.24.229.58"
          "callerSuppliedUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4)
            AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36,gzip(gfe)"
          "destinationAttributes": {}
          "requestAttributes":
            "auth": {}
            "time": "2020-05-15T04:11:28.411897632Z"
        "resourceName": "projects/western-verve-123456/roles/CustomRole"
        "response":
          "@type": "type.googleapis.com/google.iam.admin.v1.Role"
          "description": "Created on: 2020-05-14"
          "etag": "BwWlqAHm9IY="
          "group_name": "custom"
          "group_title": "Custom"
          "included_permissions":
            - "apigee.apiproducts.create"
            - "apigee.apiproducts.delete"
            - "apigee.apiproducts.get"
          "name": "projects/western-verve-123456/roles/CustomRole"
          "stage": 1
          "title": "Jack's custom role"
        "serviceData":
          "@type": "type.googleapis.com/google.iam.admin.v1.AuditData"
          "permissionDelta":
            "addedPermissions":
              - "apigee.apiproducts.create"
              - "apigee.apiproducts.delete"
              - "apigee.apiproducts.get"
        "serviceName": "iam.googleapis.com"
        "status": {}
      "receiveTimestamp": "2020-05-15T04:11:29.472913078Z"
      "resource":
        "labels":
          "project_id": "western-verve-123456"
          "role_name": "projects/western-verve-123456/roles/CustomRole"
        "type": "iam_role"
      "severity": "NOTICE"
      "timestamp": "2020-05-15T04:11:28.224558457Z"
    Name: Custom Role Created
