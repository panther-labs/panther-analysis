AnalysisType: rule
DedupPeriodMinutes: 60
Description: >-
  Monitoring changes to Cloud Storage bucket permissions may reduce time to detect
  and correct permissions on sensitive Cloud Storage bucket and objects inside the
  bucket.
DisplayName: "GCP GCS IAM Permission Changes"
Enabled: true
Filename: gcp_gcs_iam_changes.py
LogTypes:
  - GCP.AuditLog
Reference: https://cloud.google.com/storage/docs/access-control/iam-permissions
Reports:
  CIS:
    - 2.1
  MITRE ATT&CK:
    - TA0009:T1530
RuleID: "GCP.GCS.IAMChanges"
Runbook: >-
  Validate the GCS bucket change was safe.
Severity: Low
SummaryAttributes:
  - severity
  - p_any_ip_addresses
  - p_any_domain_names
Tags:
  - GCP
  - Google Cloud Storage
  - Collection:Data From Cloud Storage Object
Tests:
  - ExpectedResult: true
    Log:
      "insertId": "15cp9rve72xt1"
      "logName": "projects/western-verve-123456/logs/cloudaudit.googleapis.com%2Factivity"
      "protoPayload":
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "user@runpanther.io"
        "authorizationInfo":
          - "granted": true
            "permission": "storage.buckets.setIamPolicy"
            "resource": "projects/_/buckets/jacks-test-bucket"
            "resourceAttributes": {}
        "methodName": "storage.setIamPermissions"
        "requestMetadata":
          "callerIp": "136.24.229.58"
          "callerSuppliedUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4)
            AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36,gzip(gfe)"
          "destinationAttributes": {}
          "requestAttributes":
            "auth": {}
            "time": "2020-05-15T04:28:42.243082428Z"
        "resourceLocation":
          "currentLocations":
            - "us"
        "resourceName": "projects/_/buckets/jacks-test-bucket"
        "serviceData":
          "@type": "type.googleapis.com/google.iam.v1.logging.AuditData"
          "policyDelta":
            "bindingDeltas":
              - "action": "ADD"
                "member": "allUsers"
                "role": "roles/storage.objectViewer"
        "serviceName": "storage.googleapis.com"
        "status": {}
      "receiveTimestamp": "2020-05-15T04:28:42.900626148Z"
      "resource":
        "labels":
          "bucket_name": "jacks-test-bucket"
          "location": "us"
          "project_id": "western-verve-123456"
        "type": "gcs_bucket"
      "severity": "NOTICE"
      "timestamp": "2020-05-15T04:28:42.237027213Z"
    Name: GCS IAM Change
