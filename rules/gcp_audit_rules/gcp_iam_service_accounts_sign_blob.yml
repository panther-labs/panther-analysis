AnalysisType: rule
Description: >-
  The iam.serviceAccounts.signBlob permission "allows signing of arbitrary payloads"
  in GCP. This means we can create a signed blob that requests an access token from
  the Service Account we are targeting.
DisplayName: "GCP IAM serviceAccounts signBlob"
Enabled: true
Filename: gcp_iam_service_accounts_sign_blob.py
LogTypes:
  - GCP.AuditLog
Reference: 
  https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/
Reports:
  MITRE ATT&CK:
    - TA0004:T1548
RuleID: "GCP.IAM.serviceAccounts.signBlob"
Severity: High
Tests:
  - ExpectedResult: true
    Log:
      "insertId": "1hu88qbef4d2o"
      "logName": "projects/some-project/logs/cloudaudit.googleapis.com%2Fdata_access"
      "protoPayload":
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "some-project@company.iam.gserviceaccount.com"
          "principalSubject": "serviceAccount:some-project@company.iam.gserviceaccount.com"
          "serviceAccountKeyName": "//iam.googleapis.com/projects/some-project/serviceAccounts/some-project@company.iam.gserviceaccount.com/keys/a378358365ff3d22e9c1a72fecf4605ddff76b47"
        "authorizationInfo":
          - "granted": true
            "permission": "iam.serviceAccounts.signBlob"
            "resourceAttributes": {}
        "methodName": "SignJwt"
        "request":
          "@type": "type.googleapis.com/google.iam.credentials.v1.SignJwtRequest"
          "name": "projects/-/serviceAccounts/some-project@company.iam.gserviceaccount.com"
        "requestMetadata":
          "callerIp": "1.2.3.4"
          "destinationAttributes": {}
          "requestAttributes":
            "auth": {}
            "time": "2024-02-26T17:15:16.327542536Z"
        "resourceName": "projects/-/serviceAccounts/114885146936855121342"
        "serviceName": "iamcredentials.googleapis.com"
        "status": {}
      "receiveTimestamp": "2024-02-26T17:15:17.100020459Z"
      "resource":
        "labels":
          "email_id": "some-project@company.iam.gserviceaccount.com"
          "project_id": "some-project"
          "unique_id": "114885146936855121342"
        "type": "service_account"
      "severity": "INFO"
      "timestamp": "2024-02-26T17:15:16.314854637Z"
    Name: iam.serviceAccounts.signBlob granted
  - ExpectedResult: false
    Log:
      "insertId": "1hu88qbef4d2o"
      "logName": "projects/some-project/logs/cloudaudit.googleapis.com%2Fdata_access"
      "protoPayload":
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "some-project@company.iam.gserviceaccount.com"
          "principalSubject": "serviceAccount:some-project@company.iam.gserviceaccount.com"
          "serviceAccountKeyName": "//iam.googleapis.com/projects/some-project/serviceAccounts/some-project@company.iam.gserviceaccount.com/keys/a378358365ff3d22e9c1a72fecf4605ddff76b47"
        "authorizationInfo":
          - "granted": false
            "permission": "iam.serviceAccounts.signBlob"
            "resourceAttributes": {}
        "methodName": "SignJwt"
        "request":
          "@type": "type.googleapis.com/google.iam.credentials.v1.SignJwtRequest"
          "name": "projects/-/serviceAccounts/some-project@company.iam.gserviceaccount.com"
        "requestMetadata":
          "callerIp": "1.2.3.4"
          "destinationAttributes": {}
          "requestAttributes":
            "auth": {}
            "time": "2024-02-26T17:15:16.327542536Z"
        "resourceName": "projects/-/serviceAccounts/114885146936855121342"
        "serviceName": "iamcredentials.googleapis.com"
        "status": {}
      "receiveTimestamp": "2024-02-26T17:15:17.100020459Z"
      "resource":
        "labels":
          "email_id": "some-project@company.iam.gserviceaccount.com"
          "project_id": "some-project"
          "unique_id": "114885146936855121342"
        "type": "service_account"
      "severity": "INFO"
      "timestamp": "2024-02-26T17:15:16.314854637Z"
    Name: iam.serviceAccounts.signBlob not granted
