AnalysisType: rule
Description: >-
  The Identity and Access Management (IAM) service manages authorization and authentication
  for a GCP environment. This means that there are very likely multiple privilege
  escalation methods that use the IAM service and/or its permissions.
DisplayName: "GCP IAM serviceAccounts getAccessToken Privilege Escalation"
Enabled: true
Filename: gcp_iam_service_accounts_get_access_token_privilege_escalation.py
LogTypes:
  - GCP.AuditLog
Reference: 
  https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/
Reports:
  MITRE ATT&CK:
    - TA0004:T1548
RuleID: "GCP.IAM.serviceAccounts.getAccessToken.Privilege.Escalation"
Severity: High
Tests:
  - ExpectedResult: true
    Log:
      "insertId": "1hu88qbef4d2o"
      "logName": "projects/some-project/logs/cloudaudit.googleapis.com%2Fdata_access"
      "p_log_type": "GCP.AuditLog"
      "protoPayload":
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "some-project@company.iam.gserviceaccount.com"
          "principalSubject": "serviceAccount:some-project@company.iam.gserviceaccount.com"
          "serviceAccountKeyName": "//iam.googleapis.com/projects/some-project/serviceAccounts/some-project@company.iam.gserviceaccount.com/keys/a378358365ff3d22e9c1a72fecf4605ddff76b47"
        "authorizationInfo":
          - "granted": true
            "permission": "iam.serviceAccounts.getAccessToken"
            "resourceAttributes": {}
        "methodName": "SignJwt"
        "request":
          "@type": "type.googleapis.com/google.iam.credentials.v1.SignJwtRequest"
          "name": "projects/-/serviceAccounts/some-project@company.iam.gserviceaccount.com"
        "requestMetadata":
          "callerIp": "1.2.3.4"
          "destinationAttributes": {}
          "requestAttributes":
            "auth": {}
            "time": "2024-02-26T17:15:16.327542536Z"
        "resourceName": "projects/-/serviceAccounts/114885146936855121342"
        "serviceName": "iamcredentials.googleapis.com"
        "status": {}
      "receiveTimestamp": "2024-02-26T17:15:17.100020459Z"
      "resource":
        "labels":
          "email_id": "some-project@company.iam.gserviceaccount.com"
          "project_id": "some-project"
          "unique_id": "114885146936855121342"
        "type": "service_account"
      "severity": "INFO"
      "timestamp": "2024-02-26T17:15:16.314854637Z"
    Name: iam.serviceAccounts.getAccessToken granted
  - ExpectedResult: false
    Log:
      "insertId": "1hu88qbef4d2o"
      "logName": "projects/some-project/logs/cloudaudit.googleapis.com%2Fdata_access"
      "p_log_type": "GCP.AuditLog"
      "protoPayload":
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "some-project@company.iam.gserviceaccount.com"
          "principalSubject": "serviceAccount:some-project@company.iam.gserviceaccount.com"
          "serviceAccountKeyName": "//iam.googleapis.com/projects/some-project/serviceAccounts/some-project@company.iam.gserviceaccount.com/keys/a378358365ff3d22e9c1a72fecf4605ddff76b47"
        "authorizationInfo":
          - "granted": false
            "permission": "iam.serviceAccounts.getAccessToken"
            "resourceAttributes": {}
        "methodName": "SignJwt"
        "request":
          "@type": "type.googleapis.com/google.iam.credentials.v1.SignJwtRequest"
          "name": "projects/-/serviceAccounts/some-project@company.iam.gserviceaccount.com"
        "requestMetadata":
          "callerIp": "1.2.3.4"
          "destinationAttributes": {}
          "requestAttributes":
            "auth": {}
            "time": "2024-02-26T17:15:16.327542536Z"
        "resourceName": "projects/-/serviceAccounts/114885146936855121342"
        "serviceName": "iamcredentials.googleapis.com"
        "status": {}
      "receiveTimestamp": "2024-02-26T17:15:17.100020459Z"
      "resource":
        "labels":
          "email_id": "some-project@company.iam.gserviceaccount.com"
          "project_id": "some-project"
          "unique_id": "114885146936855121342"
        "type": "service_account"
      "severity": "INFO"
      "timestamp": "2024-02-26T17:15:16.314854637Z"
    Name: iam.serviceAccounts.getAccessToken not granted
  - ExpectedResult: true
    Log:
      "insertId": "1dy9ihte4iyjz"
      "logName": "projects/mylogs/logs/cloudaudit.googleapis.com%2Fdata_access"
      "operation":
        "first": true
        "id": "10172500524907939495"
        "last": true
        "producer": "iamcredentials.googleapis.com"
      "p_log_type": "GCP.AuditLog"
      "protoPayload":
        "at_sign_type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalSubject": "example_principal_subject"
          "serviceAccountDelegationInfo":
            - {}
        "authorizationInfo":
          - "granted": true
            "permission": "iam.serviceAccounts.getAccessToken"
            "resourceAttributes": {}
        "metadata":
          "identityDelegationChain":
            - "projects/-/serviceAccounts/xxxxx.iam.gserviceaccount.com"
        "methodName": "GenerateAccessToken"
        "request":
          "@type": "type.googleapis.com/google.iam.credentials.v1.GenerateAccessTokenRequest"
          "name": "projects/-/serviceAccounts/xxxxx.iam.gserviceaccount.com"
        "requestMetadata":
          "callerIP": "gce-internal-ip"
          "callerSuppliedUserAgent": "google-api-go-client/0.5 gke-metadata-server,gzip(gfe)"
          "destinationAttributes": {}
          "requestAttributes":
            "auth": {}
            "time": "2024-08-29T19:30:36.353462175Z"
        "resourceName": "projects/-/serviceAccounts/11111222223333444455"
        "serviceName": "iamcredentials.googleapis.com"
        "status": {}
      "receiveTimestamp": "2024-08-29 19:30:36.424542070"
      "resource":
        "labels":
          "email_id": "sample@email.com"
          "project_id": "sample_project_id"
          "unique_id": "11111222223333444455"
        "type": "service_account"
      "severity": "INFO"
      "timestamp": "2024-08-29 19:30:36.339983306"
    Name: Principal Subject Used
