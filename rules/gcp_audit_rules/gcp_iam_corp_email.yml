AnalysisType: rule
DedupPeriodMinutes: 720
Description: >-
  Unexpected domain is being used instead of a corporate email
DisplayName: "GCP Corporate Email Not Used"
Enabled: true
Filename: gcp_iam_corp_email.py
LogTypes:
  - GCP.AuditLog
Reference: https://cloud.google.com/iam/docs/service-account-overview
Reports:
  CIS:
    - 1.1
  MITRE ATT&CK:
    - TA0003:T1136
RuleID: "GCP.IAM.CorporateEmail"
Runbook: >-
  Remove the user
Severity: Low
SummaryAttributes:
  - severity
  - p_any_ip_addresses
  - p_any_domain_names
Tags:
  - GCP
  - Identity & Access Management
  - Persistence:Create Account
Tests:
  - ExpectedResult: true
    Log:
      "insertId": "mrbji0dal80"
      "logName": "projects/western-verve-123456/logs/cloudaudit.googleapis.com%2Factivity"
      "protoPayload":
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "test@runpanther.com"
        "authorizationInfo":
          - "granted": true
            "permission": "resourcemanager.projects.setIamPolicy"
            "resource": "projects/western-verve-123456"
            "resourceAttributes": {}
          - "granted": true
            "permission": "resourcemanager.projects.setIamPolicy"
            "resource": "projects/western-verve-123456"
            "resourceAttributes": {}
        "methodName": "SetIamPolicy"
        "request":
          "@type": "type.googleapis.com/google.iam.v1.SetIamPolicyRequest"
          "policy":
            "bindings":
              - "members":
                  - "user:user-two@gmail.com"
                "role": "roles/appengine.serviceAdmin"
              - "members":
                  - "serviceAccount:service-951849100836@compute-system.iam.gserviceaccount.com"
                "role": "roles/compute.serviceAgent"
              - "members":
                  - "serviceAccount:951849100836-compute@developer.gserviceaccount.com"
                  - "serviceAccount:951849100836@cloudservices.gserviceaccount.com"
                "role": "roles/editor"
              - "members":
                  - "user:test@runpanther.com"
                "role": "roles/owner"
              - "members":
                  - "user:user-two@gmail.com"
                "role": "roles/pubsub.admin"
              - "members":
                  - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
                "role": "roles/pubsub.subscriber"
              - "members":
                  - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
                "role": "roles/pubsub.viewer"
              - "members":
                  - "user:test@runpanther.com"
                "role": "roles/resourcemanager.organizationAdmin"
              - "members":
                  - "user:username@gmail.com"
                "role": "roles/viewer"
            "etag": "BwWk8zJlg2o="
          "resource": "western-verve-123456"
        "requestMetadata":
          "callerIp": "136.24.229.58"
          "callerSuppliedUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4)
            AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36,gzip(gfe)"
          "destinationAttributes": {}
          "requestAttributes": {}
        "resourceName": "projects/western-verve-123456"
        "response":
          "@type": "type.googleapis.com/google.iam.v1.Policy"
          "bindings":
            - "members":
                - "user:user-two@gmail.com"
              "role": "roles/appengine.serviceAdmin"
            - "members":
                - "serviceAccount:service-951849100836@compute-system.iam.gserviceaccount.com"
              "role": "roles/compute.serviceAgent"
            - "members":
                - "serviceAccount:951849100836-compute@developer.gserviceaccount.com"
                - "serviceAccount:951849100836@cloudservices.gserviceaccount.com"
              "role": "roles/editor"
            - "members":
                - "user:test@runpanther.com"
              "role": "roles/owner"
            - "members":
                - "user:user-two@gmail.com"
              "role": "roles/pubsub.admin"
            - "members":
                - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
              "role": "roles/pubsub.subscriber"
            - "members":
                - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
              "role": "roles/pubsub.viewer"
            - "members":
                - "user:test@runpanther.com"
              "role": "roles/resourcemanager.organizationAdmin"
            - "members":
                - "user:username@gmail.com"
              "role": "roles/viewer"
          "etag": "BwWlp7rH6tY="
        "serviceData":
          "@type": "type.googleapis.com/google.iam.v1.logging.AuditData"
          "policyDelta":
            "bindingDeltas":
              - "action": "ADD"
                "member": "user:username@gmail.com"
                "role": "roles/viewer"
        "serviceName": "cloudresourcemanager.googleapis.com"
        "status": {}
      "receiveTimestamp": "2020-05-15T03:51:35.977314225Z"
      "resource":
        "labels":
          "project_id": "western-verve-123456"
        "type": "project"
      "severity": "NOTICE"
      "timestamp": "2020-05-15T03:51:35.019Z"
    Name: Gmail account added
  - ExpectedResult: false
    Log:
      "insertId": "mrbji0dal80"
      "logName": "projects/western-verve-123456/logs/cloudaudit.googleapis.com%2Factivity"
      "protoPayload":
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "test@runpanther.com"
        "authorizationInfo":
          - "granted": true
            "permission": "resourcemanager.projects.setIamPolicy"
            "resource": "projects/western-verve-123456"
            "resourceAttributes": {}
          - "granted": true
            "permission": "resourcemanager.projects.setIamPolicy"
            "resource": "projects/western-verve-123456"
            "resourceAttributes": {}
        "methodName": "SetIamPolicy"
        "request":
          "@type": "type.googleapis.com/google.iam.v1.SetIamPolicyRequest"
          "policy":
            "bindings":
              - "members":
                  - "user:user-two@gmail.com"
                "role": "roles/appengine.serviceAdmin"
              - "members":
                  - "serviceAccount:service-951849100836@compute-system.iam.gserviceaccount.com"
                "role": "roles/compute.serviceAgent"
              - "members":
                  - "serviceAccount:951849100836-compute@developer.gserviceaccount.com"
                  - "serviceAccount:951849100836@cloudservices.gserviceaccount.com"
                "role": "roles/editor"
              - "members":
                  - "user:test@runpanther.com"
                "role": "roles/owner"
              - "members":
                  - "user:user-two@gmail.com"
                "role": "roles/pubsub.admin"
              - "members":
                  - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
                "role": "roles/pubsub.subscriber"
              - "members":
                  - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
                "role": "roles/pubsub.viewer"
              - "members":
                  - "user:test@runpanther.com"
                "role": "roles/resourcemanager.organizationAdmin"
              - "members":
                  - "user:username@gmail.com"
                "role": "roles/viewer"
            "etag": "BwWk8zJlg2o="
          "resource": "western-verve-123456"
        "requestMetadata":
          "callerIp": "136.24.229.58"
          "callerSuppliedUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4)
            AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36,gzip(gfe)"
          "destinationAttributes": {}
          "requestAttributes": {}
        "resourceName": "projects/western-verve-123456"
        "response":
          "@type": "type.googleapis.com/google.iam.v1.Policy"
          "bindings":
            - "members":
                - "user:user-two@gmail.com"
              "role": "roles/appengine.serviceAdmin"
            - "members":
                - "serviceAccount:service-951849100836@compute-system.iam.gserviceaccount.com"
              "role": "roles/compute.serviceAgent"
            - "members":
                - "serviceAccount:951849100836-compute@developer.gserviceaccount.com"
                - "serviceAccount:951849100836@cloudservices.gserviceaccount.com"
              "role": "roles/editor"
            - "members":
                - "user:test@runpanther.com"
              "role": "roles/owner"
            - "members":
                - "user:user-two@gmail.com"
              "role": "roles/pubsub.admin"
            - "members":
                - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
              "role": "roles/pubsub.subscriber"
            - "members":
                - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
              "role": "roles/pubsub.viewer"
            - "members":
                - "user:test@runpanther.com"
              "role": "roles/resourcemanager.organizationAdmin"
            - "members":
                - "user:username@gmail.com"
              "role": "roles/viewer"
          "etag": "BwWlp7rH6tY="
        "serviceData":
          "@type": "type.googleapis.com/google.iam.v1.logging.AuditData"
          "policyDelta":
            "bindingDeltas":
              - "action": "ADD"
                "member": "user:username@runpanther.com"
                "role": "roles/viewer"
        "serviceName": "cloudresourcemanager.googleapis.com"
        "status": {}
      "receiveTimestamp": "2020-05-15T03:51:35.977314225Z"
      "resource":
        "labels":
          "project_id": "western-verve-123456"
        "type": "project"
      "severity": "NOTICE"
      "timestamp": "2020-05-15T03:51:35.019Z"
    Name: Expected account added
  - ExpectedResult: false
    Log:
      "insertId": "mrbji0dal80"
      "logName": "projects/western-verve-123456/logs/cloudaudit.googleapis.com%2Factivity"
      "protoPayload":
        "@type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "service-agent-manager@system.gserviceaccount.com"
        "authorizationInfo":
          - "granted": true
            "permission": "resourcemanager.projects.setIamPolicy"
            "resource": "projects/western-verve-123456"
            "resourceAttributes": {}
          - "granted": true
            "permission": "resourcemanager.projects.setIamPolicy"
            "resource": "projects/western-verve-123456"
            "resourceAttributes": {}
        "methodName": "SetIamPolicy"
        "request":
          "@type": "type.googleapis.com/google.iam.v1.SetIamPolicyRequest"
          "policy":
            "bindings":
              - "members":
                  - "user:user-two@gmail.com"
                "role": "roles/appengine.serviceAdmin"
              - "members":
                  - "serviceAccount:service-951849100836@compute-system.iam.gserviceaccount.com"
                "role": "roles/compute.serviceAgent"
              - "members":
                  - "serviceAccount:951849100836-compute@developer.gserviceaccount.com"
                  - "serviceAccount:951849100836@cloudservices.gserviceaccount.com"
                "role": "roles/editor"
              - "members":
                  - "user:test@runpanther.com"
                "role": "roles/owner"
              - "members":
                  - "user:user-two@gmail.com"
                "role": "roles/pubsub.admin"
              - "members":
                  - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
                "role": "roles/pubsub.subscriber"
              - "members":
                  - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
                "role": "roles/pubsub.viewer"
              - "members":
                  - "user:test@runpanther.com"
                "role": "roles/resourcemanager.organizationAdmin"
              - "members":
                  - "serviceAccount:service-951849100836@gcp-sa-logging.iam.gserviceaccount.com"
                "role": "roles/logging.ServiceAgent"
            "etag": "BwWk8zJlg2o="
          "resource": "western-verve-123456"
        "requestMetadata":
          "callerIp": "136.24.229.58"
          "callerSuppliedUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4)
            AppleWebKit/537.36 (KHTML, like Gecko) Chrome/81.0.4044.138 Safari/537.36,gzip(gfe)"
          "destinationAttributes": {}
          "requestAttributes": {}
        "resourceName": "projects/western-verve-123456"
        "response":
          "@type": "type.googleapis.com/google.iam.v1.Policy"
          "bindings":
            - "members":
                - "user:user-two@gmail.com"
              "role": "roles/appengine.serviceAdmin"
            - "members":
                - "serviceAccount:service-951849100836@compute-system.iam.gserviceaccount.com"
              "role": "roles/compute.serviceAgent"
            - "members":
                - "serviceAccount:951849100836-compute@developer.gserviceaccount.com"
                - "serviceAccount:951849100836@cloudservices.gserviceaccount.com"
              "role": "roles/editor"
            - "members":
                - "user:test@runpanther.com"
              "role": "roles/owner"
            - "members":
                - "user:user-two@gmail.com"
              "role": "roles/pubsub.admin"
            - "members":
                - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
              "role": "roles/pubsub.subscriber"
            - "members":
                - "serviceAccount:pubsub-reader@western-verve-123456.iam.gserviceaccount.com"
              "role": "roles/pubsub.viewer"
            - "members":
                - "user:test@runpanther.com"
              "role": "roles/resourcemanager.organizationAdmin"
            - "members":
                - "serviceAccount:service-951849100836@gcp-sa-logging.iam.gserviceaccount.com"
              "role": "roles/logging.ServiceAgent"
          "etag": "BwWlp7rH6tY="
        "serviceData":
          "@type": "type.googleapis.com/google.iam.v1.logging.AuditData"
          "policyDelta":
            "bindingDeltas":
              - "action": "ADD"
                "member": "serviceAccount:service-951849100836@gcp-sa-logging.iam.gserviceaccount.com"
                "role": "roles/logging.serviceAgent"
        "serviceName": "cloudresourcemanager.googleapis.com"
        "status": {}
      "receiveTimestamp": "2020-05-15T03:51:35.977314225Z"
      "resource":
        "labels":
          "project_id": "western-verve-123456"
        "type": "project"
      "severity": "NOTICE"
      "timestamp": "2020-05-15T03:51:35.019Z"
    Name: Expected GCP service account added by Service Agent Manager
