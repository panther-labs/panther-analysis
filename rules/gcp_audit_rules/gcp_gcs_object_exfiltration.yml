AnalysisType: rule
Filename: gcp_gcs_object_exfiltration.py
RuleID: "GCP.GCS.ObjectExfiltration"
DisplayName: "GCP GCS Object Copied to Different Bucket"
Enabled: true
Status: Experimental
Threshold: 10
LogTypes:
  - GCP.AuditLog
Tags:
  - GCP
  - Google Cloud Storage
  - Exfiltration:Transfer Data to Cloud Account
  - Ransomware
Reports:
  MITRE ATT&CK:
    - TA0010:T1537
Severity: Medium
Description: >
  Detects when GCS objects are copied from one bucket to another bucket. This pattern
  can indicate data exfiltration where an adversary copies sensitive data to a bucket
  they control. The threshold of 10+ copy operations suggests bulk exfiltration rather
  than normal operations. This is detected by monitoring storage.objects.get operations
  that include a destination field in the metadata, indicating a copy operation.
Runbook: |
  1. Review the alert details to identify the principal email, source bucket, destination bucket, total number of objects copied, and the timeframe of the bulk copy operations
  2. Query GCP Audit logs for all storage.objects.get operations with destination metadata by the principal email in the 1 hour window around this alert to build a complete picture of the exfiltration activity
  3. Identify the total number of objects copied, calculate the rate of copies per minute, and determine if the destination bucket is in the same project, a different project in the same organization, or an external project
  4. Review IAM permissions on both source and destination buckets to determine if the principal recently gained access or if permissions were modified to enable the copy operations
  5. Assess the sensitivity classification of the data in the source bucket and review the specific objects that were copied to determine potential data exposure impact
  6. Analyze the source IP address to verify if it matches the user's typical access patterns, geographic location, or is associated with known VPN/cloud providers that might indicate compromised credentials
  7. Look for other indicators of compromise from this principal in the past 24 hours including unusual API calls, permission changes, bucket policy modifications, or service account key creation
  8. If unauthorized exfiltration is confirmed: Immediately revoke the principal's access to GCS buckets, disable any service account keys, and reset user credentials
  9. Review the destination bucket to determine if data is still accessible there, coordinate with the project owner to delete copied data if it's in an attacker-controlled bucket, and document what data was exfiltrated
  10. Implement preventive controls including VPC Service Controls to restrict data exfiltration, enable Data Loss Prevention (DLP) scanning on sensitive buckets, and set up alerts for bulk copy operations exceeding normal thresholds
Reference: https://cloud.google.com/storage/docs/copying-renaming-moving-objects
SummaryAttributes:
  - severity
  - p_any_ip_addresses
  - p_any_emails
Tests:
  - Name: Cross-Project Object Copy
    ExpectedResult: true
    Log:
      {
        "protoPayload":
          {
            "at_sign_type": "type.googleapis.com/google.cloud.audit.AuditLog",
            "authenticationInfo":
              { "principalEmail": "denethor@lotr.com" },
            "authorizationInfo":
              [
                {
                  "granted": true,
                  "permission": "storage.objects.get",
                  "resource": "projects/_/buckets/source-bucket/objects/sensitive.txt",
                },
              ],
            "metadata":
              {
                "destination": "projects/attacker-project/buckets/exfil-bucket/objects/sensitive.txt",
                "requested_bytes": 12345,
              },
            "methodName": "storage.objects.get",
            "requestMetadata":
              {
                "callerIp": "1.2.3.4",
                "callerSuppliedUserAgent": "google-cloud-sdk gcloud/548.0.0 command/gcloud.storage.cp",
              },
            "resourceName": "projects/_/buckets/source-bucket/objects/sensitive.txt",
            "serviceName": "storage.googleapis.com",
            "status": {},
          },
        "resource":
          {
            "labels":
              {
                "bucket_name": "source-bucket",
                "location": "us",
                "project_id": "victim-project",
              },
            "type": "gcs_bucket",
          },
        "severity": "INFO",
        "timestamp": "2025-12-15 15:55:03.915792086",
      }
  - Name: Same-Project Different Bucket Copy
    ExpectedResult: true
    Log:
      {
        "protoPayload":
          {
            "at_sign_type": "type.googleapis.com/google.cloud.audit.AuditLog",
            "authenticationInfo":
              { "principalEmail": "denethor@lotr.com" },
            "metadata":
              {
                "destination": "projects/_/buckets/backup-bucket/objects/file.txt",
                "requested_bytes": 100,
              },
            "methodName": "storage.objects.get",
            "resourceName": "projects/_/buckets/prod-bucket/objects/file.txt",
            "serviceName": "storage.googleapis.com",
            "status": {},
          },
        "resource":
          {
            "labels":
              {
                "bucket_name": "prod-bucket",
                "project_id": "test-project",
              },
            "type": "gcs_bucket",
          },
        "severity": "INFO",
        "timestamp": "2025-12-15 15:55:03.915792086",
      }
  - Name: Object Get Without Copy Operation
    ExpectedResult: false
    Log:
      {
        "protoPayload":
          {
            "at_sign_type": "type.googleapis.com/google.cloud.audit.AuditLog",
            "authenticationInfo":
              { "principalEmail": "user@example.com" },
            "methodName": "storage.objects.get",
            "resourceName": "projects/_/buckets/test-bucket/objects/file.txt",
            "serviceName": "storage.googleapis.com",
            "status": {},
          },
        "resource":
          {
            "labels":
              {
                "bucket_name": "test-bucket",
                "project_id": "test-project",
              },
            "type": "gcs_bucket",
          },
        "severity": "INFO",
        "timestamp": "2025-12-15 15:55:03.915792086",
      }