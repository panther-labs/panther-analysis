AnalysisType: rule
Filename: proofpoint_virus_detected.py
RuleID: "Proofpoint.VirusDetected"
DisplayName: "Proofpoint Virus Detected"
Enabled: true
LogTypes:
  - Proofpoint.Event
Tags:
  - Proofpoint
  - Email Security
  - Virus
  - Experimental
Severity: High
Description: >
  This rule alerts when Proofpoint detects a virus in an email that could
  not be cleaned. It triggers when emails are quarantined to the Virus folder,
  have the notcleaned quarantine rule applied, or have a malware score of 95+.
Runbook: |
  1. Review the alert context for sender, recipients, and virus details
  2. Confirm the email was quarantined and not delivered
  3. Check for any other emails from the same sender
  4. Verify endpoint protection status on recipient systems
  5. Block the sender domain/IP at the email gateway
  6. Report to security team for further investigation
Reference: https://help.proofpoint.com/Threat_Insight_Dashboard/API_Documentation/SIEM_API
Tests:
  - Name: Virus Quarantine Folder
    ExpectedResult: true
    Log:
      messageTime: "2026-01-08T12:30:00Z"
      sender: "infected@example.com"
      senderIP: "192.0.2.50"
      fromAddress:
        - "infected@example.com"
      toAddresses:
        - "employee@company.com"
      recipient:
        - "employee@company.com"
      subject: "Document for Review"
      malwareScore: 100
      phishScore: 0
      spamScore: 0
      impostorScore: 0
      quarantineFolder: "Virus"
      quarantineRule: "notcleaned"
      messageID: "<virus123@example.com>"
      messageSize: 150000
      modulesRun:
        - av
        - spam
      threatsInfoMap:
        - threatType: "attachment"
          classification: "malware"
          threatStatus: "active"
          threat: "document.doc"
          threatID: "abc123def456"
  - Name: Not Cleaned Quarantine Rule
    ExpectedResult: true
    Log:
      messageTime: "2026-01-08T14:00:00Z"
      sender: "virus@malware.net"
      senderIP: "198.51.100.100"
      fromAddress:
        - "virus@malware.net"
      toAddresses:
        - "user@company.com"
      recipient:
        - "user@company.com"
      subject: "Important Update"
      malwareScore: 85
      phishScore: 5
      spamScore: 10
      impostorScore: 0
      quarantineFolder: "Virus"
      quarantineRule: "notcleaned"
      messageID: "<virus789@malware.net>"
      threatsInfoMap:
        - threatType: "attachment"
          classification: "malware"
          threatStatus: "active"
          threat: "update.exe"
  - Name: Clean Email - No Alert
    ExpectedResult: false
    Log:
      messageTime: "2026-01-08T15:00:00Z"
      sender: "colleague@company.com"
      senderIP: "203.0.113.10"
      fromAddress:
        - "colleague@company.com"
      toAddresses:
        - "user@company.com"
      recipient:
        - "user@company.com"
      subject: "Weekly Report"
      malwareScore: 0
      phishScore: 0
      spamScore: 0
      impostorScore: 0
      messageID: "<clean123@company.com>"
  - Name: Different Quarantine Type - No Alert
    ExpectedResult: false
    Log:
      messageTime: "2026-01-08T16:00:00Z"
      sender: "phisher@example.com"
      senderIP: "198.51.100.200"
      fromAddress:
        - "phisher@example.com"
      toAddresses:
        - "victim@company.com"
      recipient:
        - "victim@company.com"
      subject: "Verify Your Account"
      malwareScore: 0
      phishScore: 95
      spamScore: 10
      impostorScore: 0
      quarantineFolder: "Phish"
      quarantineRule: "phish"
      messageID: "<phish456@example.com>"
