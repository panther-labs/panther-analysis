AnalysisType: rule
Filename: proofpoint_malware_detected.py
RuleID: "Proofpoint.MalwareDetected"
DisplayName: "Proofpoint Malware Detected"
Enabled: true
LogTypes:
  - Proofpoint.Event
Tags:
  - Proofpoint
  - Email Security
  - Malware
  - Experimental
Severity: High
Description: >
  This rule alerts when Proofpoint detects malware in an email message.
  It triggers when emails are quarantined with the malware rule or when
  the malware score is 85 or higher.
Runbook: |
  1. Review the alert context for sender, recipients, and threat details
  2. Check if the email was successfully quarantined
  3. Verify if any recipients clicked on malicious links or downloaded attachments
  4. Block the sender domain/IP if necessary
  5. Notify affected users and provide security awareness training
Reference: https://help.proofpoint.com/Threat_Insight_Dashboard/API_Documentation/SIEM_API
Tests:
  - Name: Malware Quarantine Rule Match
    ExpectedResult: true
    Log:
      messageTime: "2026-01-08T23:57:06Z"
      sender: "malicious@example.com"
      senderIP: "192.0.2.1"
      fromAddress:
        - "malicious@example.com"
      toAddresses:
        - "victim@company.com"
      recipient:
        - "victim@company.com"
      subject: "Invoice Attached"
      malwareScore: 100
      phishScore: 0
      spamScore: 0
      impostorScore: 0
      quarantineFolder: "Malware"
      quarantineRule: "malware"
      messageID: "<20021004025021.15821.qmail@example.com>"
      messageSize: 202302
      modulesRun:
        - av
        - sandbox
        - spam
        - dmarc
      threatsInfoMap:
        - threatType: "attachment"
          classification: "malware"
          threatStatus: "active"
          threat: "invoice.exe"
          threatID: "9be9e4c4cc2679586acb2511b3ae0505be51c07d32e1071bc4bb95cfe3383b9f"
  - Name: High Malware Score
    ExpectedResult: true
    Log:
      messageTime: "2026-01-08T23:57:06Z"
      sender: "suspicious@example.com"
      senderIP: "198.51.100.1"
      fromAddress:
        - "suspicious@example.com"
      toAddresses:
        - "user@company.com"
      recipient:
        - "user@company.com"
      subject: "Urgent: Update Required"
      malwareScore: 95
      phishScore: 10
      spamScore: 20
      impostorScore: 0
      quarantineFolder: "Attachment Defense"
      quarantineRule: "threat"
      messageID: "<abc123@example.com>"
      threatsInfoMap:
        - threatType: "attachment"
          classification: "malware"
          threatStatus: "active"
          threat: "update.zip"
  - Name: Low Malware Score - No Alert
    ExpectedResult: false
    Log:
      messageTime: "2026-01-08T23:57:06Z"
      sender: "legitimate@company.com"
      senderIP: "203.0.113.1"
      fromAddress:
        - "legitimate@company.com"
      toAddresses:
        - "employee@company.com"
      recipient:
        - "employee@company.com"
      subject: "Meeting Notes"
      malwareScore: 0
      phishScore: 0
      spamScore: 5
      impostorScore: 0
      messageID: "<normal123@company.com>"
  - Name: Different Quarantine Rule - No Alert
    ExpectedResult: false
    Log:
      messageTime: "2026-01-08T23:57:06Z"
      sender: "spam@example.com"
      senderIP: "198.51.100.50"
      fromAddress:
        - "spam@example.com"
      toAddresses:
        - "user@company.com"
      recipient:
        - "user@company.com"
      subject: "Buy Now!"
      malwareScore: 0
      phishScore: 0
      spamScore: 95
      impostorScore: 0
      quarantineFolder: "Definite Spam"
      quarantineRule: "spam_definite"
      messageID: "<spam456@example.com>"
