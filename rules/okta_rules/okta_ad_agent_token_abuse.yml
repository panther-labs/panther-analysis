AnalysisType: rule
Filename: okta_ad_agent_token_abuse.py
RuleID: "Okta.ADAgent.TokenAbuse"
DisplayName: "Okta AD Agent Token Theft and Abuse"
Enabled: true
Status: Experimental
LogTypes:
  - Okta.SystemLog
Tags:
  - Identity & Access Management
  - Okta
  - Active Directory
  - Credential Access:Steal Application Access Token
  - Persistence:Account Manipulation
Reports:
  MITRE ATT&CK:
    - TA0006:T1528  # Steal Application Access Token
    - TA0003:T1098  # Account Manipulation
Severity: Medium
Description: >
  Detects potential Okta AD Agent token theft and abuse. The "Secret Agent" attack
  involves stealing the SSWS token from an Okta AD Agent to register a malicious
  agent and intercept authentication requests. This detection identifies suspicious
  AD agent-related activities including new agent registrations, configuration changes,
  and unusual API token usage from service accounts.
Reference: https://www.varonis.com/blog/okta-attack-vectors
Runbook: |
  1. Verify if the AD agent activity was authorized
  2. Check if new AD agents were registered recently in the Okta admin console
  3. Review the source IP address and geolocation of the activity
  4. If unauthorized, immediately revoke the compromised agent token
  5. Investigate any authentication events that occurred through the suspicious agent
  6. Reset credentials for any users that may have authenticated through the rogue agent
  7. Review audit logs for any other suspicious AD agent activity
DedupPeriodMinutes: 60
SummaryAttributes:
  - eventType
  - severity
  - displayMessage
  - p_any_ip_addresses
Tests:
  - Name: AD Agent Configuration Change
    ExpectedResult: false
    Log:
      {
        "uuid": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
        "published": "2024-01-15 14:23:45.123",
        "eventType": "system.agent.ad.config_change_detected",
        "version": "0",
        "severity": "WARN",
        "legacyEventType": "agent.ad.config.change.detected",
        "displayMessage": "AD agent configuration changed",
        "actor":
          {
            "alternateId": "admin@company.com",
            "displayName": "Admin User",
            "id": "00u123456789abcdef",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
            "geographicalContext":
              {
                "city": "San Francisco",
                "country": "United States",
                "state": "California",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa123456789abcdef",
              "type": "AppInstance",
              "alternateId": "AD Agent",
              "displayName": "Active Directory Agent",
            },
          ],
        "transaction": { "id": "txn123456789", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: New AD Agent Instance Added
    ExpectedResult: false
    Log:
      {
        "uuid": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
        "published": "2024-01-15 15:30:22.456",
        "eventType": "system.agent.ad.agent_instance_added",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "New AD agent instance registered",
        "actor":
          {
            "alternateId": "svc-oktasync@company.com",
            "displayName": "Okta Sync Service",
            "id": "00u987654321fedcba",
            "type": "User",
          },
        "client":
          {
            "device": "Unknown",
            "ipAddress": "10.0.0.50",
            "userAgent": { "rawUserAgent": "okta-agent/1.2.3" },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa987654321fedcba",
              "type": "Agent",
              "alternateId": "unknown",
              "displayName": "AD-AGENT-01",
            },
          ],
        "transaction": { "id": "txn987654321", "type": "JOB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Failed AD Agent Authentication
    ExpectedResult: true
    Log:
      {
        "uuid": "c3d4e5f6-a7b8-9012-cdef-123456789012",
        "published": "2024-01-15 16:45:33.789",
        "eventType": "system.agent.ad.bad_credentials",
        "version": "0",
        "severity": "WARN",
        "displayMessage": "AD agent authentication failed due to bad credentials",
        "actor":
          {
            "alternateId": "ad-agent-svc@company.local",
            "displayName": "AD Agent Service Account",
            "id": "00u111222333444555",
            "type": "User",
          },
        "client":
          {
            "device": "Unknown",
            "ipAddress": "172.16.0.10",
            "userAgent": { "rawUserAgent": "okta-ad-agent/2.1.0" },
          },
        "outcome": { "result": "FAILURE", "reason": "INVALID_CREDENTIALS" },
        "target":
          [
            {
              "id": "0oa111222333444555",
              "type": "AppInstance",
              "alternateId": "Active Directory",
              "displayName": "AD Integration",
            },
          ],
        "transaction": { "id": "txn111222333", "type": "JOB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Service Account Creates API Token
    ExpectedResult: true
    Log:
      {
        "uuid": "d4e5f6a7-b8c9-0123-def1-234567890123",
        "published": "2024-01-15 17:15:10.234",
        "eventType": "system.api_token.create",
        "version": "0",
        "severity": "INFO",
        "legacyEventType": "api.token.create",
        "displayMessage": "Create API token",
        "actor":
          {
            "alternateId": "svc-ad-sync@company.com",
            "displayName": "AD Sync Service Account",
            "id": "00u222333444555666",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "203.0.113.45",
            "userAgent":
              {
                "browser": "UNKNOWN",
                "os": "Unknown",
                "rawUserAgent": "python-requests/2.28.0",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "00T222333444555666",
              "type": "Token",
              "alternateId": "unknown",
              "displayName": "ad-agent-token",
              "details": null,
            },
          ],
        "transaction": { "id": "txn222333444", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Normal User Login - Should Not Alert
    ExpectedResult: false
    Log:
      {
        "uuid": "e5f6a7b8-c9d0-1234-ef12-345678901234",
        "published": "2024-01-15 18:00:00.000",
        "eventType": "user.session.start",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "User login to Okta",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Normal User",
            "id": "00u333444555666777",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.50",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)",
              },
            "geographicalContext":
              {
                "city": "San Francisco",
                "country": "United States",
                "state": "California",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "transaction": { "id": "txn333444555", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Normal API Token Creation by Regular User
    ExpectedResult: false
    Log:
      {
        "uuid": "f6a7b8c9-d0e1-2345-f123-456789012345",
        "published": "2024-01-15 19:30:15.567",
        "eventType": "system.api_token.create",
        "version": "0",
        "severity": "INFO",
        "legacyEventType": "api.token.create",
        "displayMessage": "Create API token",
        "actor":
          {
            "alternateId": "developer@company.com",
            "displayName": "Developer User",
            "id": "00u444555666777888",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.75",
            "userAgent":
              {
                "browser": "FIREFOX",
                "os": "Linux",
                "rawUserAgent": "Mozilla/5.0 (X11; Linux x86_64; rv:109.0)",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "00T444555666777888",
              "type": "Token",
              "alternateId": "unknown",
              "displayName": "dev-api-key",
              "details": null,
            },
          ],
        "transaction": { "id": "txn444555666", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }
