AnalysisType: rule
DedupPeriodMinutes: 60
Description: >-
  New Behaviors Observed while Accessing Okta Admin Console. A user attempted to access
  the Okta Admin Console from a new device with a new IP.
DisplayName: "Okta New Behaviors Acessing Admin Console"
Enabled: true
Filename: okta_new_behavior_accessing_admin_console.py
LogTypes:
  - Okta.SystemLog
Reference: 
  https://sec.okta.com/articles/2023/08/cross-tenant-impersonation-prevention-and-detection
Reports:
  MITRE ATT&CK:
    - TA0001:T1078.004
RuleID: "Okta.New.Behavior.Accessing.Admin.Console"
Runbook: >-
  Configure Authentication Policies (Application Sign-on Policies) for access to privileged
  applications, including the Admin Console, to require re-authentication “at every
  sign-in”. Turn on and test New Device and Suspicious Activity end-user notifications.
Severity: High
Tests:
  - ExpectedResult: true
    Log:
      "actor":
        "alternateId": "homer.simpson@duff.com"
        "displayName": "Homer Simpson"
        "id": "00abc123"
        "type": "User"
      "authenticationcontext":
        "authenticationStep": 0
        "externalSessionId": "100-abc-9999"
      "client":
        "device": "Computer"
        "geographicalContext":
          "city": "Springfield"
          "country": "United States"
          "geolocation":
            "lat": 20
            "lon": -25
          "postalCode": "12345"
          "state": "Ohio"
        "ipAddress": "1.3.2.4"
        "userAgent":
          "browser": "CHROME"
          "like Gecko) Chrome/102.0.0.0 Safari/537.36":
          "os": "Mac OS X"
          "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
            (KHTML"
        "zone": "null"
      "debugcontext":
        "debugData":
          "behaviors":
            - "New Geo-Location=NEGATIVE"
            - "New Device=POSITIVE"
            - "New IP=POSITIVE"
            - "New State=NEGATIVE"
            - "New Country=NEGATIVE"
            - "Velocity=NEGATIVE"
            - "New City=NEGATIVE"
          "requestId": "AbCdEf12G"
          "requestUri": "/api/v1/users/AbCdEfG/lifecycle/reset_factors"
          "url": "/api/v1/users/AbCdEfG/lifecycle/reset_factors?"
      "device":
        "name": "Evil Computer"
      "displaymessage": "Evaluation of sign-on policy"
      "eventtype": "policy.evaluate_sign_on"
      "outcome":
        "reason": "Sign-on policy evaluation resulted in CHALLENGE"
        "result": "CHALLENGE"
      "published": "2022-06-22 18:18:29.015"
      "request":
        "ipChain":
          - "geographicalContext":
              "city": "Springfield"
              "country": "United States"
              "geolocation":
                "lat": 20
                "lon": -25
              "ip": "1.3.2.4"
              "postalCode": "12345"
              "state": "Ohio"
              "version": "V4"
      "securitycontext":
        "asNumber": 701
        "asOrg": "verizon"
        "domain": "verizon.net"
        "isProxy": false
        "isp": "verizon"
      "severity": "INFO"
      "target":
        - "alternateId": "Okta Admin Console"
          "displayName": "Okta Admin Console"
          "type": "AppInstance"
        - "alternateId": "peter.griffin@company.com"
          "displayName": "Peter Griffin"
          "id": "0002222AAAA"
          "type": "User"
      "transaction":
        "detail": {}
        "id": "ABcDeFgG"
        "type": "WEB"
      "uuid": "AbC-123-XyZ"
      "version": "0"
    Name: New Behavior Accessing Admin Console (behavior)
  - ExpectedResult: true
    Log:
      "actor":
        "alternateId": "homer.simpson@duff.com"
        "displayName": "Homer Simpson"
        "id": "00abc123"
        "type": "User"
      "authenticationcontext":
        "authenticationStep": 0
        "externalSessionId": "100-abc-9999"
      "client":
        "device": "Computer"
        "geographicalContext":
          "city": "Springfield"
          "country": "United States"
          "geolocation":
            "lat": 20
            "lon": -25
          "postalCode": "12345"
          "state": "Ohio"
        "ipAddress": "1.3.2.4"
        "userAgent":
          "browser": "CHROME"
          "like Gecko) Chrome/102.0.0.0 Safari/537.36":
          "os": "Mac OS X"
          "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
            (KHTML"
        "zone": "null"
      "debugcontext":
        "debugData":
          "logOnlySecurityData":
            "behaviors":
              "New City": "NEGATIVE"
              "New Country": "NEGATIVE"
              "New Device": "POSITIVE"
              "New Geo-Location": "NEGATIVE"
              "New IP": "POSITIVE"
              "New State": "NEGATIVE"
              "Velocity": "NEGATIVE"
            "risk":
              "level": "LOW"
          "requestId": "AbCdEf12G"
          "requestUri": "/api/v1/users/AbCdEfG/lifecycle/reset_factors"
          "url": "/api/v1/users/AbCdEfG/lifecycle/reset_factors?"
      "device":
        "name": "Evil Computer"
      "displaymessage": "Evaluation of sign-on policy"
      "eventtype": "policy.evaluate_sign_on"
      "outcome":
        "reason": "Sign-on policy evaluation resulted in CHALLENGE"
        "result": "CHALLENGE"
      "published": "2022-06-22 18:18:29.015"
      "request":
        "ipChain":
          - "geographicalContext":
              "city": "Springfield"
              "country": "United States"
              "geolocation":
                "lat": 20
                "lon": -25
              "ip": "1.3.2.4"
              "postalCode": "12345"
              "state": "Ohio"
              "version": "V4"
      "securitycontext":
        "asNumber": 701
        "asOrg": "verizon"
        "domain": "verizon.net"
        "isProxy": false
        "isp": "verizon"
      "severity": "INFO"
      "target":
        - "alternateId": "Okta Admin Console"
          "displayName": "Okta Admin Console"
          "type": "AppInstance"
        - "alternateId": "peter.griffin@company.com"
          "displayName": "Peter Griffin"
          "id": "0002222AAAA"
          "type": "User"
      "transaction":
        "detail": {}
        "id": "ABcDeFgG"
        "type": "WEB"
      "uuid": "AbC-123-XyZ"
      "version": "0"
    Name: New Behavior Accessing Admin Console (logSecurityDataOnly)
  - ExpectedResult: false
    Log:
      "actor":
        "alternateId": "homer.simpson@duff.com"
        "displayName": "Homer Simpson"
        "id": "00abc123"
        "type": "User"
      "authenticationcontext":
        "authenticationStep": 0
        "externalSessionId": "100-abc-9999"
      "client":
        "device": "Computer"
        "geographicalContext":
          "city": "Springfield"
          "country": "United States"
          "geolocation":
            "lat": 20
            "lon": -25
          "postalCode": "12345"
          "state": "Ohio"
        "ipAddress": "1.3.2.4"
        "userAgent":
          "browser": "CHROME"
          "like Gecko) Chrome/102.0.0.0 Safari/537.36":
          "os": "Mac OS X"
          "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
            (KHTML"
        "zone": "null"
      "debugcontext":
        "debugData":
          "logOnlySecurityData":
            "behaviors":
              "New City": "NEGATIVE"
              "New Country": "NEGATIVE"
              "New Device": "NEGATIVE"
              "New Geo-Location": "NEGATIVE"
              "New IP": "NEGATIVE"
              "New State": "NEGATIVE"
              "Velocity": "NEGATIVE"
            "risk":
              "level": "LOW"
          "requestId": "AbCdEf12G"
          "requestUri": "/api/v1/users/AbCdEfG/lifecycle/reset_factors"
          "url": "/api/v1/users/AbCdEfG/lifecycle/reset_factors?"
      "displaymessage": "Evaluation of sign-on policy"
      "eventtype": "policy.evaluate_sign_on"
      "outcome":
        "reason": "Sign-on policy evaluation resulted in CHALLENGE"
        "result": "CHALLENGE"
      "published": "2022-06-22 18:18:29.015"
      "request":
        "ipChain":
          - "geographicalContext":
              "city": "Springfield"
              "country": "United States"
              "geolocation":
                "lat": 20
                "lon": -25
              "ip": "1.3.2.4"
              "postalCode": "12345"
              "state": "Ohio"
              "version": "V4"
      "securitycontext":
        "asNumber": 701
        "asOrg": "verizon"
        "domain": "verizon.net"
        "isProxy": false
        "isp": "verizon"
      "severity": "INFO"
      "target":
        - "alternateId": "Okta Admin Console"
          "displayName": "Okta Admin Console"
          "type": "AppInstance"
        - "alternateId": "peter.griffin@company.com"
          "displayName": "Peter Griffin"
          "id": "0002222AAAA"
          "type": "User"
      "transaction":
        "detail": {}
        "id": "ABcDeFgG"
        "type": "WEB"
      "uuid": "AbC-123-XyZ"
      "version": "0"
    Name: Not New Behavior
  - ExpectedResult: true
    Log:
      "actor":
        "alternateId": "homer.simpson@duff.com"
        "displayName": "Homer Simpson"
        "id": "00abc123"
        "type": "User"
      "authenticationcontext":
        "authenticationStep": 0
        "externalSessionId": "100-abc-9999"
      "client":
        "device": "Computer"
        "geographicalContext":
          "city": "Springfield"
          "country": "United States"
          "geolocation":
            "lat": 20
            "lon": -25
          "postalCode": "12345"
          "state": "Ohio"
        "ipAddress": "1.3.2.4"
        "userAgent":
          "browser": "CHROME"
          "like Gecko) Chrome/102.0.0.0 Safari/537.36":
          "os": "Mac OS X"
          "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36
            (KHTML"
        "zone": "null"
      "debugcontext":
        "debugData":
          "logOnlySecurityData": "{\"risk\":{\"level\":\"LOW\"},\"behaviors\":{\"
            New Geo-Location\":\"NEGATIVE\",\"New Device\":\"POSITIVE\",\"New IP\"\
            :\"POSITIVE\",\"New State\":\"NEGATIVE\",\"New Country\":\"NEGATIVE\"\
            ,\"Velocity\":\"NEGATIVE\",\"New City\":\"NEGATIVE\"}}"
          "requestId": "AbCdEf12G"
          "requestUri": "/api/v1/users/AbCdEfG/lifecycle/reset_factors"
          "url": "/api/v1/users/AbCdEfG/lifecycle/reset_factors?"
      "device":
        "name": "Evil Computer"
      "displaymessage": "Evaluation of sign-on policy"
      "eventtype": "policy.evaluate_sign_on"
      "outcome":
        "reason": "Sign-on policy evaluation resulted in CHALLENGE"
        "result": "CHALLENGE"
      "published": "2022-06-22 18:18:29.015"
      "request":
        "ipChain":
          - "geographicalContext":
              "city": "Springfield"
              "country": "United States"
              "geolocation":
                "lat": 20
                "lon": -25
              "ip": "1.3.2.4"
              "postalCode": "12345"
              "state": "Ohio"
              "version": "V4"
      "securitycontext":
        "asNumber": 701
        "asOrg": "verizon"
        "domain": "verizon.net"
        "isProxy": false
        "isp": "verizon"
      "severity": "INFO"
      "target":
        - "alternateId": "Okta Admin Console"
          "displayName": "Okta Admin Console"
          "type": "AppInstance"
        - "alternateId": "peter.griffin@company.com"
          "displayName": "Peter Griffin"
          "id": "0002222AAAA"
          "type": "User"
      "transaction":
        "detail": {}
        "id": "ABcDeFgG"
        "type": "WEB"
      "uuid": "AbC-123-XyZ"
      "version": "0"
    Name: New Behavior Accessing Admin Console (logSecurityDataOnly) - not jsonified
      string
Threshold: 1
