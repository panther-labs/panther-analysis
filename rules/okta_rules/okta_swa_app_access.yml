AnalysisType: rule
Filename: okta_swa_app_access.py
RuleID: "Okta.SWA.App.Access"
DisplayName: "Okta SWA Application Access"
Enabled: true
Status: Experimental
LogTypes:
  - Okta.SystemLog
Tags:
  - Identity & Access Management
  - Okta
  - Credential Access
Reports:
  MITRE ATT&CK:
    - TA0006:T1555  # Credentials from Password Stores
Severity: Info
Description: |
  Detects successful sign-on policy evaluations for Okta applications. This rule serves
  as a base detection for correlation analysis to identify bulk SWA credential extraction
  attempts. Individual accesses are expected behavior and logged for correlation purposes.
Reference: https://help.okta.com/en-us/content/topics/apps/apps-about-swa.htm
Runbook: |
  This is an informational rule used for correlation analysis. Individual app accesses
  are normal behavior. Investigate only if correlated with bulk access patterns.
DedupPeriodMinutes: 1
SummaryAttributes:
  - eventType
  - p_any_ip_addresses
Tests:
  - Name: Successful Sign-On Policy Evaluation
    ExpectedResult: true
    Log:
      {
        "uuid": "a1b2c3d4-e5f6-7890-abcd-1234567890ab",
        "published": "2024-10-15 14:30:45.123",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "legacyEventType": "core.policy.evaluate_sign_on",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Test User",
            "id": "00u123456789abcdef",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
            "geographicalContext":
              {
                "city": "San Francisco",
                "country": "United States",
                "state": "California",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "BROWSER_PLUGIN",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa123456789abcdef",
              "type": "AppInstance",
              "alternateId": "Salesforce",
              "displayName": "Salesforce Production",
            },
          ],
        "transaction": { "id": "txn123456789", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Failed Sign-On Policy Evaluation
    ExpectedResult: false
    Log:
      {
        "uuid": "b2c3d4e5-f6a7-8901-bcde-2345678901bc",
        "published": "2024-10-15 15:45:22.456",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "WARN",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Test User",
            "id": "00u234567890bcdefg",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.0.2.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "outcome": { "result": "FAILURE", "reason": "Policy denied access" },
        "target":
          [
            {
              "id": "0oa234567890bcdefg",
              "type": "AppInstance",
              "alternateId": "AWS",
              "displayName": "Amazon Web Services",
            },
          ],
        "transaction": { "id": "txn234567890", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Different Event Type
    ExpectedResult: false
    Log:
      {
        "uuid": "c3d4e5f6-a7b8-9012-cdef-3456789012cd",
        "published": "2024-10-15 16:20:33.789",
        "eventType": "user.session.start",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "User login to Okta",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "User",
            "id": "00u345678901cdefgh",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.50",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "transaction": { "id": "txn345678901", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }
