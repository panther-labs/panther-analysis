AnalysisType: rule
Filename: okta_swa_app_access.py
RuleID: "Okta.SWA.App.Access"
DisplayName: "Okta SWA Bulk Credential Extraction"
Enabled: true
Status: Experimental
LogTypes:
  - Okta.SystemLog
Tags:
  - Identity & Access Management
  - Okta
  - SWA
  - Credential Access:Credentials from Password Stores
  - Bulk Activity
Reports:
  MITRE ATT&CK:
    - TA0006:T1555  # Credentials from Password Stores
Severity: High
Description: |
  Detects potential bulk SWA (Secure Web Authentication) credential extraction attempts
  in Okta. When a user or attacker accesses 6 or more SWA applications within a 10-minute
  window, this may indicate automated credential harvesting. SWA apps store credentials in
  Okta's encrypted vault, and bulk access patterns suggest an attempt to extract multiple
  application credentials rapidly.
Reference: https://www.spera.security/resources/okta-swa-configuration-understanding-the-concept-and-different-configurations
Runbook: |
  1. Verify if the bulk application access was legitimate user behavior
  2. Review the list of accessed applications for sensitive targets
  3. Check the source IP address and geolocation for anomalies
  4. Investigate the user's recent authentication history for signs of compromise
  5. Review user-agent strings for automation tools (scripts, bots)
  6. If unauthorized, immediately suspend the user account and revoke active sessions
  7. Force password reset and MFA re-enrollment for the affected user
  8. Audit all SWA application credentials accessed during the window
  9. Check for any credential usage in the target applications
  10. Review Okta admin audit logs for any policy or configuration changes
Threshold: 6
DedupPeriodMinutes: 10
SummaryAttributes:
  - actor.alternateId
  - p_any_ip_addresses
Tests:
  - Name: Successful Sign-On Policy Evaluation
    ExpectedResult: true
    Log:
      {
        "uuid": "a1b2c3d4-e5f6-7890-abcd-1234567890ab",
        "published": "2024-10-15 14:30:45.123",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "legacyEventType": "core.policy.evaluate_sign_on",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Test User",
            "id": "00u123456789abcdef",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
            "geographicalContext":
              {
                "city": "San Francisco",
                "country": "United States",
                "state": "California",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "BROWSER_PLUGIN",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa123456789abcdef",
              "type": "AppInstance",
              "alternateId": "Salesforce",
              "displayName": "Salesforce Production",
            },
          ],
        "transaction": { "id": "txn123456789", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Failed Sign-On Policy Evaluation
    ExpectedResult: false
    Log:
      {
        "uuid": "b2c3d4e5-f6a7-8901-bcde-2345678901bc",
        "published": "2024-10-15 15:45:22.456",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "WARN",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Test User",
            "id": "00u234567890bcdefg",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.0.2.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "outcome": { "result": "FAILURE", "reason": "Policy denied access" },
        "target":
          [
            {
              "id": "0oa234567890bcdefg",
              "type": "AppInstance",
              "alternateId": "AWS",
              "displayName": "Amazon Web Services",
            },
          ],
        "transaction": { "id": "txn234567890", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Different Event Type
    ExpectedResult: false
    Log:
      {
        "uuid": "c3d4e5f6-a7b8-9012-cdef-3456789012cd",
        "published": "2024-10-15 16:20:33.789",
        "eventType": "user.session.start",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "User login to Okta",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "User",
            "id": "00u345678901cdefgh",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.50",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "transaction": { "id": "txn345678901", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Successful Sign-On with SAML (Not SWA)
    ExpectedResult: false
    Log:
      {
        "uuid": "d4e5f6a7-b8c9-0123-def1-4567890123de",
        "published": "2024-10-15 17:00:00.000",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "User",
            "id": "00u456789012defghi",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "SAML_2_0",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa456789012defghi",
              "type": "AppInstance",
              "alternateId": "Office365",
              "displayName": "Microsoft Office 365",
            },
          ],
        "transaction": { "id": "txn456789012", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Successful Sign-On with OIDC (Not SWA)
    ExpectedResult: false
    Log:
      {
        "uuid": "e5f6a7b8-c9d0-1234-ef12-5678901234ef",
        "published": "2024-10-15 18:15:30.456",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "admin@company.com",
            "displayName": "Admin",
            "id": "00u567890123efghij",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.75",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "OPENID_CONNECT",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa567890123efghij",
              "type": "AppInstance",
              "alternateId": "GitHub",
              "displayName": "GitHub Enterprise",
            },
          ],
        "transaction": { "id": "txn567890123", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Successful Sign-On Missing signOnMode Field
    ExpectedResult: false
    Log:
      {
        "uuid": "f6a7b8c9-d0e1-2345-f123-6789012345f0",
        "published": "2024-10-15 19:30:45.789",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "User",
            "id": "00u678901234fghijk",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.50",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "debugContext": { "debugData": {} },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa678901234fghijk",
              "type": "AppInstance",
              "alternateId": "Slack",
              "displayName": "Slack Workspace",
            },
          ],
        "transaction": { "id": "txn678901234", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Successful Sign-On Missing debugContext Entirely
    ExpectedResult: false
    Log:
      {
        "uuid": "a7b8c9d0-e1f2-3456-a123-7890123456a1",
        "published": "2024-10-15 20:45:12.345",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "User",
            "id": "00u789012345ghijkl",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "FIREFOX",
                "os": "Linux",
                "rawUserAgent": "Mozilla/5.0 (X11; Linux x86_64; rv:109.0)",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa789012345ghijkl",
              "type": "AppInstance",
              "alternateId": "Jira",
              "displayName": "Jira Cloud",
            },
          ],
        "transaction": { "id": "txn789012345", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }
