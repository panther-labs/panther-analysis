AnalysisType: rule
Description: >-
  This rule looks for the same session being used from two devices, indicating a compromised
  session token.
DisplayName: "Okta Potentially Stolen Session"
Enabled: true
Filename: okta_potentially_stolen_session.py
LogTypes:
  - Okta.SystemLog
Reference: https://sec.okta.com/sessioncookietheft
Reports:
  MITRE ATT&CK:
    - TA0006:T1539
RuleID: "Okta.PotentiallyStolenSession"
Runbook: >-
  Confirm the session is used on two devices, one of which is unknown. Lock the users
  Okta account and clear the users sessions in down stream apps.
Severity: High
SummaryAttributes:
  - eventType
  - severity
  - p_any_ip_addresses
  - p_any_domain_names
Tags:
  - Identity & Access Management
  - Okta
Tests:
  - ExpectedResult: false
    Log:
      "actor":
        "alternateId": "admin"
        "displayName": "unknown"
        "id": "unknown"
        "type": "User"
      "authenticationContext":
        "authenticationStep": 0
        "externalSessionId": "123456789"
      "client":
        "device": "Computer"
        "geographicalContext":
          "city": "Dois Irmaos"
          "country": "Brazil"
          "geolocation":
            "lat": -29.6116
            "lon": -51.0933
          "postalCode": "93950"
          "state": "Rio Grande do Sul"
        "ipAddress": "1.2.3.4"
        "userAgent":
          "browser": "CHROME"
          "os": "Linux"
          "rawUserAgent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML,
            like Gecko) Chrome/84.0.4147.135 Safari/537.36"
        "zone": "null"
      "debugContext":
        "debugData":
          "dtHash": "kzpx58a99d2oam082rlu588wgy1mb0zfi1e1l63f9cjx4uxc455k4t6xdiwbxian"
          "loginResult": "VERIFICATION_ERROR"
          "requestId": "redacted"
          "requestUri": "redacted"
          "threatSuspected": "false"
          "url": "redacted"
      "displayMessage": "User login to Okta"
      "eventType": "user.session.start"
      "legacyEventType": "core.user_auth.login_failed"
      "outcome":
        "reason": "VERIFICATION_ERROR"
        "result": "FAILURE"
      "p_any_domain_names":
        - "rnvtelecom.com.br"
      "p_any_ip_addresses":
        - "redacted"
      "p_event_time": "redacted"
      "p_log_type": "Okta.SystemLog"
      "p_parse_time": "redacted"
      "p_row_id": "redacted"
      "p_source_id": "redacted"
      "p_source_label": "Okta"
      "published": "redacted"
      "request":
        "ipChain":
          - "geographicalContext":
              "city": "Dois Irmaos"
              "country": "Brazil"
              "geolocation":
                "lat": -29.6116
                "lon": -51.0933
              "postalCode": "93950"
              "state": "Rio Grande do Sul"
            "ip": "redacted"
            "version": "V4"
      "securityContext":
        "asNumber": 263297
        "asOrg": "renovare telecom"
        "domain": "rnvtelecom.com.br"
        "isProxy": false
        "isp": "renovare telecom"
      "severity": "INFO"
      "transaction":
        "detail": {}
        "id": "redacted"
        "type": "WEB"
      "uuid": "redacted"
      "version": "0"
    Mocks:
      - objectName: get_string_set
        returnValue: "[\n    \"263297\",\n    \"1.2.3.4\",\n    \"user_agent:Mozilla/5.0
          (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135
          Safari/537.36\",\n    \"CHROME\",\n    \"Linux\"\n]\n"
    Name: Same device and OS
  - ExpectedResult: true
    Log:
      "actor":
        "alternateId": "admin"
        "displayName": "Bobert"
        "id": "unknown"
        "type": "User"
      "authenticationContext":
        "authenticationStep": 0
        "externalSessionId": "123456789"
      "client":
        "device": "Computer"
        "geographicalContext":
          "city": "Dois Irmaos"
          "country": "Brazil"
          "geolocation":
            "lat": -29.6116
            "lon": -51.0933
          "postalCode": "93950"
          "state": "Rio Grande do Sul"
        "ipAddress": "1.2.3.4"
        "userAgent":
          "browser": "CHROME"
          "os": "Linux"
          "rawUserAgent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML,
            like Gecko) Chrome/84.0.4147.135 Safari/537.36"
        "zone": "null"
      "debugContext":
        "debugData":
          "dtHash": "kzpx58a99d2oam082rlu588wgy1mb0zfi1e1l63f9cjx4uxc455k4t6xdiwbxian"
          "loginResult": "VERIFICATION_ERROR"
          "requestId": "redacted"
          "requestUri": "redacted"
          "threatSuspected": "false"
          "url": "redacted"
      "displayMessage": "User login to Okta"
      "eventType": "user.session.start"
      "legacyEventType": "core.user_auth.login_failed"
      "outcome":
        "reason": "VERIFICATION_ERROR"
        "result": "FAILURE"
      "p_any_domain_names":
        - "rnvtelecom.com.br"
      "p_any_ip_addresses":
        - "redacted"
      "p_event_time": "redacted"
      "p_log_type": "Okta.SystemLog"
      "p_parse_time": "redacted"
      "p_row_id": "redacted"
      "p_source_id": "redacted"
      "p_source_label": "Okta"
      "published": "redacted"
      "request":
        "ipChain":
          - "geographicalContext":
              "city": "Dois Irmaos"
              "country": "Brazil"
              "geolocation":
                "lat": -29.6116
                "lon": -51.0933
              "postalCode": "93950"
              "state": "Rio Grande do Sul"
            "ip": "redacted"
            "version": "V4"
      "securityContext":
        "asNumber": 263297
        "asOrg": "renovare telecom"
        "domain": "rnvtelecom.com.br"
        "isProxy": false
        "isp": "renovare telecom"
      "severity": "INFO"
      "transaction":
        "detail": {}
        "id": "redacted"
        "type": "WEB"
      "uuid": "redacted"
      "version": "0"
    Mocks:
      - objectName: get_string_set
        returnValue: "[\n    \"123456\",\n    \"4.3.2.1\",\n    \"user_agent:Mozilla/5.0
          (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko)
          Chrome/105.0.0.0 Safari/537.36\",\n    \"CHROME\",\n    \"MacOS\"\n]\n"
    Name: Different device & ASN
  - ExpectedResult: false
    Log:
      "actor":
        "alternateId": "admin"
        "displayName": "Bobert"
        "id": "unknown"
        "type": "User"
      "authenticationContext":
        "authenticationStep": 0
        "externalSessionId": "123456789"
      "client":
        "device": "Computer"
        "geographicalContext":
          "city": "Dois Irmaos"
          "country": "Brazil"
          "geolocation":
            "lat": -29.6116
            "lon": -51.0933
          "postalCode": "93950"
          "state": "Rio Grande do Sul"
        "ipAddress": "1.2.3.4"
        "userAgent":
          "browser": "CHROME"
          "os": "Linux"
          "rawUserAgent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML,
            like Gecko) Chrome/84.0.4147.135 Safari/537.36"
        "zone": "null"
      "debugContext":
        "debugData":
          "dtHash": "kzpx58a99d2oam082rlu588wgy1mb0zfi1e1l63f9cjx4uxc455k4t6xdiwbxian"
          "loginResult": "VERIFICATION_ERROR"
          "requestId": "redacted"
          "requestUri": "redacted"
          "threatSuspected": "false"
          "url": "redacted"
      "displayMessage": "User login to Okta"
      "eventType": "user.session.start"
      "legacyEventType": "core.user_auth.login_failed"
      "outcome":
        "reason": "VERIFICATION_ERROR"
        "result": "FAILURE"
      "p_any_domain_names":
        - "rnvtelecom.com.br"
      "p_any_ip_addresses":
        - "redacted"
      "p_event_time": "redacted"
      "p_log_type": "Okta.SystemLog"
      "p_parse_time": "redacted"
      "p_row_id": "redacted"
      "p_source_id": "redacted"
      "p_source_label": "Okta"
      "published": "redacted"
      "request":
        "ipChain":
          - "geographicalContext":
              "city": "Dois Irmaos"
              "country": "Brazil"
              "geolocation":
                "lat": -29.6116
                "lon": -51.0933
              "postalCode": "93950"
              "state": "Rio Grande do Sul"
            "ip": "redacted"
            "version": "V4"
      "securityContext":
        "asNumber": 263297
        "asOrg": "renovare telecom"
        "domain": "rnvtelecom.com.br"
        "isProxy": false
        "isp": "renovare telecom"
      "severity": "INFO"
      "transaction":
        "detail": {}
        "id": "redacted"
        "type": "WEB"
      "uuid": "redacted"
      "version": "0"
    Mocks:
      - objectName: get_string_set
        returnValue: "[\n    \"654321\",\n    \"1.2.3.4\",\n    \"user_agent:Mozilla/5.0
          (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.135
          Safari/537.36\",\n    \"CHROME\",\n    \"Linux\"\n]\n"
    Name: Different ASN & same device
  - ExpectedResult: false
    Log:
      "actor":
        "alternateId": "admin"
        "displayName": "Bobert"
        "id": "unknown"
        "type": "User"
      "authenticationContext":
        "authenticationStep": 0
        "externalSessionId": "123456789"
      "client":
        "device": "Unknown"
        "geographicalContext":
          "city": "Boardman"
          "country": "United States"
          "geolocation":
            "lat": 45.8234
            "lon": -119.7257
          "postalCode": "97818"
          "state": "Oregon"
        "id": "okta.b58d5b75-07d4-5f25-bf59-368a1261a405"
        "ipAddress": "44.238.82.114"
        "userAgent":
          "browser": "UNKNOWN"
          "os": "Unknown"
          "rawUserAgent": "Okta-Integrations"
        "zone": "null"
      "debugContext":
        "debugData":
          "loginResult": "VERIFICATION_ERROR"
          "requestId": "redacted"
          "requestUri": "redacted"
          "threatSuspected": "false"
          "url": "redacted"
      "displayMessage": "User login to Okta"
      "eventType": "user.session.start"
      "legacyEventType": "core.user_auth.login_failed"
      "outcome":
        "reason": "VERIFICATION_ERROR"
        "result": "FAILURE"
      "p_any_domain_names":
        - "rnvtelecom.com.br"
      "p_any_ip_addresses":
        - "redacted"
      "p_event_time": "redacted"
      "p_log_type": "Okta.SystemLog"
      "p_parse_time": "redacted"
      "p_row_id": "redacted"
      "p_source_id": "redacted"
      "p_source_label": "Okta"
      "published": "redacted"
      "request":
        "ipChain":
          - "geographicalContext":
              "city": "Boardman"
              "country": "United States"
              "geolocation":
                "lat": 45.8234
                "lon": -119.7257
              "postalCode": "97818"
              "state": "Oregon"
            "ip": "44.238.82.114"
            "version": "V4"
      "securityContext": {}
      "severity": "INFO"
      "transaction":
        "detail": {}
        "id": "redacted"
        "type": "WEB"
      "uuid": "redacted"
      "version": "0"
    Mocks:
      - objectName: get_string_set
        returnValue: "[\n    \"123456\",\n    \"4.3.2.1\",\n    \"user_agent:Mozilla/5.0
          (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko)
          Chrome/105.0.0.0 Safari/537.36\",\n    \"CHROME\",\n    \"MacOS\"\n]\n"
    Name: Okta internal event should be ignored
