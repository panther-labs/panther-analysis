AnalysisType: rule
Filename: okta_swa_offhours_access.py
RuleID: "Okta.SWA.OffHours.Access"
DisplayName: "Okta SWA Off-Hours Access"
Enabled: true
Status: Experimental
LogTypes:
  - Okta.SystemLog
Tags:
  - Identity & Access Management
  - Okta
  - SWA
  - Credential Access:Credentials from Password Stores
  - Persistence
  - Configuration Required
Reports:
  MITRE ATT&CK:
    - TA0006:T1555  # Credentials from Password Stores
    - TA0003:T1078  # Valid Accounts (Persistence)
Severity: Medium
Description: |
  Detects SWA (Secure Web Authentication) password access or application sign-on events occurring
  outside of standard business hours (8 AM - 6 PM UTC). Off-hours access to SWA credentials may
  indicate compromised accounts, insider threats, or unauthorized access attempts. SWA applications
  store credentials in Okta's encrypted vault, making off-hours access a high-risk indicator.

  NOTE: Panther logs are in UTC. The default business hours (8 AM - 6 PM UTC) may not match your
  organization's timezone. You must adjust the BUSINESS_HOURS_START and BUSINESS_HOURS_END constants
  in the Python file to reflect your organization's working hours in UTC.

  This rule monitors two event types:
  - application.user_membership.show_password: Direct password reveal from Okta vault
  - policy.evaluate_sign_on: SWA application sign-on (filtered for BROWSER_PLUGIN mode)

  Severity escalation:
  - HIGH: Late night access (10 PM - 4 AM UTC)
  - MEDIUM: Early morning/evening access (4 AM - 8 AM, 6 PM - 10 PM UTC)
Reference: https://help.okta.com/en-us/content/topics/apps/apps-about-swa.htm
Runbook: |
  1. Verify the configured business hours (BUSINESS_HOURS_START/END in the Python file) match your organization's timezone converted to UTC
  2. Verify the user's normal working hours and timezone
  3. Check if the user has legitimate business need for off-hours access
  4. Review the accessed application for sensitivity and criticality
  5. Investigate the source IP address and geolocation for anomalies
  6. Check for other suspicious activity from the same user or IP
  7. Review user-agent string for automation tools or unexpected devices
  8. Verify if the user was on-call or had authorized after-hours work
  9. Check for multiple off-hours accesses indicating pattern of abuse
  10. If unauthorized, suspend the account and revoke active sessions
  11. Force password reset and MFA re-enrollment if compromise is suspected
  12. Audit all applications accessed during the off-hours window
  13. Review Okta admin logs for any configuration changes around the same time
DedupPeriodMinutes: 60
SummaryAttributes:
  - eventType
  - p_any_ip_addresses
Tests:
  - Name: Password Access at 2 AM (Late Night - HIGH Severity)
    ExpectedResult: true
    Log:
      {
        "uuid": "a1b2c3d4-e5f6-7890-abcd-1234567890ab",
        "published": "2024-10-15T02:30:45.123Z",
        "eventType": "application.user_membership.show_password",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "User accessed application password",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Test User",
            "id": "00u123456789abcdef",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
            "geographicalContext":
              {
                "city": "San Francisco",
                "country": "United States",
                "state": "California",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "alternateId": "user@company.com",
              "displayName": "Test User",
              "id": "00u123456789abcdef",
              "type": "AppUser",
            },
            {
              "alternateId": "Salesforce",
              "displayName": "Salesforce Production",
              "id": "0oa123456789abcdef",
              "type": "AppInstance",
            },
            {
              "alternateId": "user@company.com",
              "displayName": "Test User",
              "id": "00u123456789abcdef",
              "type": "User",
            },
          ],
        "transaction": { "id": "txn123456789", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Password Access During Business Hours
    ExpectedResult: false
    Log:
      {
        "uuid": "b2c3d4e5-f6a7-8901-bcde-2345678901bc",
        "published": "2024-10-15T14:30:45.123Z",
        "eventType": "application.user_membership.show_password",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "User accessed application password",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Test User",
            "id": "00u234567890bcdefg",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "alternateId": "user@company.com",
              "displayName": "Test User",
              "id": "00u234567890bcdefg",
              "type": "AppUser",
            },
            {
              "alternateId": "AWS",
              "displayName": "Amazon Web Services",
              "id": "0oa234567890bcdefg",
              "type": "AppInstance",
            },
            {
              "alternateId": "user@company.com",
              "displayName": "Test User",
              "id": "00u234567890bcdefg",
              "type": "User",
            },
          ],
        "transaction": { "id": "txn234567890", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: SWA App Access at 8 PM (Early Evening - MEDIUM Severity)
    ExpectedResult: true
    Log:
      {
        "uuid": "c3d4e5f6-a7b8-9012-cdef-3456789012cd",
        "published": "2024-10-15T20:15:33.789Z",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "admin@company.com",
            "displayName": "Admin User",
            "id": "00u345678901cdefgh",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.50",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
            "geographicalContext":
              {
                "city": "New York",
                "country": "United States",
                "state": "New York",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "BROWSER_PLUGIN",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa345678901cdefgh",
              "type": "AppInstance",
              "alternateId": "Workday",
              "displayName": "Workday HCM",
            },
          ],
        "transaction": { "id": "txn345678901", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: SWA App Access During Business Hours
    ExpectedResult: false
    Log:
      {
        "uuid": "d4e5f6a7-b8c9-0123-def1-4567890123de",
        "published": "2024-10-15T10:00:00.000Z",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Normal User",
            "id": "00u456789012defghi",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "BROWSER_PLUGIN",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa456789012defghi",
              "type": "AppInstance",
              "alternateId": "Salesforce",
              "displayName": "Salesforce",
            },
          ],
        "transaction": { "id": "txn456789012", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Non-SWA App Access Outside Hours (Should Not Alert)
    ExpectedResult: false
    Log:
      {
        "uuid": "e5f6a7b8-c9d0-1234-ef12-5678901234ef",
        "published": "2024-10-15T22:30:00.000Z",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Test User",
            "id": "00u567890123efghij",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "SAML_2_0",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa567890123efghij",
              "type": "AppInstance",
              "alternateId": "Office365",
              "displayName": "Microsoft Office 365",
            },
          ],
        "transaction": { "id": "txn567890123", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Failed SWA App Access Outside Hours (Should Not Alert)
    ExpectedResult: false
    Log:
      {
        "uuid": "f6a7b8c9-d0e1-2345-f123-6789012345f0",
        "published": "2024-10-15T23:45:00.000Z",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "WARN",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "User",
            "id": "00u678901234fghijk",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.50",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "BROWSER_PLUGIN",
              },
          },
        "outcome": { "result": "FAILURE", "reason": "Policy denied access" },
        "target":
          [
            {
              "id": "0oa678901234fghijk",
              "type": "AppInstance",
              "alternateId": "Slack",
              "displayName": "Slack",
            },
          ],
        "transaction": { "id": "txn678901234", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Different Event Type Outside Hours
    ExpectedResult: false
    Log:
      {
        "uuid": "a7b8c9d0-e1f2-3456-a123-7890123456a1",
        "published": "2024-10-15T01:30:15.567Z",
        "eventType": "user.session.start",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "User login to Okta",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "User",
            "id": "00u789012345ghijkl",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.50",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "transaction": { "id": "txn789012345", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Boundary - Exactly 08:00 UTC (Start of Business Hours)
    ExpectedResult: false
    Log:
      {
        "uuid": "b8c9d0e1-f2a3-4567-b234-890123456b2",
        "published": "2024-10-15T08:00:00.000Z",
        "eventType": "application.user_membership.show_password",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "User accessed application password",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Test User",
            "id": "00u890123456hijklm",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "BROWSER_PLUGIN",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "alternateId": "user@company.com",
              "displayName": "Test User",
              "id": "00u890123456hijklm",
              "type": "AppUser",
            },
            {
              "alternateId": "Salesforce",
              "displayName": "Salesforce",
              "id": "0oa890123456hijklm",
              "type": "AppInstance",
            },
          ],
        "transaction": { "id": "txn890123456", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Boundary - Exactly 18:00 UTC (End of Business Hours - MEDIUM)
    ExpectedResult: true
    Log:
      {
        "uuid": "c9d0e1f2-a3b4-5678-c345-901234567c3",
        "published": "2024-10-15T18:00:00.000Z",
        "eventType": "application.user_membership.show_password",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "User accessed application password",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "Test User",
            "id": "00u901234567ijklmn",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.100",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "alternateId": "user@company.com",
              "displayName": "Test User",
              "id": "00u901234567ijklmn",
              "type": "AppUser",
            },
            {
              "alternateId": "Workday",
              "displayName": "Workday HCM",
              "id": "0oa901234567ijklmn",
              "type": "AppInstance",
            },
          ],
        "transaction": { "id": "txn901234567", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Boundary - Exactly 22:00 UTC (Start of Late Night - HIGH)
    ExpectedResult: true
    Log:
      {
        "uuid": "d0e1f2a3-b4c5-6789-d456-012345678d4",
        "published": "2024-10-15T22:00:00.000Z",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "admin@company.com",
            "displayName": "Admin User",
            "id": "00u012345678jklmno",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.75",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Mac OS X",
                "rawUserAgent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "BROWSER_PLUGIN",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa012345678jklmno",
              "type": "AppInstance",
              "alternateId": "AWS",
              "displayName": "Amazon Web Services",
            },
          ],
        "transaction": { "id": "txn012345678", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Boundary - Exactly 04:00 UTC (End of Late Night - MEDIUM)
    ExpectedResult: true
    Log:
      {
        "uuid": "e1f2a3b4-c5d6-7890-e567-123456789e5",
        "published": "2024-10-15T04:00:00.000Z",
        "eventType": "policy.evaluate_sign_on",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "Evaluation of sign-on policy",
        "actor":
          {
            "alternateId": "user@company.com",
            "displayName": "User",
            "id": "00u123456789klmnop",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.50",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Windows",
                "rawUserAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
              },
          },
        "debugContext":
          {
            "debugData":
              {
                "signOnMode": "BROWSER_PLUGIN",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "id": "0oa123456789klmnop",
              "type": "AppInstance",
              "alternateId": "Zendesk",
              "displayName": "Zendesk Support",
            },
          ],
        "transaction": { "id": "txn123456789", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }

  - Name: Early Morning Access at 06:00 UTC (MEDIUM Severity)
    ExpectedResult: true
    Log:
      {
        "uuid": "f2a3b4c5-d6e7-8901-f678-234567890f6",
        "published": "2024-10-15T06:00:00.000Z",
        "eventType": "application.user_membership.show_password",
        "version": "0",
        "severity": "INFO",
        "displayMessage": "User accessed application password",
        "actor":
          {
            "alternateId": "developer@company.com",
            "displayName": "Developer User",
            "id": "00u234567890lmnopq",
            "type": "User",
          },
        "client":
          {
            "device": "Computer",
            "ipAddress": "192.168.1.200",
            "userAgent":
              {
                "browser": "CHROME",
                "os": "Linux",
                "rawUserAgent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36",
              },
            "geographicalContext":
              {
                "city": "Seattle",
                "country": "United States",
                "state": "Washington",
              },
          },
        "outcome": { "result": "SUCCESS" },
        "target":
          [
            {
              "alternateId": "developer@company.com",
              "displayName": "Developer User",
              "id": "00u234567890lmnopq",
              "type": "AppUser",
            },
            {
              "alternateId": "GitHub",
              "displayName": "GitHub Enterprise",
              "id": "0oa234567890lmnopq",
              "type": "AppInstance",
            },
            {
              "alternateId": "developer@company.com",
              "displayName": "Developer User",
              "id": "00u234567890lmnopq",
              "type": "User",
            },
          ],
        "transaction": { "id": "txn234567890", "type": "WEB" },
        "p_log_type": "Okta.SystemLog",
      }
