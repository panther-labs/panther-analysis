AnalysisType: rule
Description: >-
  A Key Logger has potentially been detected on a macOS system
DisplayName: "MacOS Keyboard Events"
Enabled: true
Filename: osquery_mac_osx_attacks_keyboard_events.py
LogTypes:
  - Osquery.Differential
Reference: https://support.apple.com/en-us/HT204899
Reports:
  MITRE ATT&CK:
    - TA0009:T1056
RuleID: "Osquery.Mac.OSXAttacksKeyboardEvents"
Runbook: >-
  Verify the Application monitoring the keyboard taps
Severity: Medium
SummaryAttributes:
  - name
  - hostIdentifier
  - action
Tags:
  - Osquery
  - MacOS
  - Malware
  - Collection:Input Capture
Tests:
  - ExpectedResult: true
    Log:
      "action": "added"
      "columns":
        "name": "Siri"
        "path": "/Users/johnny/Desktop/Siri.app/Contents/MacOS/Siri"
        "pid": 100
      "hostIdentifier": "test-host"
      "name": "pack_osx-attacks_Keyboard_Event_Taps"
    Name: App running on Desktop that is watching keyboard events
  - ExpectedResult: false
    Log:
      "action": "added"
      "columns":
        "name": "Siri"
        "path": "/System/Library/CoreServices/Siri.app/Contents/MacOS/Siri"
        "pid": 100
      "hostIdentifier": "test-host"
      "name": "pack_osx-attacks_Keyboard_Event_Taps"
    Name: App is running from approved path
  - ExpectedResult: false
    Log:
      "action": "added"
      "calendarTime": "2020-04-10 23:26:11.000000000"
      "columns":
        "blocks": "61202533"
        "blocks_available": "22755926"
        "blocks_free": "58479522"
        "blocks_size": "4096"
        "device": "/dev/disk1s5"
        "device_alias": "/dev/disk1s5"
        "flags": "75550721"
        "inodes": "2448101320"
        "inodes_free": "2447613763"
        "path": "/"
        "type": "apfs"
      "counter": 28
      "decorations":
        "host_uuid": "0ec3540f-1dd9-4462-bd28-0f63b2611621"
        "hostname": "MacBook-Pro.local"
      "epoch": 0
      "hostIdentifier": "MacBook-Pro.local"
      "name": "pack/incident-response/mounts"
      "unixTime": 1586561171
    Name: Unrelated query does not alert
