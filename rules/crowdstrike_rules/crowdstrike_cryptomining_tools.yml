AnalysisType: rule
Description: >
  Detects the execution of known cryptocurrency mining tools such as XMRig, CGMiner, ETHMiner, PhoenixMiner, and similar utilities that consume system resources to mine digital currencies. These tools are commonly deployed by attackers during cryptojacking operations to hijack computing resources for financial gain without authorization. Cryptocurrency miners consume significant CPU and GPU resources, degrading system performance and increasing electricity costs while generating revenue for attackers. While some organizations may legitimately use mining software for research or blockchain operations, unauthorized deployment typically indicates compromise through malware droppers, supply chain attacks, or exploitation of vulnerable services. Cryptominers are often deployed as secondary payloads following initial access and may persist through scheduled tasks, registry modifications, or service installations. This rule leverages CrowdStrike's endpoint telemetry to detect process execution of known mining tools by filename, enabling rapid response to resource hijacking attempts before significant infrastructure impact or lateral movement to additional systems.
DisplayName: "Crowdstrike Cryptomining Tools"
Enabled: true
Filename: crowdstrike_cryptomining_tools.py
Reference: https://www.crowdstrike.com/cybersecurity-101/cryptojacking/
Severity: Critical
Tags:
  - CrowdStrike
  - Windows
  - Resource Hijacking
  - Cryptojacking
  - Cryptomining
  - Impact
  - Endpoint Detection
  - Performance Degradation
Runbook: |
  1. Immediately identify the affected host from the alert (aid field for CrowdStrike Agent ID, aip for IP address, ComputerName) and determine which cryptocurrency mining tool was executed (check ImageFileName and CommandLine fields)
  2. Use CrowdStrike Real Time Response (RTR) to contain the host by executing network isolation: `contain` command in the Falcon console to prevent mining pool communication and lateral movement to other systems
  3. Identify the user account and parent process that launched the mining tool (check UserSid, ParentBaseFileName, ParentProcessId, SourceProcessId) to determine execution context, then immediately kill the mining process using RTR `kill` command or PowerShell `Stop-Process` to halt resource consumption
  4. Check for persistence mechanisms: search Windows Task Scheduler (`schtasks /query /fo LIST /v`), registry Run keys (`reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run`), Windows Services (`sc query`), and startup folders for mining tool references
  5. Review network connections from the compromised host to identify mining pool domains/IPs (check DNS queries for stratum+tcp://, pool addresses like xmr-pool.com, nanopool.org, ethermine.org) and add these indicators to block lists
  6. Hunt for the initial access vector by reviewing process timeline before miner execution: look for suspicious downloads, phishing email attachments, exploit activity, vulnerable service exploitation (RDP, SMB, exposed services), or supply chain compromise
  7. Search all endpoints in the environment for the mining tool's hash (MD5, SHA256 from alert) using CrowdStrike IOC search or EDR hunt capabilities to identify other compromised hosts in the cryptojacking campaign
  8. Collect forensic artifacts including the mining tool binary, configuration files (often contain wallet addresses and pool information), memory dumps, and any dropper/loader executables for malware analysis and attribution
  9. Analyze the miner configuration to extract attacker infrastructure: cryptocurrency wallet addresses (useful for tracking attacker profits and attribution), mining pool domains, and C2 callbacks. Review system logs for abnormal CPU/GPU usage patterns indicating long-running mining activity before detection
  10. Calculate business impact including electricity costs and system performance degradation, then remove all miner components, delete persistence mechanisms, patch vulnerabilities that enabled initial access, and implement monitoring for mining-related indicators (high CPU usage, mining pool connections, miner process names)
Reports:
  MITRE ATT&CK:
    - TA0040:T1496
Tests:
  - ExpectedResult: true
    Log:
      aid: 1234567890abcdefghijklmnop9876
      aip: 11.10.9.8
      cid: abcdefghijklmnop123467890
      configbuild: 1007.3.0016606.11
      configstatehash: "3799024366"
      entitlements: "15"
      event:
        AuthenticationId: "293628"
        AuthenticodeHashData: 5540c470218d209b7c3eca3d12e190580814d566
        CommandLine: C:\Windows\System32\ethminer.exe
        ConfigBuild: 1007.3.0016606.11
        ConfigStateHash: "3799024366"
        EffectiveTransmissionClass: "2"
        Entitlements: "15"
        ImageFileName: \Device\HarddiskVolume2\Windows\System32\ethminer.exe
        ImageSubsystem: "3"
        IntegrityLevel: "12288"
        MD5HashData: 5fd22b915c232378e567160d641cc9f2
        ParentAuthenticationId: "293628"
        ParentBaseFileName: pwsh.exe
        ParentProcessId: "4370948876"
        ProcessCreateFlags: "0"
        ProcessEndTime: ""
        ProcessParameterFlags: "24577"
        ProcessStartTime: "1682106752.006"
        ProcessSxsFlags: "64"
        RawProcessId: "1468"
        SHA1HashData: "0000000000000000000000000000000000000000"
        SHA256HashData: 488e74e2026d03f21b33f470c23b3de2f466643186c2e06ae7b4883cc2e59377
        SessionId: "2"
        SignInfoFlags: "8683538"
        SourceProcessId: "4370948876"
        SourceThreadId: "6364981533"
        Tags: 25, 27, 40, 151, 874, 924, 12094627905582, 12094627906234, 237494511599633
        TargetProcessId: "4390327988"
        TokenType: "1"
        TreeId: "4295752857"
        UserSid: S-1-5-21-239183934-720705223-383019856-500
        aid: 1234567890abcdefghijklmnop9876
        aip: 11.10.9.8
        cid: abcdefghijklmnop123467890
        event_platform: Win
        event_simpleName: ProcessRollup2
        id: 081d64d7-17fb-40c0-8767-48ff1e2ee2dd
        name: ProcessRollup2V19
        timestamp: "1682106752722"
      event_platform: Win
      event_simplename: ProcessRollup2
      fdr_event_type: ProcessRollup2
      id: 081d64d7-17fb-40c0-8767-48ff1e2ee2dd
      name: ProcessRollup2V19
      p_any_ip_addresses:
        - 11.10.9.8
      p_any_md5_hashes:
        - 5fd22b915c232378e567160d641cc9f2
        - 1234567890abcdefghijklmnop9876
        - abcdefghijklmnop123467890
      p_any_sha1_hashes:
        - "0000000000000000000000000000000000000000"
      p_any_sha256_hashes:
        - 488e74e2026d03f21b33f470c23b3de2f466643186c2e06ae7b4883cc2e59377
      p_any_trace_ids:
        - "4295752857"
        - 1234567890abcdefghijklmnop9876
        - abcdefghijklmnop123467890
      p_event_time: "2023-04-21 19:52:32.722"
      p_log_type: Crowdstrike.FDREvent
      p_parse_time: "2023-04-21 20:05:52.94"
      p_row_id: 7ac82dbb43a99bfec196bdda178c8101
      p_schema_version: 0
      p_source_id: 1f33f64c-124d-413c-a9e3-d51ccedd8e77
      p_source_label: Crowdstrike-FDR-Dev
      timestamp: "2023-04-21 19:52:32.722"
      treeid: "4295752857"
    Name: Crypto tool
  - ExpectedResult: false
    Log:
      aid: 1234567890abcdefghijklmnop9876
      aip: 11.10.9.8
      cid: abcdefghijklmnop123467890
      configbuild: 1007.3.0016606.11
      configstatehash: "3799024366"
      entitlements: "15"
      event:
        AuthenticationId: "293628"
        AuthenticodeHashData: 5540c470218d209b7c3eca3d12e190580814d566
        CommandLine: '"C:\Windows\System32\at.exe" at 09:00 /interactive /every:m,t,w,th,f,s,su'
        ConfigBuild: 1007.3.0016606.11
        ConfigStateHash: "3799024366"
        EffectiveTransmissionClass: "2"
        Entitlements: "15"
        ImageFileName: \Device\HarddiskVolume2\Windows\System32\at.exe
        ImageSubsystem: "3"
        IntegrityLevel: "12288"
        MD5HashData: 5fd22b915c232378e567160d641cc9f2
        ParentAuthenticationId: "293628"
        ParentBaseFileName: pwsh.exe
        ParentProcessId: "4370948876"
        ProcessCreateFlags: "0"
        ProcessEndTime: ""
        ProcessParameterFlags: "24577"
        ProcessStartTime: "1682106752.006"
        ProcessSxsFlags: "64"
        RawProcessId: "1468"
        SHA1HashData: "0000000000000000000000000000000000000000"
        SHA256HashData: 488e74e2026d03f21b33f470c23b3de2f466643186c2e06ae7b4883cc2e59377
        SessionId: "2"
        SignInfoFlags: "8683538"
        SourceProcessId: "4370948876"
        SourceThreadId: "6364981533"
        Tags: 25, 27, 40, 151, 874, 924, 12094627905582, 12094627906234, 237494511599633
        TargetProcessId: "4390327988"
        TokenType: "1"
        TreeId: "4295752857"
        UserSid: S-1-5-21-239183934-720705223-383019856-500
        aid: 1234567890abcdefghijklmnop9876
        aip: 11.10.9.8
        cid: abcdefghijklmnop123467890
        event_platform: Win
        event_simpleName: ProcessRollup2
        id: 081d64d7-17fb-40c0-8767-48ff1e2ee2dd
        name: ProcessRollup2V19
        timestamp: "1682106752722"
      event_platform: Win
      event_simplename: ProcessRollup2
      fdr_event_type: ProcessRollup2
      id: 081d64d7-17fb-40c0-8767-48ff1e2ee2dd
      name: ProcessRollup2V19
      p_any_ip_addresses:
        - 11.10.9.8
      p_any_md5_hashes:
        - 5fd22b915c232378e567160d641cc9f2
        - 1234567890abcdefghijklmnop9876
        - abcdefghijklmnop123467890
      p_any_sha1_hashes:
        - "0000000000000000000000000000000000000000"
      p_any_sha256_hashes:
        - 488e74e2026d03f21b33f470c23b3de2f466643186c2e06ae7b4883cc2e59377
      p_any_trace_ids:
        - "4295752857"
        - 1234567890abcdefghijklmnop9876
        - abcdefghijklmnop123467890
      p_event_time: "2023-04-21 19:52:32.722"
      p_log_type: Crowdstrike.FDREvent
      p_parse_time: "2023-04-21 20:05:52.94"
      p_row_id: 7ac82dbb43a99bfec196bdda178c8101
      p_schema_version: 0
      p_source_id: 1f33f64c-124d-413c-a9e3-d51ccedd8e77
      p_source_label: Crowdstrike-FDR-Dev
      timestamp: "2023-04-21 19:52:32.722"
      treeid: "4295752857"
    Name: Other
DedupPeriodMinutes: 60
LogTypes:
  - Crowdstrike.FDREvent
RuleID: "Crowdstrike.Cryptomining.Tools"
Threshold: 1
