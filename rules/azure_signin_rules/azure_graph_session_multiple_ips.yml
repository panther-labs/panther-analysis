AnalysisType: rule
Filename: azure_graph_session_multiple_ips.py
RuleID: "Azure.Audit.GraphSessionMultipleIPs"
DisplayName: "Azure Microsoft Graph Single Session from Multiple IP Addresses"
Enabled: true
Status: Experimental
LogTypes:
  - Azure.Audit
Severity: Medium
DedupPeriodMinutes: 60
Description: >
  Detects when a user signs in to Microsoft Entra ID and subsequently accesses Microsoft Graph from
  a different IP address using the same session ID. This behavior may indicate OAuth application abuse,
  session hijacking, token replay attacks, or adversary-in-the-middle attacks where an attacker has
  obtained a valid session token and is using it from their own infrastructure.
Tags:
  - Initial Access
  - Valid Accounts
  - Use Alternate Authentication Material
Reports:
  MITRE ATT&CK:
    - TA0001:T1078
    - TA0001:T1078.004
    - TA0005:T1550
    - TA0005:T1550.001
Runbook: |
  1. Review the alert details to identify the user principal name, session ID, all source IP addresses observed, user agents, and the timeline of Microsoft Graph access events
  2. Query Azure.Audit logs for all Microsoft Graph access events with the same session ID in the 4 hours surrounding the alert to build a complete picture of all accessed resources and API calls
  3. Compare the geographic locations and ASN information for all distinct source IPs to determine if they represent different countries, cloud providers, VPN services, or residential ISPs that would be inconsistent with legitimate user behavior
  4. Contact the user directly through an out-of-band communication method to verify if they accessed Microsoft Graph from multiple locations during the identified timeframe
  5. Review the user agent strings for each IP address to identify if different applications, browsers, or OAuth applications were used, which may indicate token theft or session hijacking
  6. Review Azure.Audit logs for the user principal name in the 7 days before the session to identify any OAuth consent grants, new application registrations, risky sign-ins, or MFA changes that may have enabled initial access
  7. Check for signs of token-related activity including OAuth token issuance events, refresh token usage, or authentication policy changes that could explain the multi-IP access pattern
  8. If session hijacking or token theft is confirmed: Immediately revoke all active sessions and refresh tokens for the user, force password reset, and require MFA re-enrollment
  9. Review the Microsoft Graph resources that were accessed during the suspicious session to assess potential data exposure including emails, files, contacts, calendar events, or organizational directory information
  10. Document the incident including all accessed resources, implement conditional access policies to restrict Microsoft Graph access based on IP ranges or compliant devices, and enable continuous access evaluation to detect token replay attacks
Reference: https://github.com/elastic/detection-rules/blob/main/rules/integrations/azure/initial_access_entra_id_graph_single_session_from_multiple_addresses.toml
SummaryAttributes:
  - properties:userPrincipalName
  - callerIpAddress
  - properties:sessionId
  - properties:appDisplayName
Tests:
  - Name: Multiple IP Access to Same Microsoft Graph Session
    ExpectedResult: true
    Mocks:
      - objectName: "add_to_string_set"
        returnValue: '["203.0.113.45", "198.51.100.88"]'
    Log:
      {
        "time": "2025-01-15 09:35:20.456",
        "resourceId": "/tenants/tenant-123/providers/Microsoft.aadiam",
        "operationName": "Sign-in activity",
        "operationVersion": "1.0",
        "category": "SignInLogs",
        "tenantId": "tenant-123",
        "resultType": "Success",
        "resultSignature": "SUCCESS",
        "durationMs": 0,
        "callerIpAddress": "5.5.5.5",
        "correlationId": "graph-session-002",
        "Level": "4",
        "properties":
          {
            "createdDateTime": "2025-01-15T09:35:20.4567890Z",
            "userPrincipalName": "gandalf@lotr.com",
            "userId": "user-123",
            "ipAddress": "5.5.5.5",
            "sessionId": "session-abc-123",
            "resourceDisplayName": "Microsoft Graph",
            "resourceId": "00000003-0000-0000-c000-111111111111",
            "appDisplayName": "Custom Graph App",
            "appId": "app-custom-789",
            "userAgent": "python-requests/2.28.1",
            "isInteractive": false,
            "authenticationProtocol": "oAuth2",
            "conditionalAccessStatus": "success",
          },
        "p_event_time": "2025-01-15 09:35:20.456",
        "p_log_type": "Azure.Audit",
        "p_parse_time": "2025-01-15 09:35:21.000",
        "p_row_id": "row-456",
      }
  - Name: Whitelisted Office 365
    ExpectedResult: false
    Log:
      {
        "time": "2025-01-15 10:00:30.789",
        "resourceId": "/tenants/tenant-456/providers/Microsoft.aadiam",
        "operationName": "Sign-in activity",
        "operationVersion": "1.0",
        "category": "SignInLogs",
        "tenantId": "tenant-456",
        "resultType": "Success",
        "resultSignature": "SUCCESS",
        "durationMs": 0,
        "callerIpAddress": "192.0.2.100",
        "correlationId": "office365-001",
        "Level": "4",
        "properties":
          {
            "createdDateTime": "2025-01-15T10:00:30.7890123Z",
            "userPrincipalName": "employee@company.com",
            "userId": "user-456",
            "ipAddress": "192.0.2.100",
            "sessionId": "session-office-456",
            "resourceDisplayName": "Microsoft Graph",
            "resourceId": "00000003-0000-0000-c000-000000000000",
            "appDisplayName": "Office 365",
            "appId": "00000003-0000-0ff1-ce00-000000000000",
            "userAgent": "Microsoft Office/16.0",
            "isInteractive": true,
            "authenticationProtocol": "oAuth2",
            "conditionalAccessStatus": "success",
          },
        "p_event_time": "2025-01-15 10:00:30.789",
        "p_log_type": "Azure.Audit",
      }