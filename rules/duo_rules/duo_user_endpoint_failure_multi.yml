AnalysisType: rule
DedupPeriodMinutes: 15
Description: >-
  A Duo user's authentication was denied due to a suspicious error on the endpoint
DisplayName: "Duo User Denied For Endpoint Error"
Enabled: true
Filename: duo_user_endpoint_failure_multi.py
LogTypes:
  - Duo.Authentication
Reference: https://duo.com/docs/adminapi#authentication-logs
RuleID: "DUO.User.Endpoint.Failure"
Runbook: >-
  Follow up with the endpoint owner to see status. Follow up with user to verify attempts.
Severity: Medium
Tags:
  - Duo
Tests:
  - ExpectedResult: true
    Log:
      "access_device":
        "ip": "12.12.112.25"
        "os": "Mac OS X"
      "application": {}
      "auth_device":
        "ip": "12.12.12.12"
      "event_type": "authentication"
      "factor": "duo_push"
      "reason": "endpoint_is_not_in_management_system"
      "result": "denied"
      "user":
        "name": "example@example.io"
    Name: endpoint_is_not_in_management_system
  - ExpectedResult: true
    Log:
      "access_device":
        "ip": "12.12.112.25"
        "os": "Mac OS X"
      "application": {}
      "auth_device":
        "ip": "12.12.12.12"
      "event_type": "authentication"
      "factor": "duo_push"
      "reason": "endpoint_failed_google_verification"
      "result": "denied"
      "user":
        "name": "example@example.io"
    Name: endpoint_failed_google_verification
  - ExpectedResult: true
    Log:
      "access_device":
        "ip": "12.12.112.25"
        "os": "Mac OS X"
      "application": {}
      "auth_device":
        "ip": "12.12.12.12"
      "event_type": "authentication"
      "factor": "duo_push"
      "reason": "endpoint_is_not_trusted"
      "result": "denied"
      "user":
        "name": "example@example.io"
    Name: endpoint_is_not_trusted
  - ExpectedResult: true
    Log:
      "access_device":
        "ip": "12.12.112.25"
        "os": "Mac OS X"
      "application": {}
      "auth_device":
        "ip": "12.12.12.12"
      "event_type": "authentication"
      "factor": "duo_push"
      "reason": "could_not_determine_if_endpoint_was_trusted"
      "result": "denied"
      "user":
        "name": "example@example.io"
    Name: could_not_determine_if_endpoint_was_trusted
  - ExpectedResult: true
    Log:
      "access_device":
        "ip": "12.12.112.25"
        "os": "Mac OS X"
      "application": {}
      "auth_device":
        "ip": "12.12.12.12"
      "event_type": "authentication"
      "factor": "duo_push"
      "reason": "invalid_device"
      "result": "denied"
      "user":
        "name": "example@example.io"
    Name: invalid_device
  - ExpectedResult: false
    Log:
      "access_device":
        "ip": "12.12.112.25"
        "os": "Mac OS X"
      "application":
        "key": "D12345"
        "name": "Slack"
      "auth_device":
        "ip": "12.12.12.12"
      "event_type": "authentication"
      "factor": "duo_push"
      "reason": "user_approved"
      "result": "success"
      "user":
        "name": "example@example.io"
    Name: good_auth
  - ExpectedResult: false
    Log:
      "access_device":
        "ip": "12.12.112.25"
        "os": "Mac OS X"
      "application":
        "key": "D12345"
        "name": "Slack"
      "auth_device":
        "ip": "12.12.12.12"
      "event_type": "authentication"
      "factor": "duo_push"
      "reason": "out_of_date"
      "result": "denied"
      "user":
        "name": "example@example.io"
    Name: denied_old_creds
