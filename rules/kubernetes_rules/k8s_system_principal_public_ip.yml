AnalysisType: rule
RuleID: "Kubernetes.System.Principal.PublicIP"
DisplayName: "Kubernetes System Principal Accessed from Non-Cloud Public IP"
Enabled: true
Status: Experimental
Filename: k8s_system_principal_public_ip.py
LogTypes:
  - Amazon.EKS.Audit
  - Azure.MonitorActivity
  - GCP.AuditLog
Tags:
  - Kubernetes
  - Initial Access
  - Lateral Movement
  - Credential Access
  - Unified Detection
Severity: High
Description: >
  This detection identifies when Kubernetes system principals (service accounts with usernames
  starting with "system:", "eks:", or "aks:") are accessed from non-cloud provider public IP
  addresses. System principals should only operate from within the cluster (private IPs) or
  from legitimate cloud infrastructure. Access from external public IPs indicates potential
  service account token theft or compromise, often following initial access to a cluster.
Runbook: |
  1. Find all Kubernetes API requests from the sourceIPs address in the 24 hours before and after the alert to identify targeted resources and operations
  2. Query for authentication and service account token events by this username in the 48 hours before the alert to determine if the token was recently compromised
  3. Search for other system principal alerts from the same sourceIPs address across all clusters in the past 7 days to assess campaign scope
Reference: https://kubernetes.io/docs/concepts/security/rbac-good-practices/
Reports:
  MITRE ATT&CK:
    - TA0001:T1190 # Initial Access: Exploit Public-Facing Application
    - TA0006:T1528 # Credential Access: Steal Application Access Token
    - TA0008:T1021.007 # Lateral Movement: Remote Services: Cloud Services
DedupPeriodMinutes: 60
SummaryAttributes:
  - username
  - p_any_ip_addresses
  - p_source_label
Tests:
  - Name: EKS System ServiceAccount from Non-AWS Public IP
    ExpectedResult: true
    Log:
      {
        "kind": "Event",
        "apiVersion": "audit.k8s.io/v1",
        "verb": "get",
        "user": {
          "username": "system:serviceaccount:kube-system:coredns",
          "groups": ["system:serviceaccounts", "system:authenticated"]
        },
        "sourceIPs": ["1.2.3.4"],
        "objectRef": {
          "resource": "endpointslices",
          "apiVersion": "v1"
        },
        "responseStatus": {"code": 200},
        "stage": "ResponseComplete",
        "p_log_type": "Amazon.EKS.Audit",
        "p_source_label": "eks-cluster",
        "p_enrichment": {
          "ipinfo_asn": {
            "sourceIPs": [{
              "asn": "AS12345",
              "domain": "example-isp.com",
              "name": "Example ISP",
              "p_match": "1.2.3.4",
              "type": "isp"
            }]
          }
        }
      }
  - Name: AKS System ServiceAccount from Non-Azure Public IP
    ExpectedResult: true
    Log:
      {
        "p_log_type": "Azure.MonitorActivity",
        "category": "kube-audit",
        "operationName": "Microsoft.ContainerService/managedClusters/diagnosticLogs/Read",
        "properties": {
          "log": "{\"kind\":\"Event\",\"apiVersion\":\"audit.k8s.io/v1\",\"verb\":\"list\",\"user\":{\"username\":\"system:serviceaccount:kube-system:metrics-server\",\"groups\":[\"system:serviceaccounts\",\"system:authenticated\"]},\"sourceIPs\":[\"8.8.8.8\"],\"objectRef\":{\"resource\":\"nodes\"},\"responseStatus\":{\"code\":200},\"stage\":\"ResponseComplete\"}"
        },
        "p_source_label": "aks-cluster",
        "p_enrichment": {
          "ipinfo_asn": {
            "sourceIPs": [{
              "asn": "AS15169",
              "domain": "google.com",
              "name": "Google LLC",
              "p_match": "8.8.8.8",
              "type": "hosting"
            }]
          }
        }
      }
  - Name: GKE System ServiceAccount from Non-GCP Public IP
    ExpectedResult: true
    Log:
      {
        "protoPayload": {
          "authenticationInfo": {"principalEmail": "system:serviceaccount:kube-system:default"},
          "methodName": "io.k8s.core.v1.pods.list",
          "requestMetadata": {
            "callerIP": "1.2.3.4",
            "callerSuppliedUserAgent": "kubectl/v1.27.0"
          },
          "resourceName": "core/v1/namespaces/default/pods",
          "serviceName": "k8s.io",
          "status": {}
        },
        "resource": {
          "type": "k8s_cluster",
          "labels": {"project_id": "test-project"}
        },
        "p_log_type": "GCP.AuditLog",
        "p_source_label": "gke-cluster",
        "p_enrichment": {
          "ipinfo_asn": {
            "callerIP": [{
              "asn": "AS12345",
              "domain": "example-isp.com",
              "name": "Example ISP",
              "p_match": "1.2.3.4",
              "type": "isp"
            }]
          }
        }
      }
  - Name: EKS Legitimate Node from AWS IP
    ExpectedResult: false
    Log:
      {
        "kind": "Event",
        "apiVersion": "audit.k8s.io/v1",
        "verb": "create",
        "user": {
          "username": "system:node:ip-192-168-3-178.us-west-2.compute.internal",
          "groups": ["system:nodes", "system:authenticated"]
        },
        "sourceIPs": ["54.212.83.236"],
        "objectRef": {
          "resource": "serviceaccounts",
          "subresource": "token"
        },
        "responseStatus": {"code": 201},
        "stage": "ResponseComplete",
        "p_log_type": "Amazon.EKS.Audit",
        "p_source_label": "eks-cluster",
        "p_enrichment": {
          "ipinfo_asn": {
            "sourceIPs": [{
              "asn": "AS16509",
              "domain": "amazon.com",
              "name": "Amazon.com, Inc.",
              "p_match": "54.212.83.236",
              "route": "54.212.0.0/16",
              "type": "hosting"
            }]
          }
        }
      }
  - Name: EKS addon-manager from AWS Lambda
    ExpectedResult: false
    Log:
      {
        "kind": "Event",
        "verb": "get",
        "user": {
          "username": "eks:addon-manager",
          "extra": {
            "arn": ["arn:aws:sts::123412341234:assumed-role/AWSWesleyClusterManagerLambda-Add-AddonManagerRole/session"]
          },
          "groups": ["system:authenticated"]
        },
        "sourceIPs": ["35.163.244.48"],
        "objectRef": {"resource": "deployments", "namespace": "kube-system"},
        "responseStatus": {"code": 200},
        "stage": "ResponseComplete",
        "p_log_type": "Amazon.EKS.Audit"
      }
  - Name: Non-System User from Public IP
    ExpectedResult: false
    Log:
      {
        "kind": "Event",
        "verb": "get",
        "user": {"username": "admin@example.com"},
        "sourceIPs": ["1.2.3.4"],
        "objectRef": {"resource": "pods"},
        "responseStatus": {"code": 200},
        "stage": "ResponseComplete",
        "p_log_type": "Amazon.EKS.Audit"
      }
  - Name: System User from Private IP
    ExpectedResult: false
    Log:
      {
        "kind": "Event",
        "verb": "watch",
        "user": {"username": "system:serviceaccount:kube-system:coredns"},
        "sourceIPs": ["10.0.27.115"],
        "objectRef": {"resource": "endpointslices"},
        "responseStatus": {"code": 200},
        "stage": "ResponseComplete",
        "p_log_type": "Amazon.EKS.Audit"
      }
  - Name: 403 Response (Excluded)
    ExpectedResult: false
    Log:
      {
        "kind": "Event",
        "verb": "get",
        "user": {"username": "system:serviceaccount:default:test"},
        "sourceIPs": ["1.2.3.4"],
        "objectRef": {"resource": "secrets"},
        "responseStatus": {"code": 403},
        "stage": "ResponseComplete",
        "p_log_type": "Amazon.EKS.Audit"
      }