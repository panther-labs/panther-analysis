AnalysisType: rule
Description: >-
  Alerts when users exec into pod. Possible to specify specific projects and allowed
  users.
DisplayName: "Exec into Pod"
Enabled: false
Filename: gcp_k8s_exec_into_pod.py
LogTypes:
  - GCP.AuditLog
Reference: 
  https://cloud.google.com/migrate/containers/docs/troubleshooting/executing-shell-commands
RuleID: "GCP.K8s.ExecIntoPod"
Runbook: >-
  Investigate the user and determine why. Advise that it is discouraged practice.
  Create ticket if appropriate.
Severity: Medium
Tags:
  - GCP
  - Security Control
  - Configuration Required
Tests:
  - ExpectedResult: true
    Log:
      "protoPayload":
        "authenticationInfo":
          "principalEmail": "disallowed.user@example.com"
        "authorizationInfo":
          - "permission": "io.k8s.core.v1.pods.exec.create"
            "resource": "core/v1/namespaces/example/pods/example-57998cf7c5-bjkfk/exec"
        "methodName": "io.k8s.core.v1.pods.exec.create"
        "requestMetadata":
          "callerIp": "88.88.88.88"
          "callerSuppliedUserAgent": "kubectl/v1.40.8 (darwin/amd64) kubernetes/6575935"
        "resourceName": "core/v1/namespaces/example/pods/one-off-valerii-tovstyk-1646666967280/exec"
        "timestamp": "2022-03-04T16:01:49.978756Z"
      "resource":
        "labels":
          "project_id": "rigup-production"
        "type": "k8s_cluster"
    Name: Disallowed User
  - ExpectedResult: true
    Log:
      "protoPayload":
        "authenticationInfo":
          "principalEmail": "example-allowed-user@example.com"
        "authorizationInfo":
          - "permission": "io.k8s.core.v1.pods.exec.create"
            "resource": "core/v1/namespaces/istio-system/pods/opa-57998cf7c5-bjkfk/exec"
        "methodName": "io.k8s.core.v1.pods.exec.create"
        "requestMetadata":
          "callerIp": "88.88.88.88"
          "callerSuppliedUserAgent": "kubectl/v1.40.8 (darwin/amd64) kubernetes/6575935"
        "resourceName": "core/v1/namespaces/istio-system/pods/one-off-valerii-tovstyk-1646666967280/exec"
        "timestamp": "2022-03-04T16:01:49.978756Z"
      "resource":
        "labels":
          "project_id": "rigup-production"
        "type": "k8s_cluster"
    Name: Disallowed User2 - not an allowed namespace
