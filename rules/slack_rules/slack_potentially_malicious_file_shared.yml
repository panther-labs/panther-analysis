AnalysisType: rule
Filename: slack_potentially_malicious_file_shared.py
RuleID: "Slack.AuditLogs.PotentiallyMaliciousFileShared"
DisplayName: "Slack Potentially Malicious File Shared"
Enabled: true
LogTypes:
  - Slack.AuditLogs
Tags:
  - Slack
  - Initial Access
  - Phishing
  - Spearphishing Attachment
  - Malware
  - Execution
Reports:
  MITRE ATT&CK:
    - TA0001:T1566.001
    - TA0002:T1204.002
    - TA0040:T1486
Severity: Critical
Description: >
  Detects when Slack's automated security scanning identifies and flags a file uploaded to the workspace as containing potentially malicious content, indicating an active malware delivery or phishing attempt within internal communications. Slack performs automated security scanning on all uploaded files using threat intelligence feeds, malware signature databases, and heuristic analysis to detect known malicious files including executable malware (trojans, remote access tools, keyloggers), ransomware payloads, phishing documents with malicious macros or embedded links, scripts designed to execute malicious code (PowerShell, VBS, JavaScript), infected Office documents with exploit code, and files matching signatures of known threat actor campaigns. When Slack detects malicious content, it generates the file_malicious_content_detected audit event, blocks the file from being downloaded (on Enterprise Grid plans), and alerts workspace administrators to investigate. This detection represents a critical security event because it indicates either a compromised user account being used to distribute malware within the organization, an insider threat intentionally sharing malicious files, an external attacker who has gained access to the workspace and is attempting lateral movement or ransomware deployment, a successful phishing attack where the victim uploaded a malicious file received via external email, or accidental upload of infected files from a compromised endpoint. If users download and execute the malicious file before detection or if Slack's blocking fails, it could result in endpoint compromise with credential theft, keystroke logging, screen capture, or system takeover, ransomware deployment encrypting corporate data and demanding payment, lateral movement with malware spreading to other systems via the user's network access, data exfiltration through malware command and control channels, or persistence mechanisms allowing long-term unauthorized access. The severity is heightened because Slack is trusted internal infrastructure, so users may be more likely to download and execute files shared by colleagues without scrutiny compared to external email attachments. Immediate investigation is required to identify the source of the malicious file, determine if the uploader's account or endpoint is compromised, assess whether any users downloaded the file before detection, perform malware analysis to understand capabilities and indicators of compromise, and hunt for additional malicious activity in the workspace.
Reference: https://docs.datadoghq.com/security/default_rules/def-003-oxv/
Runbook: |
  1. Query Slack audit logs for file_downloaded events associated with the malicious file to identify all users who downloaded it before Slack detected the threat, then coordinate with IT to isolate their endpoints and scan for malware
  2. Review actor.user.email's complete Slack audit log activity in the 7 days before the upload to identify suspicious patterns such as logins from unusual locations, sharing multiple suspicious files, or mass direct messaging indicating account compromise
  3. Search the Slack workspace for other files with similar names, file types, or uploaded from the same context.ip_address to determine if this is part of a broader malware distribution campaign
DedupPeriodMinutes: 60
Threshold: 1
SummaryAttributes:
  - p_any_ip_addresses
  - p_any_emails
Tests:
  - Name: Malicious Content Detected
    ExpectedResult: true
    Log:
      {
        "action": "file_malicious_content_detected",
        "actor":
          {
            "type": "user",
            "user":
              {
                "email": "user@example.com",
                "id": "W012J3FEWAU",
                "name": "primary-owner",
                "team": "T01234N56GB",
              },
          },
        "context":
          {
            "ip_address": "1.2.3.4",
            "location":
              {
                "domain": "test-workspace-1",
                "id": "T01234N56GB",
                "name": "test-workspace-1",
                "type": "workspace",
              },
            "ua": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36",
          },
      }
  - Name: User Logout
    ExpectedResult: false
    Log:
      {
        "action": "user_logout",
        "actor":
          {
            "type": "user",
            "user":
              {
                "email": "user@example.com",
                "id": "W012J3FEWAU",
                "name": "primary-owner",
                "team": "T01234N56GB",
              },
          },
        "context":
          {
            "ip_address": "1.2.3.4",
            "location":
              {
                "domain": "test-workspace-1",
                "id": "T01234N56GB",
                "name": "test-workspace-1",
                "type": "workspace",
              },
            "ua": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36",
          },
        "date_create": "2022-07-28 15:22:32",
        "entity":
          {
            "type": "user",
            "user":
              {
                "email": "user@example.com",
                "id": "W012J3FEWAU",
                "name": "primary-owner",
                "team": "T01234N56GB",
              },
          },
        "id": "72cac009-9eb3-4dde-bac6-ee49a32a1789",
      }
