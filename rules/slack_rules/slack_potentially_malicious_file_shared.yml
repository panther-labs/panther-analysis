AnalysisType: rule
Filename: slack_potentially_malicious_file_shared.py
RuleID: "Slack.AuditLogs.PotentiallyMaliciousFileShared"
DisplayName: "Slack Potentially Malicious File Shared"
Enabled: true
LogTypes:
  - Slack.AuditLogs
Tags:
  - Slack
  - Initial Access
  - Phishing
  - Spearphishing Attachment
  - Malware
  - Execution
Reports:
  MITRE ATT&CK:
    - TA0001:T1566.001
    - TA0002:T1204.002
    - TA0040:T1486
Severity: Critical
Description: >
  Detects when Slack's automated security scanning identifies and flags a file uploaded to the workspace as containing potentially malicious content, indicating an active malware delivery or phishing attempt within internal communications. Slack performs automated security scanning on all uploaded files using threat intelligence feeds, malware signature databases, and heuristic analysis to detect known malicious files including executable malware (trojans, remote access tools, keyloggers), ransomware payloads, phishing documents with malicious macros or embedded links, scripts designed to execute malicious code (PowerShell, VBS, JavaScript), infected Office documents with exploit code, and files matching signatures of known threat actor campaigns. When Slack detects malicious content, it generates the file_malicious_content_detected audit event, blocks the file from being downloaded (on Enterprise Grid plans), and alerts workspace administrators to investigate. This detection represents a critical security event because it indicates either a compromised user account being used to distribute malware within the organization, an insider threat intentionally sharing malicious files, an external attacker who has gained access to the workspace and is attempting lateral movement or ransomware deployment, a successful phishing attack where the victim uploaded a malicious file received via external email, or accidental upload of infected files from a compromised endpoint. If users download and execute the malicious file before detection or if Slack's blocking fails, it could result in endpoint compromise with credential theft, keystroke logging, screen capture, or system takeover, ransomware deployment encrypting corporate data and demanding payment, lateral movement with malware spreading to other systems via the user's network access, data exfiltration through malware command and control channels, or persistence mechanisms allowing long-term unauthorized access. The severity is heightened because Slack is trusted internal infrastructure, so users may be more likely to download and execute files shared by colleagues without scrutiny compared to external email attachments. Immediate investigation is required to identify the source of the malicious file, determine if the uploader's account or endpoint is compromised, assess whether any users downloaded the file before detection, perform malware analysis to understand capabilities and indicators of compromise, and hunt for additional malicious activity in the workspace.
Reference: https://docs.datadoghq.com/security/default_rules/def-003-oxv/
Runbook: |
  1. Immediately identify the user who uploaded the malicious file (check actor.user.email and actor.user.name), the workspace where it was shared (context.location.domain), the channel or direct message where the file was posted, and the file name and type from the entity details in the alert to understand the scope and nature of the threat
  2. Contact the user who uploaded the file through a secure out-of-band communication channel (phone call, in-person, alternative messaging platform) to determine if they intentionally uploaded this file, recognize it as malicious, or if their account or endpoint may be compromised by asking when they last used their device, if they downloaded anything suspicious recently, or if they noticed unusual system behavior
  3. Immediately use Slack Admin tools to delete the malicious file from all channels and conversations where it was shared, check the file's share history to identify all users who may have had access, and send urgent notifications to any users who were in channels where the file was posted warning them NOT to download or open the file
  4. Investigate whether any users actually downloaded the malicious file before Slack detected it by querying Slack audit logs for file_downloaded events associated with the malicious file ID, and if any users downloaded it, immediately contact their IT/security team to isolate their endpoints, run antivirus/EDR scans, check for indicators of compromise, and potentially reimage systems if malware execution is confirmed
  5. Assess if the uploader's account is compromised by reviewing their complete Slack audit log activity for the past 7 days looking for suspicious patterns such as logins from unusual locations or IP addresses, access during abnormal hours, sharing of multiple suspicious files, direct messages to many users (potential worm behavior), password changes, or API token creation that might indicate account takeover
  6. Investigate the uploader's endpoint security status by coordinating with IT to check their device's EDR/antivirus logs for malware detections, unauthorized software installations, suspicious network connections, persistence mechanisms, or other compromise indicators, and consider forcing a full system scan or endpoint isolation if compromise is suspected
  7. Obtain the malicious file for analysis by working with Slack support to retrieve a copy (if Slack blocked it) or extracting it from logs/backups, then submit it to your malware analysis sandbox or threat intelligence platform to identify the malware family (ransomware, trojan, RAT), capabilities (credential theft, encryption, command and control), associated threat actor, and indicators of compromise (file hashes, C2 domains, registry keys) for threat hunting
  8. Hunt across the entire Slack workspace for other instances of the same or similar malicious files by searching for files with matching hashes, similar filenames, files uploaded by the same compromised user, or files uploaded from the same IP address to determine if this is an isolated incident or part of a broader campaign affecting multiple users
  9. Determine the infection vector by investigating how the malicious file entered the workspace: check the uploader's email for phishing messages with malicious attachments, review their browser history for drive-by downloads, analyze their Slack direct messages for social engineering attempts, or check for compromised external file sharing integrations (Google Drive, OneDrive) that might have delivered the malware
  10. Document the incident including who uploaded the file, the malware type and capabilities, which users were potentially exposed, whether any endpoints were infected, the infection vector, and all remediation actions taken, then notify executive leadership, information security teams, and potentially legal/compliance depending on data breach risk, implement user security awareness training specifically about malware in collaboration tools, consider enabling stricter file upload policies in Slack (restrict executable file types), and enhance monitoring for future file_malicious_content_detected events with automated incident response workflows
DedupPeriodMinutes: 60
Threshold: 1
SummaryAttributes:
  - p_any_ip_addresses
  - p_any_emails
Tests:
  - Name: Malicious Content Detected
    ExpectedResult: true
    Log:
      {
        "action": "file_malicious_content_detected",
        "actor":
          {
            "type": "user",
            "user":
              {
                "email": "user@example.com",
                "id": "W012J3FEWAU",
                "name": "primary-owner",
                "team": "T01234N56GB",
              },
          },
        "context":
          {
            "ip_address": "1.2.3.4",
            "location":
              {
                "domain": "test-workspace-1",
                "id": "T01234N56GB",
                "name": "test-workspace-1",
                "type": "workspace",
              },
            "ua": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36",
          },
      }
  - Name: User Logout
    ExpectedResult: false
    Log:
      {
        "action": "user_logout",
        "actor":
          {
            "type": "user",
            "user":
              {
                "email": "user@example.com",
                "id": "W012J3FEWAU",
                "name": "primary-owner",
                "team": "T01234N56GB",
              },
          },
        "context":
          {
            "ip_address": "1.2.3.4",
            "location":
              {
                "domain": "test-workspace-1",
                "id": "T01234N56GB",
                "name": "test-workspace-1",
                "type": "workspace",
              },
            "ua": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.0.0 Safari/537.36",
          },
        "date_create": "2022-07-28 15:22:32",
        "entity":
          {
            "type": "user",
            "user":
              {
                "email": "user@example.com",
                "id": "W012J3FEWAU",
                "name": "primary-owner",
                "team": "T01234N56GB",
              },
          },
        "id": "72cac009-9eb3-4dde-bac6-ee49a32a1789",
      }
