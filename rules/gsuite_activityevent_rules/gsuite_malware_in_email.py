# Malware family type mapping based on Google Workspace Gmail schema
# Reference: https://support.google.com/a/answer/12384955
MALWARE_FAMILY_TYPES = {
    1: "Known malicious program",
    2: "Virus or worm",
    3: "Possible harmful message content",
    4: "Possible unwanted message content",
    5: "Other malware type",
}


def rule(event):
    if event.deep_get("id", "applicationName", default="<UNKNOWN_APPLICATION>") != "gmail":
        return False

    # Check if malware was detected in the message
    malware_family = event.deep_get(
        "parameters", "message_info", "attachment", "malware_family", default=None
    )

    return malware_family is not None


def title(event):
    user = event.deep_get("actor", "email", default="<UNKNOWN_USER>")
    malware_family = event.deep_get(
        "parameters", "message_info", "attachment", "malware_family", default=0
    )
    malware_type = MALWARE_FAMILY_TYPES.get(malware_family, f"Unknown Type ({malware_family})")
    malware_sha256 = event.deep_get(
        "parameters", "message_info", "attachment", "sha256", default="<UNKNOWN_SHA256>"
    )

    return (
        f"Malicious attachment of type [{malware_type}] "
        f"with SHA256 [{malware_sha256}] "
        f"detected in email to [{user}]"
    )


def alert_context(event):
    malware_family = event.deep_get(
        "parameters", "message_info", "attachment", "malware_family", default=0
    )
    malware_sha256 = event.deep_get(
        "parameters", "message_info", "attachment", "sha256", default="<UNKNOWN_SHA256>"
    )
    filename = event.deep_get(
        "parameters", "message_info", "attachment", "file_name", default="<UNKNOWN_FILENAME>"
    )
    context = {
        "recipient": event.deep_get("actor", "email", default="<UNKNOWN_USER>"),
        "malware_family_code": malware_family,
        "malware_type": MALWARE_FAMILY_TYPES.get(malware_family, "Unknown"),
        "source_ip": event.get("ipAddress"),
        "sha256": malware_sha256,
        "filename": filename,
    }

    return context
