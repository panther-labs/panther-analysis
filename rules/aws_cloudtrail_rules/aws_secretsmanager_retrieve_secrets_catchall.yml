AnalysisType: rule
DedupPeriodMinutes: 1440
Description: >-
  An attacker attempted to retrieve a high number of Secrets Manager secrets by batch,
  through secretsmanager:BatchGetSecretValue (released Novemeber 2023).  An attacker
  may attempt to retrieve a high number of secrets by batch, to avoid detection and
  generate fewer calls. Note that the batch size is limited to 20 secrets. Although
  BatchGetSecretValue requires a list of secret IDs or a filter, an attacker may use
  a catch-all filter to retrieve all secrets by batch. This rule identifies BatchGetSecretValue
  events with a catch-all filter.
DisplayName: "AWS Secrets Manager Batch Retrieve Secrets Catch-All"
Enabled: true
Filename: aws_secretsmanager_retrieve_secrets_catchall.py
LogTypes:
  - AWS.CloudTrail
Reference: 
  https://stratus-red-team.cloud/attack-techniques/AWS/aws.credential-access.secretsmanager-batch-retrieve-secrets/
Reports:
  MITRE ATT&CK:
    - TA0006:T1552
RuleID: "AWS.SecretsManager.BatchRetrieveSecretsCatchAll"
Runbook: >-
  https://aws.amazon.com/blogs/security/how-to-use-the-batchgetsecretsvalue-api-to-improve-your-client-side-applications-with-aws-secrets-manager/
Severity: Info
SummaryAttributes:
  - eventName
  - userAgent
  - sourceIpAddress
  - recipientAccountId
  - p_any_aws_arns
Tags:
  - AWS
  - Credential Access
  - Stratus Red Team
  - Beta
Tests:
  - ExpectedResult: true
    Log:
      "eventName": "BatchGetSecretValue"
      "eventSource": "secretsmanager.amazonaws.com"
      "eventType": "AwsApiCall"
      "managementEvent": true
      "readOnly": true
      "recipientAccountId": "012345678901"
      "requestParameters":
        "filters":
          - "key": "tag-key"
            "values":
              - "!tagKeyThatWillNeverExist"
      "responseElements":
    Name: BatchGetSecretValue Catch-All
  - ExpectedResult: false
    Log:
      "eventName": "BatchGetSecretValue"
      "eventSource": "secretsmanager.amazonaws.com"
      "eventType": "AwsApiCall"
      "managementEvent": true
      "readOnly": true
      "recipientAccountId": "012345678901"
      "requestParameters":
        "filters":
          - "key": "tag-key"
            "values":
              - "!tagKeyThatWillNeverExist"
          - "key": "tag-key"
            "values":
              - "tagThatExists"
      "responseElements":
    Name: BatchGetSecretValue Catch-All with other filters
Threshold: 1
