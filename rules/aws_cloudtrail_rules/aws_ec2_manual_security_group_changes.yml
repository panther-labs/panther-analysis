AnalysisType: rule
Description: >-
  An EC2 security group was manually updated without abiding by the organization's
  accepted processes. This rule expects organizations to either use the Console, CloudFormation,
  or Terraform, configurable in the rule's ALLOWED_USER_AGENTS.
DisplayName: "AWS EC2 Manual Security Group Change"
Enabled: false
Filename: aws_ec2_manual_security_group_changes.py
LogTypes:
  - AWS.CloudTrail
Reference: 
  https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/working-with-security-groups.html
Reports:
  MITRE ATT&CK:
    - TA0005:T1562
RuleID: "AWS.EC2.ManualSecurityGroupChange"
Runbook: >-
  Identify the actor who changed the security group and validate it was legitimate
Severity: Medium
Tags:
  - AWS
  - Security Control
  - Configuration Required
  - Defense Evasion:Impair Defenses
Tests:
  - ExpectedResult: true
    Log:
      "awsRegion": "us-west-2"
      "eventID": "504b492f-7832-406b-a4fd-45a13e48adc4"
      "eventName": "AuthorizeSecurityGroupIngress"
      "eventSource": "ec2.amazonaws.com"
      "eventTime": "2021-01-24 04:55:45.000"
      "eventType": "AwsApiCall"
      "eventVersion": "1.08"
      "managementEvent": true
      "p_any_aws_account_ids":
        - "112233445566"
      "p_any_aws_arns":
        - "arn:aws:iam::112233445566:role/TestAdmin"
        - " arn:aws:sts::112233445566:assumed-role/TestAdmin/alan"
      "p_any_ip_addresses":
        - "136.25.37.134"
      "p_event_time": "2021-01-24 04:55:45.000"
      "p_log_type": "AWS.CloudTrail"
      "p_parse_time": "2021-01-24 05:02:58.358"
      "p_row_id": "1a57ff7ade26aaf5a1a4d7d20775"
      "p_source_id": "e55677c6-7ef5-4541-a443-0d0f17eec19f"
      "p_source_label": "CloudTrail Test"
      "readOnly": false
      "recipientAccountId": "112233445566"
      "requestID": "91f34d65-513d-4e9f-a3de-e8d27f7ee4b2"
      "requestParameters":
        "groupId": "sg-04f0b44316f7d2471"
        "ipPermissions":
          "items":
            - "fromPort": "443"
              "groups": {}
              "ipProtocol": "tcp"
              "ipRanges":
                "items":
                  - "cidrIp": "0.0.0.0/16"
              "ipv6Ranges": {}
              "prefixListIds": {}
              "toPort": "443"
      "responseElements":
        "_return": true
        "requestId": "91f34d65-513d-4e9f-a3de-e8d27f7ee4b2"
      "sourceIPAddress": "136.25.37.134"
      "userAgent": "console.ec2.amazonaws.com"
      "userIdentity":
        "accesskeyid": "ASIASWJRT64Z7ZLFLJNI"
        "accountid": "112233445566"
        "arn": "arn:aws:sts::112233445566:assumed-role/TestAdmin/alan"
        "principalid": "ARORJ4ULULLE0EEJAAKDO:alan"
        "sessioncontext":
          "attributes":
            "creationdate": "2021-01-24T04:55:10Z"
            "mfaauthenticated": "true"
          "sessionissuer":
            "accountid": "112233445566"
            "arn": "arn:aws:iam::112233445566:role/TestAdmin"
            "principalid": "ARORJ4ULULLE0EEJAAKDO"
            "type": "Role"
            "username": "TestAdmin"
        "type": "AssumedRole"
    LogType: AWS.CloudTrail
    Name: AWS Console - Ingress SG Authorization
  - ExpectedResult: false
    Log:
      "awsRegion": "us-east-1"
      "eventID": "52601748-2659-4ed8-b5fd-c530547b07ec"
      "eventName": "CreateSecurityGroup"
      "eventSource": "ec2.amazonaws.com"
      "eventTime": "2020-04-30T23:51:06Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.05"
      "recipientAccountId": "112233445566"
      "requestID": "594fe3e3-0f74-4085-9336-189b36a1cd8c"
      "requestParameters":
        "groupDescription": "prod-webapp-webserver Security SG"
        "groupName": "prod-webapp-webserver-security"
        "vpcId": "vpc-a1a044c7"
      "responseElements":
        "_return": true
        "groupId": "sg-04d018d184a18f647"
        "requestId": "594fe3e3-0f74-4085-9336-189b36a1cd8c"
      "sourceIPAddress": "100.1.114.142"
      "userAgent": "aws-sdk-go/1.29.7 (go1.13.7; darwin; amd64) APN/1.0 HashiCorp/1.0
        Terraform/0.12.24 (+https://www.terraform.io)"
      "userIdentity":
        "accessKeyId": "ASIAWDWBPTM3RJH7XXXX"
        "accountId": "112233445566"
        "arn": "arn:aws:sts::112233445566:assumed-role/Operator/ryan@example.com"
        "principalId": "AROAIZCYMDBM4SJU6XXXX:ryan@example.com"
        "sessionContext":
          "attributes":
            "creationDate": "2020-04-30T23:50:12Z"
            "mfaAuthenticated": "false"
          "sessionIssuer":
            "accountId": "112233445566"
            "arn": "arn:aws:iam::112233445566:role/Operator"
            "principalId": "AROAIZCYMDBM4SJU65M54"
            "type": "Role"
            "userName": "Operator"
          "webIdFederationData": {}
        "type": "AssumedRole"
    LogType: AWS.CloudTrail
    Name: Terraform Security Group Creation
  - ExpectedResult: false
    Log:
      "awsRegion": "us-east-1"
      "eventID": "1a593035-e072-49c4-8c72-4ff35e195330"
      "eventName": "AuthorizeSecurityGroupEgress"
      "eventSource": "ec2.amazonaws.com"
      "eventTime": "2020-04-30T23:51:08Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.05"
      "recipientAccountId": "112233445566"
      "requestID": "4c7a5036-09d3-46e8-b0b6-f611ff1959a6"
      "requestParameters":
        "groupId": "sg-03eee825d6bb78f54"
        "ipPermissions":
          "items":
            - "groups": {}
              "ipProtocol": "-1"
              "ipRanges":
                "items":
                  - "cidrIp": "0.0.0.0/0"
                    "description": "Allow egress to the internet. Required for now
                      until we land ECS/ECR endpoints in the VPC"
              "ipv6Ranges": {}
              "prefixListIds": {}
      "responseElements":
        "_return": true
        "requestId": "4c7a5036-09d3-46e8-b0b6-f611ff1959a6"
      "sourceIPAddress": "100.1.114.142"
      "userAgent": "aws-sdk-go/1.29.7 (go1.13.7; darwin; amd64) APN/1.0 HashiCorp/1.0
        Terraform/0.12.24 (+https://www.terraform.io)"
      "userIdentity":
        "accessKeyId": "ASIAWDWBPTM3RJH7XXXX"
        "accountId": "112233445566"
        "arn": "arn:aws:sts::112233445566:assumed-role/ContinousDeployment/ryan@example.com"
        "principalId": "AROAIZCYMDBM4SJU65M54:ryan@example.com"
        "sessionContext":
          "attributes":
            "creationDate": "2020-04-30T23:50:12Z"
            "mfaAuthenticated": "false"
          "sessionIssuer":
            "accountId": "112233445566"
            "arn": "arn:aws:iam::112233445566:role/Operator"
            "principalId": "AROAIZCYMDBM4SJU65M54"
            "type": "Role"
            "userName": "Operator"
          "webIdFederationData": {}
        "type": "AssumedRole"
    LogType: AWS.CloudTrail
    Name: Terraform Security Group Authorize Egress
  - ExpectedResult: true
    Log:
      "awsRegion": "us-east-1"
      "eventID": "42155429-7e8e-43b5-9b5e-6953f80d51d5"
      "eventName": "AuthorizeSecurityGroupIngress"
      "eventSource": "ec2.amazonaws.com"
      "eventTime": "2020-04-30T04:40:52Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.05"
      "recipientAccountId": "112233445566"
      "requestID": "2be70b99-4937-4a76-b7d9-390b6d0eda73"
      "requestParameters":
        "groupId": "sg-0d921df5d84f7270a"
        "ipPermissions":
          "items":
            - "fromPort": 22
              "groups": {}
              "ipProtocol": "tcp"
              "ipRanges":
                "items":
                  - "cidrIp": "0.0.0.0/0"
              "ipv6Ranges": {}
              "prefixListIds": {}
              "toPort": 22
      "responseElements":
        "_return": true
        "requestId": "2be70b99-4937-4a76-b7d9-390b6d0eda73"
      "sourceIPAddress": "100.1.114.142"
      "userAgent": "aws-sdk-go/1.24.1 (go1.14; darwin; amd64)"
      "userIdentity":
        "accessKeyId": "ASIAWDWBPTM3QPXQXXXX"
        "accountId": "112233445566"
        "arn": "arn:aws:sts::112233445566:assumed-role/Operator/ryan@example.com"
        "principalId": "AROAIZCYMDBM4SJU65M54:ryan@example.com"
        "sessionContext":
          "attributes":
            "creationDate": "2020-04-30T04:37:13Z"
            "mfaAuthenticated": "false"
          "sessionIssuer":
            "accountId": "112233445566"
            "arn": "arn:aws:iam::112233445566:role/Operator"
            "principalId": "AROAIZCYMDBM4SJU65M54"
            "type": "Role"
            "userName": "Operator"
          "webIdFederationData": {}
        "type": "AssumedRole"
    LogType: AWS.CloudTrail
    Name: Go Script Authorize Ingress
  - ExpectedResult: false
    Log:
      "awsRegion": "us-west-2"
      "errorCode": "UnauthorizedOperation"
      "eventID": "504b492f-7832-406b-a4fd-45a13e48adc4"
      "eventName": "AuthorizeSecurityGroupIngress"
      "eventSource": "ec2.amazonaws.com"
      "eventTime": "2021-01-24 04:55:45.000"
      "eventType": "AwsApiCall"
      "eventVersion": "1.08"
      "managementEvent": true
      "p_any_aws_account_ids":
        - "112233445566"
      "p_any_aws_arns":
        - "arn:aws:iam::112233445566:role/TestAdmin"
        - " arn:aws:sts::112233445566:assumed-role/TestAdmin/alan"
      "p_any_ip_addresses":
        - "136.25.37.134"
      "p_event_time": "2021-01-24 04:55:45.000"
      "p_log_type": "AWS.CloudTrail"
      "p_parse_time": "2021-01-24 05:02:58.358"
      "p_row_id": "1a57ff7ade26aaf5a1a4d7d20775"
      "p_source_id": "e55677c6-7ef5-4541-a443-0d0f17eec19f"
      "p_source_label": "CloudTrail Test"
      "readOnly": false
      "recipientAccountId": "112233445566"
      "requestID": "91f34d65-513d-4e9f-a3de-e8d27f7ee4b2"
      "requestParameters":
        "groupId": "sg-04f0b44316f7d2471"
        "ipPermissions":
          "items":
            - "fromPort": "443"
              "groups": {}
              "ipProtocol": "tcp"
              "ipRanges":
                "items":
                  - "cidrIp": "0.0.0.0/16"
              "ipv6Ranges": {}
              "prefixListIds": {}
              "toPort": "443"
      "responseElements":
        "_return": true
        "requestId": "91f34d65-513d-4e9f-a3de-e8d27f7ee4b2"
      "sourceIPAddress": "136.25.37.134"
      "userAgent": "console.ec2.amazonaws.com"
      "userIdentity":
        "accesskeyid": "ASIASWJRT64Z7ZLFLJNI"
        "accountid": "112233445566"
        "arn": "arn:aws:sts::112233445566:assumed-role/TestAdmin/alan"
        "principalid": "ARORJ4ULULLE0EEJAAKDO:alan"
        "sessioncontext":
          "attributes":
            "creationdate": "2021-01-24T04:55:10Z"
            "mfaauthenticated": "true"
          "sessionissuer":
            "accountid": "112233445566"
            "arn": "arn:aws:iam::112233445566:role/TestAdmin"
            "principalid": "ARORJ4ULULLE0EEJAAKDO"
            "type": "Role"
            "username": "TestAdmin"
        "type": "AssumedRole"
    LogType: AWS.CloudTrail
    Name: AWS Console - Ingress SG Authorization Error
