AnalysisType: rule
Description: >-
  An RDS snapshot was shared with another account. This could be an indicator of exfiltration.
DisplayName: "AWS RDS Snapshot Shared"
Enabled: true
Filename: aws_rds_snapshot_shared.py
LogTypes:
  - AWS.CloudTrail
Reference: https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ShareSnapshot.html
Reports:
  MITRE ATT&CK:
    - TA0010:T1537
RuleID: "AWS.RDS.SnapshotShared"
Runbook: >-
  Ensure that the snapshot was shared intentionally and with an approved account.
  If not, remove the snapshot and quarantine the compromised IAM user.
Severity: High
SummaryAttributes:
  - eventSource
  - recipientAccountId
  - awsRegion
  - p_any_aws_arns
Tags:
  - AWS
  - Exfiltration
  - Transfer Data to Cloud Account
Tests:
  - ExpectedResult: true
    Log:
      "awsRegion": "us-west-2"
      "eventCategory": "Management"
      "eventID": "86581591-0f39-4eae-9a8d-b2224a3c91fa"
      "eventName": "ModifyDBSnapshotAttribute"
      "eventSource": "rds.amazonaws.com"
      "eventTime": "2023-12-12T20:12:22Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.08"
      "managementEvent": true
      "readOnly": false
      "recipientAccountId": "123456789012"
      "requestID": "b7f91314-eb8b-4be5-995d-6b97d70dfb3b"
      "requestParameters":
        "attributeName": "restore"
        "dBSnapshotIdentifier": "exfiltration"
        "valuesToAdd":
          - "193672423079"
      "responseElements":
        "dBSnapshotAttributes":
          - "attributeName": "restore"
            "attributeValues":
              - "193672423079"
        "dBSnapshotIdentifier": "exfiltration"
      "sourceIPAddress": "1.2.3.4"
      "tlsDetails":
        "cipherSuite": "TLS_AES_128_GCM_SHA256"
        "clientProvidedHostHeader": "rds.us-west-2.amazonaws.com"
        "tlsVersion": "TLSv1.3"
      "userAgent": "68319f60-9dec-43b2-9702-de3a08c9d8a3"
      "userIdentity":
        "accessKeyId": "ASIAFFA5AFEC02FFCD8ED"
        "accountId": "123456789012"
        "arn": "arn:aws:sts::123456789012:assumed-role/AWSReservedSSO_DevAdmin_635426549a280cc6/fake.user"
        "principalId": "AROA2DFDF0C1FDFCAD2B2:fake.user"
        "sessionContext":
          "attributes":
            "creationDate": "2023-12-12T19:43:57Z"
            "mfaAuthenticated": "false"
          "sessionIssuer":
            "accountId": "123456789012"
            "arn": "arn:aws:iam::123456789012:role/aws-reserved/sso.amazonaws.com/us-west-2/AWSReservedSSO_DevAdmin_635426549a280cc6"
            "principalId": "AROA2DFDF0C1FDFCAD2B2"
            "type": "Role"
            "userName": "AWSReservedSSO_DevAdmin_635426549a280cc6"
          "webIdFederationData": {}
        "type": "AssumedRole"
    Name: Snapshot shared with another account
  - ExpectedResult: false
    Log:
      "awsRegion": "us-west-2"
      "eventCategory": "Management"
      "eventID": "86581591-0f39-4eae-9a8d-b2224a3c91fa"
      "eventName": "ModifyDBSnapshotAttribute"
      "eventSource": "rds.amazonaws.com"
      "eventTime": "2023-12-12T20:12:22Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.08"
      "managementEvent": true
      "readOnly": false
      "recipientAccountId": "123456789012"
      "requestID": "b7f91314-eb8b-4be5-995d-6b97d70dfb3b"
      "requestParameters":
        "attributeName": "restore"
        "dBSnapshotIdentifier": "exfiltration"
        "valuesToAdd": []
      "responseElements":
        "dBSnapshotAttributes":
          - "attributeName": "restore"
            "attributeValues": []
        "dBSnapshotIdentifier": "exfiltration"
      "sourceIPAddress": "1.2.3.4"
      "tlsDetails":
        "cipherSuite": "TLS_AES_128_GCM_SHA256"
        "clientProvidedHostHeader": "rds.us-west-2.amazonaws.com"
        "tlsVersion": "TLSv1.3"
      "userAgent": "68319f60-9dec-43b2-9702-de3a08c9d8a3"
      "userIdentity":
        "accessKeyId": "ASIAFFA5AFEC02FFCD8ED"
        "accountId": "123456789012"
        "arn": "arn:aws:sts::123456789012:assumed-role/AWSReservedSSO_DevAdmin_635426549a280cc6/fake.user"
        "principalId": "AROA2DFDF0C1FDFCAD2B2:fake.user"
        "sessionContext":
          "attributes":
            "creationDate": "2023-12-12T19:43:57Z"
            "mfaAuthenticated": "false"
          "sessionIssuer":
            "accountId": "123456789012"
            "arn": "arn:aws:iam::123456789012:role/aws-reserved/sso.amazonaws.com/us-west-2/AWSReservedSSO_DevAdmin_635426549a280cc6"
            "principalId": "AROA2DFDF0C1FDFCAD2B2"
            "type": "Role"
            "userName": "AWSReservedSSO_DevAdmin_635426549a280cc6"
          "webIdFederationData": {}
        "type": "AssumedRole"
    Name: Snapshot shared with no accounts
