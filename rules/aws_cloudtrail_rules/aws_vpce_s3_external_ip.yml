AnalysisType: rule
DedupPeriodMinutes: 60
Description: >-
  Detects S3 data access through VPC endpoints from external/public IP addresses,
  which could indicate data exfiltration attempts.


  This rule can be customized with the following overrides:

  - S3_DATA_ACCESS_OPERATIONS: List of S3 operations to monitor
DisplayName: "S3 Access Via VPC Endpoint From External IP"
Enabled: true
Filename: aws_vpce_s3_external_ip.py
LogTypes:
  - AWS.CloudTrail
Reference: https://www.wiz.io/blog/aws-vpc-endpoint-cloudtrail
RuleID: "AWS.CloudTrail.VPCE.S3ExternalIP"
Runbook: >-
  1. Identify the principal and the specific S3 objects being accessed

  2. Verify if the external IP address belongs to a legitimate service or entity

  3. Check if the access pattern is expected for this user/role

  4. Review the contents of the S3 objects to determine sensitivity

  5. If unauthorized, determine how the principal obtained access credentials

  6. Revoke access immediately if determined to be malicious

  7. Consider implementing stricter bucket policies and VPC endpoint policies
Severity: Medium
SummaryAttributes:
  - userIdentity.principalId
  - sourceIPAddress
  - eventSource
  - eventName
  - requestParameters
  - resources
Tags:
  - AWS
  - VPC
  - S3
  - Data Exfiltration
  - CloudTrail
  - Network Boundary Bridging
  - Exfiltration Over Alternative Protocol
Tests:
  - ExpectedResult: true
    Log:
      "eventCategory": "NetworkActivity"
      "eventName": "GetObject"
      "eventSource": "s3.amazonaws.com"
      "eventTime": "2023-01-01T12:00:00Z"
      "eventType": "AwsVpceEvent"
      "recipientAccountId": "012345678901"
      "requestParameters":
        "bucketName": "sensitive-data-bucket"
        "key": "confidential/file.pdf"
      "resources":
        - "ARN": "arn:aws:s3:::sensitive-data-bucket/confidential/file.pdf"
          "type": "AWS::S3::Object"
      "sourceIPAddress": "8.8.8.8"
      "userIdentity":
        "accountId": "012345678901"
        "principalId": "AIDAEXAMPLE"
        "type": "IAMUser"
      "vpcEndpointAccountId": "012345678901"
      "vpcEndpointId": "vpce-EXAMPLE08c1b6b9b7"
    Name: External IP Access
  - ExpectedResult: false
    Log:
      "eventCategory": "NetworkActivity"
      "eventName": "GetObject"
      "eventSource": "s3.amazonaws.com"
      "eventTime": "2023-01-01T12:00:00Z"
      "eventType": "AwsVpceEvent"
      "recipientAccountId": "012345678901"
      "requestParameters":
        "bucketName": "sensitive-data-bucket"
        "key": "confidential/file.pdf"
      "resources":
        - "ARN": "arn:aws:s3:::sensitive-data-bucket/confidential/file.pdf"
          "type": "AWS::S3::Object"
      "sourceIPAddress": "10.0.0.1"
      "userIdentity":
        "accountId": "012345678901"
        "principalId": "AIDAEXAMPLE"
        "type": "IAMUser"
      "vpcEndpointAccountId": "012345678901"
      "vpcEndpointId": "vpce-EXAMPLE08c1b6b9b7"
    Name: Internal IP Access
  - ExpectedResult: false
    Log:
      "eventCategory": "NetworkActivity"
      "eventName": "DescribeInstances"
      "eventSource": "ec2.amazonaws.com"
      "eventType": "AwsVpceEvent"
      "sourceIPAddress": "8.8.8.8"
      "userIdentity":
        "accountId": "012345678901"
        "principalId": "AIDAEXAMPLE"
        "type": "IAMUser"
    Name: Not S3 Service
