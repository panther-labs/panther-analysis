AnalysisType: rule
Description: >-
  This alert occurs when AWS has detected exposed credentials. It attaches a policy
  to deny certain actions, effectively quarantining those credentials, and is accompanied
  by a support case with instructions for detaching the policy.
DisplayName: "AWS IAM Access Key Compromise Detection"
Enabled: true
Filename: aws_key_compromised.py
LogTypes:
  - AWS.CloudTrail
Reference: https://docs.github.com/en/code-security/secret-scanning/about-secret-scanning
Reports:
  MITRE ATT&CK:
    - TA0006:T1552
RuleID: "AWS.IAM.AccessKeyCompromised"
Runbook: >-
  Determine the IAM user who owns the key, rotate/disable/delete the key, and then
  investigate which actions were taken by the compromised key to determine scope and
  if any remediation is needed.
Severity: High
Tags:
  - AWS
  - Credential Access:Unsecured Credentials
Tests:
  - ExpectedResult: true
    Log:
      "awsRegion": "us-east-1"
      "eventID": "1c2a53d1-58cc-41b3-85b8-bd7565370e0d"
      "eventName": "PutUserPolicy"
      "eventSource": "iam.amazonaws.com"
      "eventTime": "2020-04-10T06:22:08Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.05"
      "recipientAccountId": "123456789012"
      "requestID": "27ca92a5-61cc-44aa-b875-042a25310064"
      "requestParameters":
        "policyDocument": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Sid\":\"\
          Stmt1538161409\",\"Effect\":\"Deny\",\"Action\":[\"lambda:CreateFunction\"\
          ,\"iam:AttachUserPolicy\",\"iam:PutUserPolicy\",\"organizations:InviteAccountToOrganization\"\
          ,\"ec2:RunInstances\",\"iam:DetachUserPolicy\",\"iam:CreateUser\",\"lightsail:Create*\"\
          ,\"lightsail:Update*\",\"ec2:StartInstances\",\"ec2:RequestSpotInstances\"\
          ,\"iam:ChangePassword\",\"iam:CreateLoginProfile\",\"organizations:CreateOrganization\"\
          ,\"organizations:CreateAccount\",\"lightsail:Delete*\",\"iam:AttachGroupPolicy\"\
          ,\"iam:CreateAccessKey\",\"iam:UpdateUser\",\"iam:UpdateAccountPasswordPolicy\"\
          ,\"iam:DeleteUserPolicy\",\"iam:PutUserPermissionsBoundary\",\"iam:UpdateAccessKey\"\
          ,\"lightsail:DownloadDefaultKeyPair\",\"iam:CreateInstanceProfile\",\"lightsail:Start*\"\
          ,\"lightsail:GetInstanceAccessDetails\",\"iam:CreateRole\",\"iam:PutGroupPolicy\"\
          ,\"iam:AttachRolePolicy\"],\"Resource\":[\"*\"]}]}"
        "policyName": "AWSCompromisedKeyQuarantineV3"
        "userName": "compromised_user"
      "responseElements":
      "sourceIPAddress": "72.21.217.97"
      "userAgent": "aws-internal/3 aws-sdk-java/1.11.706 Linux/4.9.184-0.1.ac.235.83.329.metal1.x86_64
        OpenJDK_64-Bit_Server_VM/25.242-b08 java/1.8.0_242 vendor/Oracle_Corporation"
      "userIdentity":
        "accessKeyId": "XXXXXXXXXXXXXXXXXXXXX"
        "accountId": "123456789012"
        "arn": "arn:aws:iam::123456789012:user/compromised_user"
        "principalId": "XXXXXXXXXXXXXXXXXXX"
        "type": "IAMUser"
        "userName": "compromised_user"
    Name: An AWS IAM Access Key was Compromised
  - ExpectedResult: false
    Log:
      "awsRegion": "us-east-1"
      "eventID": "1c2a53d1-58cc-41b3-85b8-bd7565370e0d"
      "eventName": "PutUserPolicy"
      "eventSource": "iam.amazonaws.com"
      "eventTime": "2020-04-10T06:22:08Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.05"
      "recipientAccountId": "123456789012"
      "requestID": "27ca92a5-61cc-44aa-b875-042a25310064"
      "requestParameters":
      "responseElements":
      "sourceIPAddress": "72.21.217.97"
      "userAgent": "aws-internal/3 aws-sdk-java/1.11.706 Linux/4.9.184-0.1.ac.235.83.329.metal1.x86_64
        OpenJDK_64-Bit_Server_VM/25.242-b08 java/1.8.0_242 vendor/Oracle_Corporation"
      "userIdentity":
        "accessKeyId": "XXXXXXXXXXXXXXXXXXXXX"
        "accountId": "123456789012"
        "arn": "arn:aws:iam::123456789012:user/compromised_user"
        "principalId": "XXXXXXXXXXXXXXXXXXX"
        "type": "IAMUser"
        "userName": "compromised_user"
    Name: Request Param is null
