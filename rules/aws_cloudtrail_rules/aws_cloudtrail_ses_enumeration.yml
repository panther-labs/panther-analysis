AnalysisType: correlation_rule
Detection:
  - Group:
      - ID: CheckSendingEnabled
        RuleID: AWS.CloudTrail.SES.CheckSESSendingEnabled
      - ID: CheckSendQuota
        RuleID: AWS.CloudTrail.SES.CheckSendQuota
      - ID: ListIdentities
        RuleID: AWS.CloudTrail.SES.ListIdentities
      - ID: CheckVerifications
        RuleID: AWS.CloudTrail.SES.CheckIdentityVerifications
    LookbackWindowMinutes: 2160
    MatchCriteria:
      accountRegion:
        - GroupID: CheckSendingEnabled
          Match: p_alert_context.accountRegion
        - GroupID: CheckSendQuota
          Match: p_alert_context.accountRegion
        - GroupID: ListIdentities
          Match: p_alert_context.accountRegion
        - GroupID: CheckVerifications
          Match: p_alert_context.accountRegion
    Schedule:
      RateMinutes: 1440
      TimeoutMinutes: 2
DisplayName: "AWS CloudTrail SES Enumeration"
Enabled: true
Reference: 
  https://stratus-red-team.cloud/attack-techniques/AWS/aws.discovery.ses-enumerate/
Reports:
  MITRE ATT&CK:
    - TA0007:T1580
RuleID: "AWS.CloudTrail.SES.SESEnumeration"
Severity: Medium
SummaryAttributes:
  - p_any_aws_arns
  - p_any_ip_addresses
  - p_any_emails
  - p_any_actor_ids
Tags:
  - AWS
  - SES
  - Discovery
  - Cloud Service Discovery
Tests:
  - ExpectedResult: true
    Name: All Events Happen
    RuleOutputs:
      - ID: CheckSendingEnabled
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-east-1:
              - 0
      - ID: CheckSendQuota
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-east-1:
              - 1
      - ID: ListIdentities
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-east-1:
              - 2
      - ID: CheckVerifications
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-east-1:
              - 3
  - ExpectedResult: false
    Name: Check Verification Step Missing
    RuleOutputs:
      - ID: CheckSendingEnabled
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-east-1:
              - 0
      - ID: CheckSendQuota
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-east-1:
              - 1
      - ID: ListIdentities
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-east-1:
              - 2
  - ExpectedResult: false
    Name: Region Mismatch
    RuleOutputs:
      - ID: CheckSendingEnabled
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-east-1:
              - 0
      - ID: CheckSendQuota
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-east-2:
              - 1
      - ID: ListIdentities
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-west-1:
              - 2
      - ID: CheckVerifications
        Matches:
          p_alert_context.accountRegion:
            111122223333_us-west-2:
              - 3
