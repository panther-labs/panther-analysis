AnalysisType: rule
CreateAlert: false
Description: >-
  Identifies when the code of a Lambda function is updated, which could indicate a
  potential security risk.
DisplayName: "Lambda Update Function Code"
Enabled: true
Filename: aws_overwrite_lambda_code.py
LogTypes:
  - AWS.CloudTrail
Reference: 
  https://stratus-red-team.cloud/attack-techniques/AWS/aws.persistence.lambda-overwrite-code/
Reports:
  MITRE ATT&CK:
    - TA0007:T1078
RuleID: "AWS.Lambda.UpdateFunctionCode"
Runbook: >-
  Verify the event details and the user that triggered the event. If the event is
  expected, no action is required. If the event is unexpected, investigate the user
  and the function that was updated.
Severity: Info
Tags:
  - Beta
Tests:
  - ExpectedResult: true
    Log:
      "awsRegion": "us-west-2"
      "eventID": "1"
      "eventName": "UpdateFunctionCode20150331"
      "eventSource": "lambda.amazonaws.com"
      "eventTime": "2019-01-01T00:00:00Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.05"
      "p_log_type": "AWS.CloudTrail"
      "readOnly": false
      "recipientAccountId": "123456789012"
      "requestID": "1"
      "requestParameters":
        "functionName": "my-lambda-function"
      "responseElements":
        "functionName": "my-lambda-function"
      "sourceIPAddress": "111.111.111.111"
      "userAgent": "console.amazonaws.com"
      "userIdentity":
        "accessKeyId": "1"
        "accountId": "123456789012"
        "arn": "arn:aws:sts::123456789012:assumed-role/tester"
        "principalId": "tester"
        "sessionContext":
          "attributes":
            "creationDate": "2019-01-01T00:00:00Z"
            "mfaAuthenticated": "true"
          "sessionIssuer":
            "accountId": "123456789012"
            "arn": "arn:aws:iam::123456789012:role/tester"
            "principalId": "1111"
            "type": "Role"
            "userName": "Tester"
          "webIdFederationData": {}
        "type": "AssumedRole"
    Name: Lambda Update Function Code Event
  - ExpectedResult: true
    Log:
      "awsRegion": "us-west-2"
      "eventID": "1"
      "eventName": "UpdateFunctionCode20150331v2"
      "eventSource": "lambda.amazonaws.com"
      "eventTime": "2019-01-01T00:00:00Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.05"
      "p_log_type": "AWS.CloudTrail"
      "readOnly": false
      "recipientAccountId": "123456789012"
      "requestID": "1"
      "requestParameters":
        "functionName": "my-lambda-function"
      "responseElements":
        "functionName": "my-lambda-function"
      "sourceIPAddress": "111.111.111.111"
      "userAgent": "console.amazonaws.com"
      "userIdentity":
        "accessKeyId": "1"
        "accountId": "123456789012"
        "arn": "arn:aws:sts::123456789012:assumed-role/tester"
        "principalId": "tester"
        "sessionContext":
          "attributes":
            "creationDate": "2019-01-01T00:00:00Z"
            "mfaAuthenticated": "true"
          "sessionIssuer":
            "accountId": "123456789012"
            "arn": "arn:aws:iam::123456789012:role/tester"
            "principalId": "1111"
            "type": "Role"
            "userName": "Tester"
          "webIdFederationData": {}
        "type": "AssumedRole"
    Name: Lambda Update Function Code Event v2
  - ExpectedResult: false
    Log:
      "awsRegion": "us-west-2"
      "eventID": "1"
      "eventName": "DeleteFunction"
      "eventSource": "lambda.amazonaws.com"
      "eventTime": "2019-01-01T00:00:00Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.05"
      "p_log_type": "AWS.CloudTrail"
      "readOnly": false
      "recipientAccountId": "123456789012"
      "requestID": "1"
      "requestParameters":
        "functionName": "my-lambda-function"
      "responseElements":
        "functionName": "my-lambda-function"
      "sourceIPAddress": "111.111.111.111"
      "userAgent": "console.amazonaws.com"
      "userIdentity":
        "accessKeyId": "1"
        "accountId": "123456789012"
        "arn": "arn:aws:sts::123456789012:assumed-role/tester"
        "principalId": "tester"
        "sessionContext":
          "attributes":
            "creationDate": "2019-01-01T00:00:00Z"
            "mfaAuthenticated": "true"
          "sessionIssuer":
            "accountId": "123456789012"
            "arn": "arn:aws:iam::123456789012:role/tester"
            "principalId": "1111"
            "type": "Role"
            "userName": "Tester"
          "webIdFederationData": {}
        "type": "AssumedRole"
    Name: Delete Function Event
