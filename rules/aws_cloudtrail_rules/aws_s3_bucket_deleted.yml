AnalysisType: rule
Description: >-
  A S3 Bucket, Policy, or Website was deleted
DisplayName: "S3 Bucket Deleted"
Enabled: true
Filename: aws_s3_bucket_deleted.py
LogTypes:
  - AWS.CloudTrail
Reference: https://docs.aws.amazon.com/AmazonS3/latest/userguide/DeletingObjects.html
Reports:
  MITRE ATT&CK:
    - TA0040:T1485
RuleID: "AWS.S3.BucketDeleted"
Runbook: >-
  Explore if this bucket deletion was potentially destructive
Severity: Info
SummaryAttributes:
  - sourceIpAddress
  - userAgent
  - recipientAccountId
  - vpcEndpointId
Tags:
  - AWS
  - Impact:Data Destruction
Tests:
  - ExpectedResult: true
    Log:
      "additionalEventData":
        "AuthenticationMethod": "AuthHeader"
        "CipherSuite": "ECDHE-RSA-AES128-SHA"
        "SignatureVersion": "SigV4"
        "vpcEndpointId": "vpce-aaa333c9"
      "awsRegion": "us-east-2"
      "errorCode": ""
      "eventID": "6795ef5c-7777-4444-8888-cabb7f252bd3"
      "eventName": "DeleteBucket"
      "eventSource": "s3.amazonaws.com"
      "eventTime": "2020-02-14T00:43:54Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.05"
      "recipientAccountId": "123456789012"
      "requestID": "EEEE5AAAAAA44444"
      "requestParameters":
        "bucketName": "secrets"
        "host":
          - "s3-us-east-2.amazonaws.com"
      "responseElements":
      "sourceIPAddress": "157.130.196.214"
      "userAgent": "[S3Console/0.4, aws-internal/3 aws-sdk-java/1.11.666 Linux/4.9.184-0.1.ac.235.83.329.metal1.x86_64
        OpenJDK_64-Bit_Server_VM/25.232-b09 java/1.8.0_232 vendor/Oracle_Corporation]"
      "userIdentity":
        "accessKeyId": "AAAAAAAAAAAAAAAAAAAAA"
        "accountId": "123456789012"
        "arn": "arn:aws:sts::123456789012:assumed-role/BucketAdministrator/user_name"
        "principalId": "AAAAAAAAAAAAAAAAAAAAA:user_name"
        "sessionContext":
          "attributes":
            "creationDate": "2020-02-14T00:11:28Z"
            "mfaAuthenticated": "true"
          "sessionIssuer":
            "accountId": "123456789012"
            "arn": "arn:aws:iam::123456789012:role/BucketAdministrator"
            "principalId": "AAAAAAAAAAAAAAAAAAAAA"
            "type": "Role"
            "userName": "BucketAdministrator"
        "type": "AssumedRole"
      "vpcEndpointId": "vpce-aaa333c9"
    Name: An S3 Bucket was deleted
  - ExpectedResult: false
    Log:
      "awsRegion": "us-east-2"
      "errorCode": "BucketNotEmpty"
      "errorMessage": "The bucket you tried to delete is not empty"
      "eventID": "6795ef5c-7777-4444-8888-cabb7f252bd3"
      "eventName": "DeleteBucket"
      "eventType": "AwsApiCall"
      "recipientAccountId": "123456789012"
      "requestID": "EEEE5AAAAAA44444"
      "responseElements":
      "sourceIPAddress": "157.130.196.214"
      "userAgent": "[S3Console/0.4, aws-internal/3 aws-sdk-java/1.11.666 Linux/4.9.184-0.1.ac.235.83.329.metal1.x86_64
        OpenJDK_64-Bit_Server_VM/25.232-b09 java/1.8.0_232 vendor/Oracle_Corporation]"
      "userIdentity": {}
      "vpcEndpointId": "vpce-aaa333c9"
    Name: S3 Bucket Deletion Failed
  - ExpectedResult: false
    Log:
      "awsRegion": "us-east-2"
      "eventID": "6795ef5c-7777-4444-8888-cabb7f252bd3"
      "eventName": "DeleteObject"
      "eventType": "AwsApiCall"
      "recipientAccountId": "123456789012"
      "requestID": "EEEE5AAAAAA44444"
      "responseElements":
      "sourceIPAddress": "157.130.196.214"
      "userAgent": "[S3Console/0.4, aws-internal/3 aws-sdk-java/1.11.666 Linux/4.9.184-0.1.ac.235.83.329.metal1.x86_64
        OpenJDK_64-Bit_Server_VM/25.232-b09 java/1.8.0_232 vendor/Oracle_Corporation]"
      "userIdentity": {}
      "vpcEndpointId": "vpce-aaa333c9"
    Name: An S3 Object Deleted
