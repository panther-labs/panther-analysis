AnalysisType: rule
DedupPeriodMinutes: 60
Description: >-
  An AWS console login was made without SAML/SSO.
DisplayName: "Logins Without SAML"
Enabled: false
Filename: aws_console_login_without_saml.py
LogTypes:
  - AWS.CloudTrail
Reference: 
  https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_enable-console-saml.html
Reports:
  MITRE ATT&CK:
    - TA0001:T1078
RuleID: "AWS.Console.LoginWithoutSAML"
Runbook: >-
  Modify the AWS account configuration.
Severity: High
SummaryAttributes:
  - userAgent
  - sourceIpAddress
  - recipientAccountId
  - p_any_aws_arns
Tags:
  - AWS
  - Configuration Required
  - Identity & Access Management
  - Authentication
  - Initial Access:Valid Accounts
Tests:
  - ExpectedResult: false
    Log:
      "additionalEventData":
        "LoginTo": "https://console.aws.amazon.com/console/home"
        "MFAUsed": "No"
        "MobileVersion": "No"
        "SamlProviderArn": "arn:aws:iam::123456789012:saml-provider/Okta"
      "awsRegion": "us-east-1"
      "eventID": "1"
      "eventName": "ConsoleLogin"
      "eventSource": "signin.amazonaws.com"
      "eventTime": "2019-01-01T00:00:00Z"
      "eventType": "AwsConsoleSignIn"
      "eventVersion": "1.05"
      "recipientAccountId": "123456789012"
      "requestParameters":
      "responseElements":
        "ConsoleLogin": "Success"
      "sourceIPAddress": "111.111.111.111"
      "userAgent": "Mozilla"
      "userIdentity":
        "accountId": "123456789012"
        "arn": "arn:aws:iam::123456789012:assumed-role/okta/tester@domain.tld"
        "principalId": "1111"
        "type": "AssumedRole"
        "userName": "tester"
    Name: Login with SAML
  - ExpectedResult: true
    Log:
      "additionalEventData":
        "LoginTo": "https://console.aws.amazon.com/console/"
        "MFAUsed": "Yes"
        "MobileVersion": "No"
      "awsRegion": "us-east-1"
      "eventID": "1"
      "eventName": "ConsoleLogin"
      "eventSource": "signin.amazonaws.com"
      "eventTime": "2019-01-01T00:00:00Z"
      "eventType": "AwsConsoleSignIn"
      "eventVersion": "1.05"
      "recipientAccountId": "123456789012"
      "requestParameters":
      "responseElements":
        "ConsoleLogin": "Success"
      "sourceIPAddress": "111.111.111.111"
      "userAgent": "Mozilla"
      "userIdentity":
        "accountId": "123456789012"
        "arn": "arn:aws:iam::123456789012:user/tester"
        "principalId": "1111"
        "type": "IAMUser"
        "userName": "tester"
    Name: Normal Login
