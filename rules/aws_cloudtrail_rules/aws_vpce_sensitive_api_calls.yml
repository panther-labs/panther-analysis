AnalysisType: rule
Description: >-
  Detects sensitive or unusual API calls that might indicate lateral movement, reconnaissance,
  or other malicious activities through VPC Endpoints. Only available for CloudTrail,
  EC2, KMS, S3, and Secrets Manager services.
DisplayName: "Sensitive API Calls Via VPC Endpoint"
Enabled: true
Filename: aws_vpce_sensitive_api_calls.py
LogTypes:
  - AWS.CloudTrail
Reference: https://www.wiz.io/blog/aws-vpc-endpoint-cloudtrail
Reports:
  MITRE ATT&CK:
    - TA0007:T1526
    - TA0003:T1098
    - TA0005:T1562
    - TA0005:T1599
RuleID: "AWS.CloudTrail.VPCE.SensitiveAPICalls"
Runbook: >-
  1. Identify the principal making the sensitive API call and the specific service
  affected 2. Determine if this action is expected from this principal 3. Check if
  the API call is one that typically requires additional scrutiny (e.g., logging configuration
  changes) 4. Investigate whether the VPC Endpoint is configured to properly restrict
  access 5. Review additional API calls from the same principal for suspicious patterns
  6. If unexpected activity is confirmed, consider temporarily restricting the principal's
  access 7. Document findings and take appropriate remediation steps based on investigation
Severity: Medium
SummaryAttributes:
  - userIdentity.principalId
  - userIdentity.accountId
  - sourceIPAddress
  - eventSource
  - eventName
Tags:
  - AWS
  - VPC
  - CloudTrail
  - Network Boundary Bridging
  - Cloud Service Discovery
  - Account Manipulation
  - Impair Defenses
Tests:
  - ExpectedResult: true
    Log:
      "awsRegion": "us-east-1"
      "eventCategory": "NetworkActivity"
      "eventName": "UpdateTrail"
      "eventSource": "cloudtrail.amazonaws.com"
      "eventTime": "2023-03-01T00:00:00Z"
      "eventType": "AwsVpceEvent"
      "eventVersion": "1.08"
      "recipientAccountId": "111111111111"
      "requestParameters":
        "isMultiRegionTrail": false
        "name": "management-events"
      "responseElements":
      "sourceIPAddress": "10.0.0.1"
      "userIdentity":
        "accountId": "111111111111"
        "principalId": "AROAEXAMPLE:session-name"
        "type": "IAMUser"
      "vpcEndpointAccountId": "111111111111"
      "vpcEndpointId": "vpce-1234abcd"
    Name: CloudTrail API Call Via VPC Endpoint
  - ExpectedResult: false
    Log:
      "awsRegion": "us-east-1"
      "eventCategory": "NetworkActivity"
      "eventName": "GetObject"
      "eventSource": "s3.amazonaws.com"
      "eventTime": "2023-03-01T00:00:00Z"
      "eventType": "AwsVpceEvent"
      "eventVersion": "1.08"
      "recipientAccountId": "111111111111"
      "requestParameters":
        "bucketName": "example-bucket"
        "key": "example-file.txt"
      "responseElements":
      "sourceIPAddress": "10.0.0.1"
      "userIdentity":
        "accountId": "111111111111"
        "principalId": "AROAEXAMPLE:session-name"
        "type": "IAMUser"
      "vpcEndpointAccountId": "111111111111"
      "vpcEndpointId": "vpce-1234abcd"
    Name: Regular S3 API Call (Not Sensitive)
  - ExpectedResult: false
    Log:
      "awsRegion": "us-east-1"
      "eventCategory": "Management"
      "eventName": "ListAllMyBuckets"
      "eventSource": "s3.amazonaws.com"
      "eventTime": "2023-03-01T00:00:00Z"
      "eventType": "AwsApiCall"
      "eventVersion": "1.08"
      "requestParameters": {}
      "responseElements":
      "sourceIPAddress": "203.0.113.1"
      "userIdentity":
        "accountId": "111111111111"
        "principalId": "AROAEXAMPLE:session-name"
        "type": "IAMUser"
    Name: API Call Without VPC Endpoint
