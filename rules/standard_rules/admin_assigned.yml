AnalysisType: rule
Description: >-
  Assigning an admin role manually could be a sign of privilege escalation
DisplayName: "Admin Role Assigned"
Enabled: true
Filename: admin_assigned.py
LogTypes:
  - Asana.Audit
  - Atlassian.Audit
  - GCP.AuditLog
  - GitHub.Audit
  - GSuite.Reports
  - OneLogin.Events
  - Zendesk.Audit
Reference: https://medium.com/@gokulelango1040/privilege-escalation-attacks-28a9ef226abb
Reports:
  MITRE ATT&CK:
    - TA0004:T1078
RuleID: "Standard.AdminRoleAssigned"
Runbook: >-
  Verify with the user who attached the role or add to a allowlist
Severity: Medium
SummaryAttributes:
  - p_any_ip_addresses
Tags:
  - DataModel
  - Privilege Escalation:Valid Accounts
Tests:
  - ExpectedResult: true
    Log:
      "p_log_type": "GCP.AuditLog"
      "protoPayload":
        "at_sign_type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "bob@example.com"
        "methodName": "SetIamPolicy"
        "requestMetadata":
          "callerIP": "4.4.4.4"
        "serviceData":
          "@type": "type.googleapis.com/google.iam.v1.logging.AuditData"
          "policyDelta":
            "bindingDeltas":
              - "action": "ADD"
                "member": "cat@example.com"
                "role": "roles/resourcemanager.organizationAdmin"
        "serviceName": "cloudresourcemanager.googleapis.com"
    Name: GCP - Admin Assigned
  - ExpectedResult: true
    Log:
      "p_log_type": "GCP.AuditLog"
      "protoPayload":
        "at_sign_type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "bob@example.com"
        "methodName": "SetIamPolicy"
        "requestMetadata":
          "callerIP": "4.4.4.4"
        "serviceData":
          "@type": "type.googleapis.com/google.iam.v1.logging.AuditData"
          "policyDelta":
            "bindingDeltas":
              - "action": "ADD"
                "member": "cat@example.com"
                "role": "roles/resourcemanager.organizationAdmin"
              - "action": "ADD"
                "member": "dog@example.com"
                "role": "roles/owner"
        "serviceName": "cloudresourcemanager.googleapis.com"
    Name: GCP - Multiple Admin Roles Assigned
  - ExpectedResult: false
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "RENAME_ROLE"
          "type": "DELEGATED_ADMIN_SETTINGS"
      "id":
        "applicationName": "admin"
      "p_log_type": "GSuite.Reports"
    Name: GSuite - Other Admin Action
  - ExpectedResult: true
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "ASSIGN_ROLE"
          "parameters":
            - "name": "ROLE_NAME"
              "value": "Some Admin Role"
            - "name": "USER_EMAIL"
              "value": "bob@example.com"
          "type": "DELEGATED_ADMIN_SETTINGS"
      "id":
        "applicationName": "admin"
      "p_log_type": "GSuite.Reports"
    Name: GSuite - Privileges Assigned
  - ExpectedResult: false
    Log:
      "event_type_id": 8
      "p_log_type": "OneLogin.Events"
    Name: OneLogin - Non permissions assigned event
  - ExpectedResult: false
    Log:
      "event_type_id": 72
      "p_log_type": "OneLogin.Events"
      "privilege_name": "Manage users"
    Name: OneLogin - Non super user permissions assigned
  - ExpectedResult: true
    Log:
      "actor_user_name": "Bobert O'Bobly"
      "event_type_id": 72
      "p_log_type": "OneLogin.Events"
      "privilege_name": "Super user"
      "user_name": "Evil Bob"
    Name: OneLogin - Super user permissions assigned
  - ExpectedResult: true
    Log:
      "action": "team.promote_maintainer"
      "actor": "cat"
      "p_log_type": "GitHub.Audit"
      "user": "bob"
    Name: Github - User Promoted
  - ExpectedResult: true
    Log:
      "action": "business.add_admin"
      "actor": "cat"
      "p_log_type": "GitHub.Audit"
      "user": "bob"
    Name: Github - Admin Added
  - ExpectedResult: true
    Log:
      "action": "business.invite_admin"
      "actor": "cat"
      "p_log_type": "GitHub.Audit"
      "user": "bob"
    Name: Github - Admin Invited
  - ExpectedResult: false
    Log:
      "action": "unknown.admin_role"
      "actor": "cat"
      "p_log_type": "GitHub.Audit"
      "user": "bob"
    Name: Github - Unknown Admin Role
  - ExpectedResult: false
    Log:
      "action": "update"
      "action_label": "Updated"
      "actor_id": 123
      "change_description": "Role changed from Administrator to End User"
      "created_at": "2021-05-28T18:39:50Z"
      "id": 123456789123
      "ip_address": "127.0.0.1"
      "p_log_type": "Zendesk.Audit"
      "source_id": 123
      "source_label": "Bob Cat"
      "source_type": "user"
      "url": "https://myzendek.zendesk.com/api/v2/audit_logs/111222333444.json"
    Name: Zendesk - Admin Role Downgraded
  - ExpectedResult: true
    Log:
      "action": "update"
      "action_label": "Updated"
      "actor_id": 123
      "change_description": "Role changed from End User to Administrator"
      "created_at": "2021-05-28T18:39:50Z"
      "id": 123456789123
      "ip_address": "127.0.0.1"
      "p_log_type": "Zendesk.Audit"
      "source_id": 123
      "source_label": "Bob Cat"
      "source_type": "user"
      "url": "https://myzendek.zendesk.com/api/v2/audit_logs/111222333444.json"
    Name: Zendesk - Admin Role Assigned
  - ExpectedResult: true
    Log:
      "action": "update"
      "action_label": "Updated"
      "actor_id": 123
      "change_description": "Explore role changed from not set to Admin\nGuide role
        changed from not set to Admin\nSupport role changed from not set to Admin\n
        Talk role changed from not set to Admin"
      "created_at": "2021-05-28T18:39:50Z"
      "id": 123456789123
      "ip_address": "127.0.0.1"
      "p_log_type": "Zendesk.Audit"
      "source_id": 123
      "source_label": "Bob Cat"
      "source_type": "user"
      "url": "https://myzendek.zendesk.com/api/v2/audit_logs/111222333444.json"
    Name: Zendesk - App Admin Role Assigned
  - ExpectedResult: false
    Log:
      "actor":
        "actor_type": "user"
        "email": "homer@springfield.com"
        "gid": "2222222"
        "name": "Homer"
      "context":
        "client_ip_address": "8.8.8.8"
        "context_type": "web"
      "created_at": "2021-10-21T23:38:10.364Z"
      "details":
        "method":
          - "ONE_TIME_KEY"
      "event_category": "logins"
      "event_type": "user_login_succeeded"
      "gid": "222222222"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "Asana.Audit"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "resource":
        "email": "homer@springfield.com"
        "gid": "2222222"
        "name": "homer"
        "resource_type": "user"
    Name: Asana - Normal Login
  - ExpectedResult: true
    Log:
      "actor":
        "actor_type": "user"
        "name": "Homer"
      "context":
        "client_ip_address": "1.1.1.1"
        "context_type": "web"
      "created_at": "2021-10-21T23:38:18.319Z"
      "details":
        "group":
          "gid": "11111"
          "name": "1183399881404774.2lgxga.asanatest1.us"
          "resource_type": "workspace"
        "new_value": "member"
        "old_value": "super_admin"
      "event_category": "roles"
      "event_type": "user_workspace_admin_role_changed"
      "gid": "22222"
      "p_log_type": "Asana.Audit"
      "resource":
        "email": "marge@springfield.com"
        "gid": "222222"
        "name": "Marge Simpson"
        "resource_type": "user"
    Name: Asana - Admin Added
