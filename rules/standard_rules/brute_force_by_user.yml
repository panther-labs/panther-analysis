AnalysisType: rule
DedupPeriodMinutes: 60
Description: >-
  An actor user was denied login access more times than the configured threshold.
DisplayName: "Brute Force By User"
Enabled: true
Filename: brute_force_by_user.py
LogTypes:
  - Asana.Audit
  - Atlassian.Audit
  - AWS.CloudTrail
  - Box.Event
  - GSuite.Reports
  - Okta.SystemLog
  - OneLogin.Events
  - OnePassword.SignInAttempt
Reference: https://owasp.org/www-community/controls/Blocking_Brute_Force_Attacks
Reports:
  MITRE ATT&CK:
    - TA0006:T1110
RuleID: "Standard.BruteForceByUser"
Runbook: >-
  Analyze the user ID who failed to login, and other actions taken before/after. Check
  if this user eventually authenticated successfully.
Severity: Info
SummaryAttributes:
  - p_any_usernames
Tags:
  - DataModel
  - Credential Access:Brute Force
Tests:
  - ExpectedResult: false
    Log:
      "additionalEventData":
        "LoginTo": "https://console.aws.amazon.com/console/"
        "MFAUsed": "No"
        "MobileVersion": "No"
      "awsRegion": "us-east-1"
      "eventID": "1"
      "eventName": "ConsoleLogin"
      "eventSource": "signin.amazonaws.com"
      "eventTime": "2019-01-01T00:00:00Z"
      "eventType": "AwsConsoleSignIn"
      "eventVersion": "1.05"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "AWS.CloudTrail"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "recipientAccountId": "123456789012"
      "requestParameters":
      "responseElements":
        "ConsoleLogin": "Success"
      "sourceIPAddress": "111.111.111.111"
      "userAgent": "Mozilla"
      "userIdentity":
        "accountId": "123456789012"
        "arn": "arn:aws:iam::123456789012:user/tester"
        "principalId": "1111"
        "type": "IAMUser"
        "userName": "testuser"
    Name: AWS.CloudTrail - Successful Login
  - ExpectedResult: true
    Log:
      "additionalEventData":
        "LoginTo": "https://console.aws.amazon.com/console/"
        "MFAUsed": "No"
        "MobileVersion": "No"
      "awsRegion": "us-east-1"
      "eventID": "1"
      "eventName": "ConsoleLogin"
      "eventSource": "signin.amazonaws.com"
      "eventTime": "2019-01-01T00:00:00Z"
      "eventType": "AwsConsoleSignIn"
      "eventVersion": "1.05"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "AWS.CloudTrail"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "recipientAccountId": "123456789012"
      "requestParameters":
      "responseElements":
        "ConsoleLogin": "Failure"
      "sourceIPAddress": "111.111.111.111"
      "userAgent": "Mozilla"
      "userIdentity":
        "accountId": "123456789012"
        "arn": "arn:aws:iam::123456789012:user/tester"
        "principalId": "1111"
        "type": "IAMUser"
        "userName": "tester"
    Mocks:
      - objectName: geoinfo_from_ip
        returnValue: '{ "ip": "111.111.111.111", "region": "UnitTestRegion", "city":
          "UnitTestCityNew", "country": "UnitTestCountry", "hostname": "somedomain.com",
          "org": "Some Org" }'
    Name: AWS.CloudTrail - Failed Login
  - ExpectedResult: false
    Log:
      "additional_details": "{\"key\": \"value\"}"
      "created_by":
        "id": "12345678"
        "login": "cat@example"
        "name": "Bob Cat"
        "type": "user"
      "event_type": "DELETE"
      "ip_address": "111.111.111.111"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "Box.Event"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "type": "event"
    Name: Box - Regular Event
  - ExpectedResult: true
    Log:
      "additional_details": "{\"key\": \"value\"}"
      "created_by":
        "id": "12345678"
        "login": "cat@example"
        "name": "Bob Cat"
        "type": "user"
      "event_type": "FAILED_LOGIN"
      "ip_address": "111.111.111.111"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "Box.Event"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "source":
        "id": "12345678"
        "name": "Bob Cat"
        "type": "user"
      "type": "event"
    Mocks:
      - objectName: geoinfo_from_ip
        returnValue: '{ "ip": "111.111.111.111", "region": "UnitTestRegion", "city":
          "UnitTestCityNew", "country": "UnitTestCountry", "hostname": "somedomain.com",
          "org": "Some Org" }'
    Name: Box - Login Failed
  - ExpectedResult: false
    Log:
      "events":
        - "name": "login_success"
          "type": "login"
      "id":
        "applicationName": "login"
      "ipAddress": "111.111.111.111"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "GSuite.Reports"
      "p_parse_time": "2021-06-04 10:02:33.650807"
    Name: GSuite - Normal Login Event
  - ExpectedResult: true
    Log:
      "actor":
        "email": "bob@example.com"
      "events":
        - "name": "login_failure"
          "type": "login"
      "id":
        "applicationName": "login"
      "ipAddress": "111.111.111.111"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "GSuite.Reports"
      "p_parse_time": "2021-06-04 10:02:33.650807"
    Mocks:
      - objectName: geoinfo_from_ip
        returnValue: '{ "ip": "111.111.111.111", "region": "UnitTestRegion", "city":
          "UnitTestCityNew", "country": "UnitTestCountry", "hostname": "somedomain.com",
          "org": "Some Org" }'
    Name: GSuite - Failed Login Event
  - ExpectedResult: false
    Log:
      "actor":
        "alternateId": "admin"
        "displayName": "unknown"
        "id": "unknown"
        "type": "User"
      "client":
        "ipAddress": "111.111.111.111"
      "eventType": "user.session.start"
      "outcome":
        "reason": "VERIFICATION_ERROR"
        "result": "SUCCESS"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "Okta.SystemLog"
      "p_parse_time": "2021-06-04 10:02:33.650807"
    Name: Okta - Successful Login
  - ExpectedResult: true
    Log:
      "actor":
        "alternateId": "admin"
        "displayName": "unknown"
        "id": "unknown"
        "type": "User"
      "client":
        "ipAddress": "111.111.111.111"
      "eventType": "user.session.start"
      "outcome":
        "reason": "VERIFICATION_ERROR"
        "result": "FAILURE"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "Okta.SystemLog"
      "p_parse_time": "2021-06-04 10:02:33.650807"
    Mocks:
      - objectName: geoinfo_from_ip
        returnValue: '{ "ip": "111.111.111.111", "region": "UnitTestRegion", "city":
          "UnitTestCityNew", "country": "UnitTestCountry", "hostname": "somedomain.com",
          "org": "Some Org" }'
    Name: Okta - Failed Login
  - ExpectedResult: false
    Log:
      "actor_user_id": 123456
      "actor_user_name": "Bob Cat"
      "event_type_id": 8
      "ipaddr": "111.111.111.111"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "OneLogin.Events"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "user_id": 123456
      "user_name": "Bob Cat"
    Name: OneLogin - Normal Login Event
  - ExpectedResult: true
    Log:
      "actor_user_id": 123456
      "actor_user_name": "Bob Cat"
      "event_type_id": 6
      "ipaddr": "1.2.3.4"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "OneLogin.Events"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "user_id": 123456
      "user_name": "Bob Cat"
    Mocks:
      - objectName: geoinfo_from_ip
        returnValue: '{ "ip": "111.111.111.111", "region": "UnitTestRegion", "city":
          "UnitTestCityNew", "country": "UnitTestCountry", "hostname": "somedomain.com",
          "org": "Some Org" }'
    Name: OneLogin - Failed Login Event
  - ExpectedResult: false
    Log:
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "GCP.AuditLog"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "protoPayload":
        "at_sign_type": "type.googleapis.com/google.cloud.audit.AuditLog"
        "authenticationInfo":
          "principalEmail": "bob@example.com"
        "methodName": "SetIamPolicy"
        "requestMetadata":
          "callerIP": "111.111.111.111"
        "serviceData":
          "@type": "type.googleapis.com/google.iam.v1.logging.AuditData"
          "policyDelta":
            "bindingDeltas":
              - "action": "ADD"
                "member": "cat@example.com"
                "role": "roles/resourcemanager.organizationAdmin"
        "serviceName": "cloudresourcemanager.googleapis.com"
    Name: GCP - Non Login Event
  - ExpectedResult: true
    Log:
      "actor":
        "actor_type": "user"
        "email": "homer@springfield.com"
        "gid": "2222222"
        "name": "Homer"
      "context":
        "client_ip_address": "8.8.8.8"
        "context_type": "web"
      "created_at": "2021-10-21T23:38:10.364Z"
      "details":
        "method":
          - "ONE_TIME_KEY"
      "event_category": "logins"
      "event_type": "user_login_failed"
      "gid": "222222222"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "Asana.Audit"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "resource":
        "email": "homer@springfield.com"
        "gid": "2222222"
        "name": "homer"
        "resource_type": "user"
    Mocks:
      - objectName: geoinfo_from_ip
        returnValue: '{ "ip": "111.111.111.111", "region": "UnitTestRegion", "city":
          "UnitTestCityNew", "country": "UnitTestCountry", "hostname": "somedomain.com",
          "org": "Some Org" }'
    Name: Asana - Failed Login
  - ExpectedResult: false
    Log:
      "actor":
        "actor_type": "user"
        "email": "homer@springfield.com"
        "gid": "2222222"
        "name": "Homer"
      "context":
        "client_ip_address": "8.8.8.8"
        "context_type": "web"
      "created_at": "2021-10-21T23:38:10.364Z"
      "details":
        "method":
          - "ONE_TIME_KEY"
      "event_category": "logins"
      "event_type": "user_login_succeeded"
      "gid": "222222222"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "Asana.Audit"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "resource":
        "email": "homer@springfield.com"
        "gid": "2222222"
        "name": "homer"
        "resource_type": "user"
    Name: Asana - Normal Login
  - ExpectedResult: false
    Log:
      "category": "success"
      "client":
        "app_name": "1Password Browser Extension"
        "app_version": "20184"
        "ip_address": "1.1.1.1"
        "os_name": "Solaris"
        "os_version": "10"
        "platform_name": "Chrome"
        "platform_version": "96.0.4664.55"
      "country": "US"
      "p_log_type": "OnePassword.SignInAttempt"
      "session_uuid": "5678"
      "target_user":
        "email": "homer@springfield.gov"
        "name": "Homer Simpson"
        "uuid": "1234"
      "timestamp": "2021-12-03 19:52:52"
      "type": "credentials_ok"
      "uuid": "1234"
    Name: 1Password - Regular Login
  - ExpectedResult: true
    Log:
      "category": "credentials_failed"
      "client":
        "app_name": "1Password Browser Extension"
        "app_version": "20184"
        "ip_address": "111.111.111.111"
        "os_name": "Solaris"
        "os_version": "10"
        "platform_name": "Chrome"
        "platform_version": "96.0.4664.55"
      "country": "US"
      "p_event_time": "2021-06-04 09:59:53.650807"
      "p_log_type": "OnePassword.SignInAttempt"
      "p_parse_time": "2021-06-04 10:02:33.650807"
      "session_uuid": "5678"
      "target_user":
        "email": "homer@springfield.gov"
        "name": "Homer Simpson"
        "uuid": "1234"
      "timestamp": "2021-12-03 19:52:52"
      "type": "password_secret_bad"
      "uuid": "1234"
    Mocks:
      - objectName: geoinfo_from_ip
        returnValue: '{ "ip": "111.111.111.111", "region": "UnitTestRegion", "city":
          "UnitTestCityNew", "country": "UnitTestCountry", "hostname": "somedomain.com",
          "org": "Some Org" }'
    Name: 1Password - Failed Login
Threshold: 20
