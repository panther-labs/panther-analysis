AnalysisType: rule
DedupPeriodMinutes: 360
Description: >-
  A Google drive resource became externally accessible.
DisplayName: "GSuite External Drive Document"
Enabled: false
Filename: gsuite_drive_visibility_change.py
LogTypes:
  - GSuite.Reports
Reference: 
  https://support.google.com/a/users/answer/12380484?hl=en&sjid=864417124752637253-EU
Reports:
  MITRE ATT&CK:
    - TA0009:T1213
RuleID: "GSuite.DriveVisibilityChanged"
Runbook: >-
  Investigate whether the drive document is appropriate to be publicly accessible.
Severity: Low
SummaryAttributes:
  - actor:email
Tags:
  - GSuite
  - Collection:Data from Information Repositories
  - Configuration Required
Tests:
  - ExpectedResult: false
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "upload"
          "type": "access"
      "id":
        "applicationName": "drive"
      "p_row_id": "111222"
    Name: Access Event
  - ExpectedResult: false
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "shared_drive_settings_change"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "p_row_id": "111222"
    Name: ACL Change without Visibility Change
  - ExpectedResult: true
    Log:
      "actor":
        "email": "bobert@gmail.com"
      "events":
        - "name": "change_document_visibility"
          "parameters":
            - "name": "visibility_change"
              "value": "external"
            - "name": "doc_title"
              "value": "my shared document"
            - "name": "target_domain"
              "value": "all"
            - "name": "visibility"
              "value": "people_with_link"
            - "multiValue":
                - "people_with_link"
              "name": "new_value"
          "type": "acl_change"
        - "name": "change_document_access_scope"
          "parameters":
            - "multiValue":
                - "can_view"
              "name": "new_value"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "p_row_id": "111222"
    Name: Doc Became Public - Link (Unrestricted)
  - ExpectedResult: true
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "change_document_visibility"
          "parameters":
            - "name": "visibility_change"
              "value": "external"
            - "name": "doc_title"
              "value": "my shared document"
            - "name": "target_domain"
              "value": "example.com"
            - "name": "visibility"
              "value": "people_within_domain_with_link"
            - "multiValue":
                - "people_with_link"
              "name": "new_value"
          "type": "acl_change"
        - "name": "change_document_access_scope"
          "parameters":
            - "multiValue":
                - "can_view"
              "name": "new_value"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "p_row_id": "111222"
    Name: Doc Became Public - Link (Allowlisted Domain Not Configured)
  - ExpectedResult: false
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "change_document_visibility"
          "parameters":
            - "name": "visibility_change"
              "value": "external"
            - "name": "doc_title"
              "value": "my shared document"
            - "name": "target_domain"
              "value": "example.com"
            - "name": "visibility"
              "value": "people_within_domain_with_link"
            - "multiValue":
                - "people_with_link"
              "name": "new_value"
          "type": "acl_change"
        - "name": "change_document_access_scope"
          "parameters":
            - "multiValue":
                - "can_view"
              "name": "new_value"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "p_row_id": "111222"
    Mocks:
      - objectName: ALLOWED_DOMAINS
        returnValue: "[\n  \"example.com\"\n]"
    Name: Doc Became Public - Link (Allowlisted Domain Is Configured)
  - ExpectedResult: false
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "change_document_visibility"
          "parameters":
            - "name": "visibility_change"
              "value": "external"
            - "name": "doc_title"
              "value": "my shared document"
            - "name": "target_domain"
              "value": "all"
            - "name": "visibility"
              "value": "people_with_link"
            - "multiValue":
                - "private"
              "name": "new_value"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "p_row_id": "111222"
    Name: Doc Became Private - Link
  - ExpectedResult: true
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "edit"
          "parameters":
            - "name": "primary_event"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "access"
        - "name": "change_user_access"
          "parameters":
            - "boolValue": true
              "name": "primary_event"
            - "name": "visibility_change"
              "value": "external"
            - "name": "target_user"
              "value": "someone@random.com"
            - "multiValue":
                - "none"
              "name": "old_value"
            - "multiValue":
                - "can_view"
              "name": "new_value"
            - "name": "old_visibility"
              "value": "people_within_domain_with_link"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "ipAddress": "1.1.1.1"
      "kind": "admin#reports#activity"
    Name: Doc Became Public - User
  - ExpectedResult: true
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "edit"
          "parameters":
            - "name": "primary_event"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "access"
        - "name": "change_user_access"
          "parameters":
            - "boolValue": true
              "name": "primary_event"
            - "name": "visibility_change"
              "value": "external"
            - "name": "target_user"
              "value": "someone@random.com"
            - "multiValue":
                - "none"
              "name": "old_value"
            - "multiValue":
                - "can_view"
              "name": "new_value"
            - "name": "old_visibility"
              "value": "people_within_domain_with_link"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "acl_change"
        - "name": "change_user_access"
          "parameters":
            - "boolValue": true
              "name": "primary_event"
            - "name": "visibility_change"
              "value": "external"
            - "name": "target_user"
              "value": "someoneelse@random.com"
            - "multiValue":
                - "none"
              "name": "old_value"
            - "multiValue":
                - "can_view"
              "name": "new_value"
            - "name": "old_visibility"
              "value": "people_within_domain_with_link"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "acl_change"
        - "name": "change_user_access"
          "parameters":
            - "boolValue": true
              "name": "primary_event"
            - "name": "visibility_change"
              "value": "external"
            - "name": "target_user"
              "value": "notbobert@example.com"
            - "multiValue":
                - "none"
              "name": "old_value"
            - "multiValue":
                - "can_view"
              "name": "new_value"
            - "name": "old_visibility"
              "value": "people_within_domain_with_link"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "ipAddress": "1.1.1.1"
      "kind": "admin#reports#activity"
    Name: Doc Became Public - User (Multiple)
  - ExpectedResult: false
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "change_user_access_hierarchy_reconciled"
          "parameters":
            - "name": "visibility_change"
              "value": "internal"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "p_row_id": "111222"
    Name: Doc Inherits Folder Permissions
  - ExpectedResult: false
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "change_document_access_scope_hierarchy_reconciled"
          "parameters":
            - "name": "visibility_change"
              "value": "internal"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "p_row_id": "111222"
    Name: Doc Inherits Folder Permissions - Sharing Link
  - ExpectedResult: true
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "edit"
          "parameters":
            - "name": "primary_event"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "access"
        - "name": "change_user_access"
          "parameters":
            - "boolValue": true
              "name": "primary_event"
            - "name": "visibility_change"
              "value": "external"
            - "name": "target_user"
              "value": "someone@yandex.com"
            - "multiValue":
                - "none"
              "name": "old_value"
            - "multiValue":
                - "can_view"
              "name": "new_value"
            - "name": "old_visibility"
              "value": "people_within_domain_with_link"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "ipAddress": "1.1.1.1"
      "kind": "admin#reports#activity"
    Name: Doc Became Public - Public email provider
  - ExpectedResult: false
    Log:
      "actor":
        "email": "bobert@example.com"
      "events":
        - "name": "edit"
          "parameters":
            - "name": "primary_event"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "access"
        - "name": "change_user_access"
          "parameters":
            - "boolValue": true
              "name": "primary_event"
            - "name": "visibility_change"
              "value": "external"
            - "name": "target_user"
              "value": "someone@notexample.com"
            - "multiValue":
                - "none"
              "name": "old_value"
            - "multiValue":
                - "can_view"
              "name": "new_value"
            - "name": "old_visibility"
              "value": "people_within_domain_with_link"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "acl_change"
        - "name": "change_user_access"
          "parameters":
            - "boolValue": true
              "name": "primary_event"
            - "name": "visibility_change"
              "value": "external"
            - "name": "target_user"
              "value": "someoneelse@example.com"
            - "multiValue":
                - "none"
              "name": "old_value"
            - "multiValue":
                - "can_view"
              "name": "new_value"
            - "name": "old_visibility"
              "value": "people_within_domain_with_link"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "acl_change"
        - "name": "change_user_access"
          "parameters":
            - "boolValue": true
              "name": "primary_event"
            - "name": "visibility_change"
              "value": "external"
            - "name": "target_user"
              "value": "notbobert@example.com"
            - "multiValue":
                - "none"
              "name": "old_value"
            - "multiValue":
                - "can_view"
              "name": "new_value"
            - "name": "old_visibility"
              "value": "people_within_domain_with_link"
            - "name": "doc_title"
              "value": "Hosted Accounts"
            - "name": "visibility"
              "value": "shared_externally"
          "type": "acl_change"
      "id":
        "applicationName": "drive"
      "ipAddress": "1.1.1.1"
      "kind": "admin#reports#activity"
    Mocks:
      - objectName: ALLOWED_DOMAINS
        returnValue: "[\n  \"example.com\", \"notexample.com\"\n]"
    Name: Doc Shared With Multiple Users All From ALLOWED_DOMAINS
