AnalysisType: saved_query
QueryName: "Auth0 Multiple Users Having Same Phone Number as MFA"
Description: "Attackers may try to register the same phone number (for the SMS delivery) as a second factor (MFA) to multiple compromised accounts."
Query: |
  SELECT
      data:details:authenticator:phone_number::string AS phone_number,
      COUNT(DISTINCT data:user_id) AS users_count,
      ARRAY_AGG(DISTINCT data:user_id) AS user_ids,
  FROM
      panther_logs.public.auth0_events
  WHERE
      data:type = 'gd_enrollment_complete'
      AND data:description = 'Guardian - Enrollment complete (sms)'
      AND p_occurs_since('7 days')
      AND data:details:authenticator:phone_number IS NOT NULL
  GROUP BY 
      phone_number
  HAVING 
      COUNT(DISTINCT data:user_id) > 1
  ORDER BY 
      users_count DESC