AnalysisType: saved_query
QueryName: "Microsoft Entra ID First Time Seen Device Code Authentication"
Enabled: false
Description: >
  Detects when users authenticate via device code flow for the first time in the past 14 days.
  Device code flow can be exploited through phishing attacks to steal tokens and impersonate victims. 
  This baseline detection helps identify new device code usage patterns that may indicate account compromise.
Tags:
  - Anomaly Detection
  - Device Code Flow
Query: |-
  -- pragma: template

  {% import 'anomalies' new_unique_values %}

  with subquery as (
      SELECT *
      FROM panther_logs.public.azure_audit
      WHERE
        p_occurs_since('14 day')
        AND category IN ('SignInLogs', 'NonInteractiveUserSignInLogs')
        AND operationName = 'Sign-in activity'
        AND resultType = '0'
        AND (
          properties:authenticationProtocol::string = 'deviceCode'
          OR properties:originalTransferMethod::string ILIKE '%device%code%'
        )
  ),
  {{ new_unique_values('subquery', 'properties:userPrincipalName', 'properties:authenticationProtocol', '1h') }}