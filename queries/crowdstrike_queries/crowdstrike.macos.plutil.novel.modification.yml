AnalysisType: scheduled_query
QueryName: CrowdStrike MacOS plutil Novel Plist Modification
Enabled: true
Description: Detects when plutil performs MODIFICATION operations (insert, replace, remove, create) on plist files it hasn't modified in the previous 30 days. Uses behavioral filtering to exclude read-only operations (convert, print, lint) that generate noise.
Tags:
  - Anomaly Detection
  - CrowdStrike
  - macOS
  - Persistence
  - T1547.011
Query: |-
    -- pragma: template

    {% import 'anomalies' new_unique_values %}

    with subquery as (
        SELECT
            aid as device_id,
            p_event_time,
            event:CommandLine as command_line,
            -- Extract plist file path from command line (robust extraction)
            -- 1. Try regex match for absolute/relative paths ending in .plist
            -- 2. Fall back to last space-delimited argument
            -- 3. Strip quotes to handle: "/path with spaces/file.plist"
            -- Handles: /Library/file.plist, ~/file.plist, "path with spaces.plist"
            REPLACE(
                REPLACE(
                    COALESCE(
                        REGEXP_SUBSTR(event:CommandLine, '[~/][^\\s]*\\.plist'),
                        SPLIT_PART(event:CommandLine, ' ', -1)
                    ),
                    '"', ''
                ),
                '''', ''
            ) as plist_file
        FROM panther_logs.public.crowdstrike_fdrevent
        WHERE
            p_occurs_since('60 day')
            AND event_platform = 'Mac'
            AND fdr_event_type = 'ProcessRollup2'
            AND event:ImageFileName = '/usr/bin/plutil'
            -- BEHAVIORAL FILTERING: Focus on modification operations
            -- Only alert on operations that CHANGE plists, not just read them
            -- CAUGHT (modifications):
            --   plutil -insert RunAtLoad -bool true file.plist
            --   plutil --replace ProgramArguments -array /tmp/evil file.plist
            --   plutil -remove SomeKey file.plist
            --   plutil --create xml1 file.plist
            -- FILTERED OUT (read-only):
            --   plutil -convert binary1 file.plist (format conversion)
            --   plutil -p file.plist (print/read)
            --   plutil -lint file.plist (syntax check)
            --   plutil -extract Key xml1 file.plist (read value)
            -- Use ILIKE for case-insensitive matching (handles -INSERT, --Replace, etc.)
            AND (
                event:CommandLine ILIKE '%--insert%'      -- Adding new keys
                OR event:CommandLine ILIKE '%-insert%'
                OR event:CommandLine ILIKE '%--replace%'  -- Modifying existing keys
                OR event:CommandLine ILIKE '%-replace%'
                OR event:CommandLine ILIKE '%--remove%'   -- Deleting keys
                OR event:CommandLine ILIKE '%-remove%'
                OR event:CommandLine ILIKE '%--create%'   -- Creating new plists
                OR event:CommandLine ILIKE '%-create%'
            )
            -- Exclude known benign operations
            AND event:CommandLine != 'plutil -convert binary1 /Library/Preferences/com.tinyspeck.slackmacgap.plist'
    ),
    {{ new_unique_values('subquery', 'device_id', 'plist_file', '1day') }}

Schedule:
  CronExpression: '0 */4 * * *'
  TimeoutMinutes: 5
