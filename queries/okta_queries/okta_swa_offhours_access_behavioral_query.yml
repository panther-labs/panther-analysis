AnalysisType: scheduled_query
QueryName: "Query.Okta.SWAOffhoursAccessBehavioral"
Enabled: true
Description: |
  Detects SWA application access at unusual times using statistical anomaly detection.
  Identifies when users access SWA apps at hours they typically don't use.
Query: |
  -- pragma: template

  {% import 'anomalies' statistical_anomaly %}

  with subquery as (
    SELECT
      p_event_time,
      actor.alternateId || '|' || CAST(HOUR(p_event_time) AS VARCHAR) as user_hour_key,
      actor.alternateId as actorId,
      actor.displayName as actorName,
      eventType,
      client.ipAddress as sourceIP,
      client.userAgent.rawUserAgent as userAgent,
      debugContext.debugData.signOnMode as signOnMode,
      outcome.result as result,
      target[0].displayName as appName,
      target[0].alternateId as appId,
      HOUR(p_event_time) as hour_of_day,
      1 as access_count
    FROM panther_logs.public.okta_systemlog
    WHERE p_occurs_since('30 day')
      AND (
        (eventType = 'policy.evaluate_sign_on'
         AND debugContext.debugData.signOnMode = 'BROWSER_PLUGIN')
        OR eventType = 'application.user_membership.show_password'
      )
      AND outcome.result = 'SUCCESS'
      AND actor.alternateId IS NOT NULL
  ),
  {{ statistical_anomaly('subquery', 'user_hour_key', 'access_count', 'count', '1', 'day', 2) }}
  WHERE t2 >= dateadd('day', -3, p_current_timestamp())
    AND N >= 2
    AND user_hour_key LIKE '%|%'
  LIMIT 100
Schedule:
  RateMinutes: 60
  TimeoutMinutes: 5
Tags:
  - Okta
  - Anomaly Detection
  - Behavioral Analytics
