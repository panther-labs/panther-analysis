AnalysisType: scheduled_query
Description: A role was assumed by an AWS service, followed by a user within 24 hours.  This could indicate a stolen or compromised AWS service role.
Enabled: false
Query: |
  SELECT
    requestParameters:roleArn as role,
    array_agg(distinct userIdentity:principalId) as users,
    array_agg(distinct userIdentity:type) as types
  FROM
    panther_logs.public.aws_cloudtrail
  WHERE
    p_occurs_since('1 day')
    and eventName = 'AssumeRole'
    and errorCode is null
  GROUP BY role
  HAVING
    ARRAY_SIZE(types) > 1
    and ARRAY_CONTAINS('AWSService'::variant, types)
  LIMIT 100
QueryName: "AWS Potentially Stolen Service Role"
Schedule:
  RateMinutes: 1440
  TimeoutMinutes: 5
