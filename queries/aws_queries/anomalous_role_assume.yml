AnalysisType: scheduled_query
Description: Role Assumes by more than one user agent
Enabled: false
Query: |
    SELECT
      requestParameters:roleArn,
      userIdentity:principalId,
      count(DISTINCT userAgent)
    FROM
      panther_logs.public.aws_cloudtrail
    WHERE
      eventSource = 'sts.amazonaws.com'
      and eventName = 'AssumeRole'
      and p_occurs_since('2 days')
      and userIdentity:principalId != 'null'
      and userAgent != 'AWS Internal'
      and requestParameters:roleArn != 'null'
    GROUP BY requestParameters:roleArn, userIdentity:principalId
    HAVING count(DISTINCT userAgent) > 1
    ORDER BY count(DISTINCT userAgent) DESC
QueryName: Anomalous Role Assume
Schedule:
  RateMinutes: 60
  TimeoutMinutes: 1
