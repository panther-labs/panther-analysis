AnalysisType: policy
Description: >-
  A stack has drifted from its defined configuration.
DisplayName: "AWS CloudFormation Stack Drift"
Enabled: true
Filename: aws_cloudformation_stack_drifted.py
PolicyID: "AWS.CloudFormation.Stack.Drifted"
Reference: https://amzn.to/2z8dDFW
Reports:
  MITRE ATT&CK:
    - TA0040:T1496
ResourceTypes:
  - AWS.CloudFormation.Stack
Runbook: >-
  From the CloudFormation web console, look at the drifted resources for the failing
  stack. If the drift is expected, update the policy ignore list to exclude this stack.
  Otherwise, analyze CloudTrail logs to understand who changed the drifted resource(s)
  and ensure it was legitimate access.
Severity: Low
Tags:
  - AWS
  - Operations
  - Panther
  - Impact:Resource Hijacking
Tests:
  - ExpectedResult: false
    Name: Stack Drifted
    Resource:
      "ARN": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "AccountId": "123456789012"
      "Capabilities":
        - "CAPABILITY_NAMED_IAM"
      "ChangeSetId":
      "DeletionTime":
      "Description": "IAM Admin role"
      "DisableRollback": false
      "DriftInformation":
        "LastCheckTimestamp": "2019-04-02T17:16:30Z"
        "StackDriftStatus": "DRIFTED"
      "Drifts": []
      "EnableTerminationProtection":
      "ID": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "LastUpdatedTime": "2019-04-02T17:16:30Z"
      "Name": "iam-roles"
      "NotificationARNs": []
      "Outputs":
      "Parameters":
        - "ParameterKey": "MaxSessionDurationSec"
          "ParameterValue": "28800"
          "ResolvedValue":
          "UsePreviousValue":
        - "ParameterKey": "Prefix"
          "ParameterValue": "Dev"
          "ResolvedValue":
          "UsePreviousValue":
      "ParentId":
      "Region": "us-west-2"
      "ResourceID": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "ResourceType": "AWS.CloudFormation.Stack"
      "RoleARN": "arn:aws:iam::123456789012:role/CFNServiceRole"
      "RollbackConfiguration":
        "MonitoringTimeInMinutes":
        "RollbackTriggers": []
      "RootId":
      "StackId": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "StackStatus": "UPDATE_COMPLETE"
      "StackStatusReason":
      "Tags": {}
      "TimeCreated": "2019-04-02T17:16:30.000Z"
      "TimeoutInMinutes":
  - ExpectedResult: true
    Name: Stack Drifted but Ignored
    Resource:
      "ARN": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "AccountId": "123456789012"
      "Capabilities":
        - "CAPABILITY_NAMED_IAM"
      "ChangeSetId":
      "DeletionTime":
      "Description": "IAM Admin role"
      "DisableRollback": false
      "DriftInformation":
        "LastCheckTimestamp": "2019-04-02T17:16:30Z"
        "StackDriftStatus": "DRIFTED"
      "Drifts": []
      "EnableTerminationProtection":
      "ID": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "LastUpdatedTime": "2019-04-02T17:16:30Z"
      "Name": "panther-master-Panther-XXXXXXXXXXXXX-BootstrapGateway-XXXXXXXXXXXXX"
      "NotificationARNs": []
      "Outputs":
      "Parameters":
        - "ParameterKey": "MaxSessionDurationSec"
          "ParameterValue": "28800"
          "ResolvedValue":
          "UsePreviousValue":
        - "ParameterKey": "Prefix"
          "ParameterValue": "Dev"
          "ResolvedValue":
          "UsePreviousValue":
      "ParentId":
      "Region": "us-west-2"
      "ResourceID": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "ResourceType": "AWS.CloudFormation.Stack"
      "RoleARN": "arn:aws:iam::123456789012:role/CFNServiceRole"
      "RollbackConfiguration":
        "MonitoringTimeInMinutes":
        "RollbackTriggers": []
      "RootId":
      "StackId": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "StackStatus": "UPDATE_COMPLETE"
      "StackStatusReason":
      "Tags":
        "Application": "Panther"
        "PantherEdition": "Community"
        "PantherVersion": "v1.7.1"
        "Stack": "panther-bootstrap-gateway"
      "TimeCreated": "2019-04-02T17:16:30.000Z"
      "TimeoutInMinutes":
  - ExpectedResult: true
    Name: Stack In Sync
    Resource:
      "ARN": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "AccountId": "123456789012"
      "Capabilities":
        - "CAPABILITY_NAMED_IAM"
      "ChangeSetId":
      "DeletionTime":
      "Description": "IAM Admin role"
      "DisableRollback": false
      "DriftInformation":
        "LastCheckTimestamp": "2019-04-02T17:16:30Z"
        "StackDriftStatus": "IN_SYNC"
      "Drifts": []
      "EnableTerminationProtection":
      "ID": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "LastUpdatedTime": "2019-04-02T17:16:30Z"
      "Name": "iam-roles"
      "NotificationARNs": []
      "Outputs":
      "Parameters":
        - "ParameterKey": "MaxSessionDurationSec"
          "ParameterValue": "28800"
          "ResolvedValue":
          "UsePreviousValue":
        - "ParameterKey": "Prefix"
          "ParameterValue": "Dev"
          "ResolvedValue":
          "UsePreviousValue":
      "ParentId":
      "Region": "us-west-2"
      "ResourceID": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "ResourceType": "AWS.CloudFormation.Stack"
      "RoleARN":
      "RollbackConfiguration":
        "MonitoringTimeInMinutes":
        "RollbackTriggers": []
      "RootId":
      "StackId": "arn:aws:cloudformation:us-west-2:123456789012:stack/iam-roles/12345678901258f4c3a3-c67c-4f81-afe1-509a2065de91"
      "StackStatus": "UPDATE_COMPLETE"
      "StackStatusReason":
      "Tags": {}
      "TimeCreated": "2019-04-02T17:16:30.000Z"
      "TimeoutInMinutes":
