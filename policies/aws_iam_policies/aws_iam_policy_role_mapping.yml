AnalysisType: policy
Description: >-
  This policy validates that policies that have been explicitly configured to be set
  to certain roles are still attached to those roles.
DisplayName: "AWS IAM Policy Role Mapping"
Enabled: false
Filename: aws_iam_policy_role_mapping.py
PolicyID: "AWS.IAM.Policy.RoleMapping"
Reference: https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html
ResourceTypes:
  - AWS.IAM.Policy
Runbook: >-
  https://docs.runpanther.io/alert-runbooks/built-in-policies/aws-iam-policy-role-mapping-is-respected
Severity: High
Tags:
  - AWS
  - Configuration Required
  - Identity & Access Management
Tests:
  - ExpectedResult: true
    Name: Policy Applied To Required Roles
    Resource:
      "Arn": "arn:aws:iam::123456789012:policy/service-role/example-policy"
      "AttachmentCount": 2
      "CreateDate": "2019-01-01T00:00:00Z"
      "DefaultVersionId": "v1"
      "Description":
      "Entities":
        "PolicyGroups":
        "PolicyRoles":
          - "RoleId": "ABCDEFGHIJKLMNOP1"
            "RoleName": "TestRole1"
          - "RoleId": "ABCDEFGHIJKLMNOP2"
            "RoleName": "TestRole2"
        "PolicyUsers":
          - "UserId": "ABCDEFGHIJKLMNOP"
            "UserName": "Bobert"
      "IsAttachable": true
      "Path": "/service-role/"
      "PermissionsBoundaryUsageCount": 0
      "PolicyDocument": "JSON policy document see https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html
        for details"
      "PolicyId": "ABCDEFGHIJKLMNOP"
      "PolicyName": "TestPolicyName"
      "UpdateDate": "2019-01-01T00:00:00Z"
  - ExpectedResult: true
    Name: Policy Does Not Have Role Mappings
    Resource:
      "Arn": "arn:aws:iam::123456789012:policy/service-role/example-policy"
      "AttachmentCount": 2
      "CreateDate": "2019-01-01T00:00:00Z"
      "DefaultVersionId": "v1"
      "Description":
      "Entities":
        "PolicyGroups":
        "PolicyRoles":
          - "RoleId": "ABCDEFGHIJKLMNOP"
            "RoleName": "Example-Role"
        "PolicyUsers":
          - "UserId": "ABCDEFGHIJKLMNOP"
            "UserName": "Bobert"
      "IsAttachable": true
      "Path": "/service-role/"
      "PermissionsBoundaryUsageCount": 0
      "PolicyDocument": "JSON policy document see https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html
        for details"
      "PolicyId": "ABCDEFGHIJKLMNOP"
      "PolicyName": "Example-Policy"
      "UpdateDate": "2019-01-01T00:00:00Z"
  - ExpectedResult: false
    Name: Policy Not Applied To Required Roles
    Resource:
      "Arn": "arn:aws:iam::123456789012:policy/service-role/example-policy"
      "AttachmentCount": 2
      "CreateDate": "2019-01-01T00:00:00Z"
      "DefaultVersionId": "v1"
      "Description":
      "Entities":
        "PolicyGroups":
        "PolicyRoles":
          - "RoleId": "ABCDEFGHIJKLMNOP"
            "RoleName": "Example-Role"
        "PolicyUsers":
          - "UserId": "ABCDEFGHIJKLMNOP"
            "UserName": "Bobert"
      "IsAttachable": true
      "Path": "/service-role/"
      "PermissionsBoundaryUsageCount": 0
      "PolicyDocument": "JSON policy document see https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html
        for details"
      "PolicyId": "ABCDEFGHIJKLMNOP"
      "PolicyName": "TestPolicyName"
      "UpdateDate": "2019-01-01T00:00:00Z"
  - ExpectedResult: true
    Name: Policy Not Applied to Anything
    Resource:
      "Arn": "arn:aws:iam::123456789012:policy/service-role/example-policy"
      "AttachmentCount": 2
      "CreateDate": "2019-01-01T00:00:00Z"
      "DefaultVersionId": "v1"
      "Description":
      "Entities":
      "IsAttachable": true
      "Path": "/service-role/"
      "PermissionsBoundaryUsageCount": 0
      "PolicyDocument": "JSON policy document see https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html
        for details"
      "PolicyId": "ABCDEFGHIJKLMNOP"
      "PolicyName": "Example-Policy"
      "UpdateDate": "2019-01-01T00:00:00Z"
