AnalysisType: policy
Description: >-
  Ensures access to S3 buckets is forced to use a secure (HTTPS) connection.
DisplayName: "AWS S3 Bucket Secure Access"
Enabled: true
Filename: aws_s3_bucket_secure_access.py
PolicyID: "AWS.S3.Bucket.SecureAccess"
Reference: https://aws.amazon.com/premiumsupport/knowledge-center/secure-s3-resources/
Reports:
  MITRE ATT&CK:
    - TA0009:T1530
  PCI:
    - 2.2.3
    - 4.1
ResourceTypes:
  - AWS.S3.Bucket
Runbook: >-
  https://docs.runpanther.io/alert-runbooks/built-in-policies/aws-s3-bucket-policy-enforces-secure-access
Severity: Low
Tags:
  - AWS
  - Security Control
  - Collection:Data From Cloud Storage Object
Tests:
  - ExpectedResult: false
    Name: Bucket Uses Implicit Allow
    Resource:
      "CreationDate": "2019-01-01T00:00:00Z"
      "EncryptionRules":
        - "ApplyServerSideEncryptionByDefault":
            "KMSMasterKeyID":
            "SSEAlgorithm": "AES256"
      "Grants":
      "LifecycleRules":
      "Location": "us-east-2"
      "LoggingPolicy":
      "MFADelete":
      "Name": "bucket-name"
      "Owner":
        "DisplayName": "user.name"
        "ID": "11112223334445556667778899aaabbbcccdddeeee"
      "Policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\"\
        ,\"Principal\":{\"AWS\":\"arn:aws:iam::123456789012:root\"},\"Action\":[\"\
        s3:ListBucket\",\"s3:PutObject\"],\"Resource\":[\"arn:aws:s3:::test-bucket/*\"\
        ,\"arn:aws:s3:::test-bucket\"], \"Condition\":{\"Bool\":{\"aws:SecureTransport\"\
        : \"true\"}}},{\"Effect\":\"Allow\",\"Principal\":\"*\",\"Action\":[\"s3:Get*\"\
        ,\"s3:List*\"],\"Condition\":{\"Bool\":{\"aws:SecureTransport\": \"true\"\
        }},\"Resource\":[\"arn:aws:s3:::test-bucket/*\",\"arn:aws:s3:::test-bucket\"\
        ]}]}"
      "PublicAccessBlockConfiguration":
        "BlockPublicAcls": false
        "BlockPublicPolicy": false
        "IgnorePublicAcls": false
        "RestrictPublicBuckets": false
      "Versioning":
  - ExpectedResult: false
    Name: Bucket Uses Allow With Wrong Condition
    Resource:
      "CreationDate": "2019-01-01T00:00:00Z"
      "EncryptionRules":
        - "ApplyServerSideEncryptionByDefault":
            "KMSMasterKeyID":
            "SSEAlgorithm": "AES256"
      "Grants":
      "LifecycleRules":
      "Location": "us-east-2"
      "LoggingPolicy":
      "MFADelete":
      "Name": "bucket-name"
      "Owner":
        "DisplayName": "user.name"
        "ID": "11112223334445556667778899aaabbbcccdddeeee"
      "Policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\"\
        ,\"Principal\":{\"AWS\":\"arn:aws:iam::123456789012:root\"},\"Action\":[\"\
        s3:ListBucket\",\"s3:PutObject\"],\"Resource\":[\"arn:aws:s3:::test-bucket/*\"\
        ,\"arn:aws:s3:::test-bucket\"], \"Condition\":{\"Bool\":{\"aws:SecureTransport\"\
        : \"false\"}}},{\"Effect\":\"Allow\",\"Principal\":\"*\",\"Action\":[\"s3:Get*\"\
        ,\"s3:List*\"],\"Resource\":[\"arn:aws:s3:::test-bucket/*\",\"arn:aws:s3:::test-bucket\"\
        ]}]}"
      "PublicAccessBlockConfiguration":
        "BlockPublicAcls": false
        "BlockPublicPolicy": false
        "IgnorePublicAcls": false
        "RestrictPublicBuckets": false
      "Versioning":
  - ExpectedResult: false
    Name: Bucket Uses Allow Without Condition
    Resource:
      "CreationDate": "2019-01-01T00:00:00Z"
      "EncryptionRules":
        - "ApplyServerSideEncryptionByDefault":
            "KMSMasterKeyID":
            "SSEAlgorithm": "AES256"
      "Grants":
      "LifecycleRules":
      "Location": "us-east-2"
      "LoggingPolicy":
      "MFADelete":
      "Name": "bucket-name"
      "Owner":
        "DisplayName": "user.name"
        "ID": "11112223334445556667778899aaabbbcccdddeeee"
      "Policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Allow\"\
        ,\"Principal\":{\"AWS\":\"arn:aws:iam::123456789012:root\"},\"Action\":[\"\
        s3:ListBucket\",\"s3:PutObject\"],\"Resource\":[\"arn:aws:s3:::test-bucket/*\"\
        ,\"arn:aws:s3:::test-bucket\"]},{\"Effect\":\"Allow\",\"Principal\":\"*\"\
        ,\"Action\":[\"s3:Get*\",\"s3:List*\"],\"Resource\":[\"arn:aws:s3:::test-bucket/*\"\
        ,\"arn:aws:s3:::test-bucket\"]}]}"
      "PublicAccessBlockConfiguration":
        "BlockPublicAcls": false
        "BlockPublicPolicy": false
        "IgnorePublicAcls": false
        "RestrictPublicBuckets": false
      "Versioning":
  - ExpectedResult: false
    Name: Bucket Has No Access Policy
    Resource:
      "CreationDate": "2019-01-01T00:00:00Z"
      "EncryptionRules":
        - "ApplyServerSideEncryptionByDefault":
            "KMSMasterKeyID":
            "SSEAlgorithm": "AES256"
      "Grants":
      "LifecycleRules":
      "Location": "us-east-2"
      "LoggingPolicy":
      "MFADelete":
      "Name": "bucket-name"
      "Owner":
        "DisplayName": "user.name"
        "ID": "11112223334445556667778899aaabbbcccdddeeee"
      "Policy":
      "PublicAccessBlockConfiguration":
        "BlockPublicAcls": false
        "BlockPublicPolicy": false
        "IgnorePublicAcls": false
        "RestrictPublicBuckets": false
      "Versioning":
  - ExpectedResult: true
    Name: Bucket Uses Explicit Deny
    Resource:
      "CreationDate": "2019-01-01T00:00:00Z"
      "EncryptionRules":
        - "ApplyServerSideEncryptionByDefault":
            "KMSMasterKeyID":
            "SSEAlgorithm": "AES256"
      "Grants":
      "LifecycleRules":
      "Location": "us-east-2"
      "LoggingPolicy":
      "MFADelete":
      "Name": "test-bucket"
      "Owner":
        "DisplayName": "user.name"
        "ID": "11112223334445556667778899aaabbbcccdddeeee"
      "Policy": "{\"Version\":\"2012-10-17\",\"Statement\":[{\"Effect\":\"Deny\",\"\
        Principal\": \"*\",\"Action\":[\"s3:ListBucket\",\"s3:PutObject\"],\"Resource\"\
        :[\"arn:aws:s3:::test-bucket/*\",\"arn:aws:s3:::test-bucket\"], \"Condition\"\
        :{\"Bool\":{\"aws:SecureTransport\": \"false\"}}},{\"Effect\":\"Allow\",\"\
        Principal\":\"*\",\"Action\":[\"s3:Get*\",\"s3:List*\"],\"Condition\":{\"\
        Bool\":{\"aws:SecureTransport\": \"true\"}},\"Resource\":[\"arn:aws:s3:::test-bucket/*\"\
        ,\"arn:aws:s3:::test-bucket\"]}]}"
      "PublicAccessBlockConfiguration":
        "BlockPublicAcls": false
        "BlockPublicPolicy": false
        "IgnorePublicAcls": false
        "RestrictPublicBuckets": false
      "Versioning":
