AnalysisType: policy
Description: >-
  This policy validates that Redshift Cluster snapshot retention periods are set to
  an appropriate time. This ensures that records are kept long enough for compliance
  and security reasons, but no too long for compliance and performance reasons.
DisplayName: "AWS Redshift Cluster Has Acceptable Snapshot Retention Period"
Enabled: false
Filename: aws_redshift_cluster_snapshot_retention_acceptable.py
PolicyID: "AWS.Redshift.Cluster.SnapshotRetentionAcceptable"
Reference: https://docs.aws.amazon.com/redshift/latest/mgmt/working-with-snapshots.html
Reports:
  PCI:
    - 3.1
ResourceTypes:
  - AWS.Redshift.Cluster
Runbook: >-
  Adjust the Cluster snapshot retention period to be an appropriate length.
Severity: Low
Tags:
  - AWS
  - PCI
  - Database
Tests:
  - ExpectedResult: false
    Name: Insufficient Backup Retention Period
    Resource:
      "AllowVersionUpgrade": false
      "AutomatedSnapshotRetentionPeriod": 1
      "AvailabilityZone": "us-west-2d"
      "ClusterAvailabilityStatus": "Available"
      "ClusterCreateTime": "2019-01-01T00:00:00.0100Z"
      "ClusterIdentifier": "redshift-cluster-2"
      "ClusterNodes":
        - "NodeRole": "SHARED"
          "PrivateIPAddress": "172.0.0.0"
          "PublicIPAddress": "52.0.0.0"
      "ClusterParameterGroups":
        - "ClusterParameterStatusList":
          "ParameterApplyStatus": "in-sync"
          "ParameterGroupName": "default.redshift-1.0"
      "ClusterPublicKey": "ssh-rsa abcd+111/222/333/444 Amazon-Redshift\n"
      "ClusterRevisionNumber": "8205"
      "ClusterSecurityGroups":
      "ClusterSnapshotCopyStatus":
      "ClusterStatus": "available"
      "ClusterSubnetGroupName": "default"
      "ClusterVersion": "1.0"
      "DBName": "example"
      "DataTransferProgress":
      "DeferredMaintenanceWindows":
      "ElasticIpStatus":
      "ElasticResizeNumberOfNodeOptions":
      "Encrypted": true
      "Endpoint":
        "Address": "redshift-cluster-2.abcdefg.us-west-2.redshift.amazonaws.com"
        "Port": 5439
      "EnhancedVpcRouting": false
      "HsmStatus":
      "IamRoles":
      "KmsKeyId": "arn:aws:kms:us-west-2:123456789012:key/abcdefg-111-222-333"
      "LoggingStatus":
        "BucketName": "example-bucket"
        "LastFailureMessage":
        "LastFailureTime":
        "LastSuccessfulDeliveryTime": "2019-01-01T00:00:00Z"
        "LoggingEnabled": true
        "S3KeyPrefix":
      "MaintenanceTrackName": "current"
      "ManualSnapshotRetentionPeriod": -1
      "MasterUsername": "awsuser"
      "ModifyStatus":
      "NodeType": "dc2.large"
      "NumberOfNodes": 1
      "PendingActions":
      "PendingModifiedValues":
        "AutomatedSnapshotRetentionPeriod":
        "ClusterIdentifier":
        "ClusterType":
        "ClusterVersion":
        "EncryptionType":
        "EnhancedVpcRouting":
        "MaintenanceTrackName":
        "MasterUserPassword":
        "NodeType":
        "NumberOfNodes":
        "PubliclyAccessible":
      "PreferredMaintenanceWindow": "fri:11:30-fri:12:00"
      "PubliclyAccessible": true
      "ResizeInfo":
      "RestoreStatus":
      "SnapshotScheduleIdentifier":
      "SnapshotScheduleState":
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-6aa60b12"
      "VpcSecurityGroups":
  - ExpectedResult: true
    Name: Sufficient Backup Retention Period
    Resource:
      "AllowVersionUpgrade": false
      "AutomatedSnapshotRetentionPeriod": 5
      "AvailabilityZone": "us-west-2d"
      "ClusterAvailabilityStatus": "Available"
      "ClusterCreateTime": "2019-01-01T00:00:00.0100Z"
      "ClusterIdentifier": "redshift-cluster-2"
      "ClusterNodes":
        - "NodeRole": "SHARED"
          "PrivateIPAddress": "172.0.0.0"
          "PublicIPAddress": "52.0.0.0"
      "ClusterParameterGroups":
        - "ClusterParameterStatusList":
          "ParameterApplyStatus": "in-sync"
          "ParameterGroupName": "default.redshift-1.0"
      "ClusterPublicKey": "ssh-rsa abcd+111/222/333/444 Amazon-Redshift\n"
      "ClusterRevisionNumber": "8205"
      "ClusterSecurityGroups":
      "ClusterSnapshotCopyStatus":
      "ClusterStatus": "available"
      "ClusterSubnetGroupName": "default"
      "ClusterVersion": "1.0"
      "DBName": "example"
      "DataTransferProgress":
      "DeferredMaintenanceWindows":
      "ElasticIpStatus":
      "ElasticResizeNumberOfNodeOptions":
      "Encrypted": true
      "Endpoint":
        "Address": "redshift-cluster-2.abcdefg.us-west-2.redshift.amazonaws.com"
        "Port": 5439
      "EnhancedVpcRouting": false
      "HsmStatus":
      "IamRoles":
      "KmsKeyId": "arn:aws:kms:us-west-2:123456789012:key/abcdefg-111-222-333"
      "LoggingStatus":
        "BucketName": "example-bucket"
        "LastFailureMessage":
        "LastFailureTime":
        "LastSuccessfulDeliveryTime": "2019-01-01T00:00:00Z"
        "LoggingEnabled": true
        "S3KeyPrefix":
      "MaintenanceTrackName": "current"
      "ManualSnapshotRetentionPeriod": -1
      "MasterUsername": "awsuser"
      "ModifyStatus":
      "NodeType": "dc2.large"
      "NumberOfNodes": 1
      "PendingActions":
      "PendingModifiedValues":
        "AutomatedSnapshotRetentionPeriod":
        "ClusterIdentifier":
        "ClusterType":
        "ClusterVersion":
        "EncryptionType":
        "EnhancedVpcRouting":
        "MaintenanceTrackName":
        "MasterUserPassword":
        "NodeType":
        "NumberOfNodes":
        "PubliclyAccessible":
      "PreferredMaintenanceWindow": "fri:11:30-fri:12:00"
      "PubliclyAccessible": true
      "ResizeInfo":
      "RestoreStatus":
      "SnapshotScheduleIdentifier":
      "SnapshotScheduleState":
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-6aa60b12"
      "VpcSecurityGroups":
