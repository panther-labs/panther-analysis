AnalysisType: policy
Description: >-
  You can encrypt the snapshot of an EC2 volume to protect against accidental data
  loss
DisplayName: "AWS EC2 Volume Snapshot Encryption"
Enabled: true
Filename: aws_ec2_volume_snapshot_encrypted.py
PolicyID: "AWS.EC2.Volume.Snapshot.Encrypted"
Reference: https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EBSEncryption.html
Reports:
  MITRE ATT&CK:
    - TA0009:T1530
ResourceTypes:
  - AWS.EC2.Volume
Runbook: >-
  https://docs.runpanther.io/alert-runbooks/built-in-policies/aws-ec2-volume-is-encrypted
Severity: High
Tags:
  - AWS
  - Panther
  - Collection:Data From Cloud Storage Object
Tests:
  - ExpectedResult: true
    Name: Volume Snapshot Encrypted
    Resource:
      "ARN": "arn:aws:ec2:ap-southeast-2:123456789012:volume/vol-aaabbbccc123123"
      "AccountId": "123456789012"
      "Attachments":
        - "AttachTime": "2019-04-02T17:16:30Z"
          "DeleteOnTermination": true
          "Device": "/dev/sda1"
          "InstanceId": "instance-aabbcc123"
          "State": "attached"
          "VolumeId": "vol-aaabbbccc123123"
      "AvailabilityZone": "us-west-2b"
      "Encrypted": true
      "ID": "vol-aaabbbccc123123"
      "Iops": 100
      "KmsKeyId": "arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012"
      "Region": "ap-southeast-2"
      "ResourceID": "arn:aws:ec2:ap-southeast-2:123456789012:volume/vol-aaabbbccc123123"
      "ResourceType": "AWS.EC2.Volume"
      "Size": 10
      "SnapshotId": "snap-abcdefg012345"
      "Snapshots":
        - "CreateVolumePermissions":
            - "Group": "GroupName"
              "UserId": "user-123"
          "DataEncryptionKeyId":
          "Description": "Copied for destinationAmi..."
          "Encrypted": true
          "KmsKeyId": "arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012"
          "OwnerAlias":
          "OwnerId": "123456789012"
          "Progress": "100%"
          "SnapshotId": "snapshot-aaabbbccc123123"
          "StartTime": "2019-04-02T17:16:30Z"
          "State": "completed"
          "StateMessage":
          "Tags":
          "VolumeId": "vol-aaabbbccc123123"
          "VolumeSize": 16
        - "CreateVolumePermissions":
            - "Group": "GroupName"
              "UserId": "user-123"
          "DataEncryptionKeyId":
          "Description": "In progress, unencrypted"
          "Encrypted": false
          "KmsKeyId":
          "OwnerAlias":
          "OwnerId": "123456789012"
          "Progress": "80%"
          "SnapshotId": "snapshot-aaabbbccc123123"
          "StartTime": "2019-04-02T17:16:30Z"
          "State": "in-progress"
          "StateMessage":
          "Tags":
          "VolumeId": "vol-aaabbbccc123123"
          "VolumeSize": 16
      "State": "in-use"
      "Tags": {}
      "TimeCreated": "2019-04-02T17:16:30.000Z"
      "VolumeId": "vol-aaabbbccc123123"
      "VolumeType": "gp2"
  - ExpectedResult: false
    Name: Volume Snapshot Not Encrypted
    Resource:
      "ARN": "arn:aws:ec2:ap-southeast-2:123456789012:volume/vol-aaabbbccc123123"
      "AccountId": "123456789012"
      "Attachments":
        - "AttachTime": "2019-04-02T17:16:30Z"
          "DeleteOnTermination": true
          "Device": "/dev/sda1"
          "InstanceId": "instance-aabbcc123"
          "State": "attached"
          "VolumeId": "vol-aaabbbccc123123"
      "AvailabilityZone": "us-west-2b"
      "Encrypted": false
      "ID": "vol-aaabbbccc123123"
      "Iops": 100
      "KmsKeyId":
      "Region": "ap-southeast-2"
      "ResourceID": "arn:aws:ec2:ap-southeast-2:123456789012:volume/vol-aaabbbccc123123"
      "ResourceType": "AWS.EC2.Volume"
      "Size": 10
      "SnapshotId": "snap-abcdefg012345"
      "Snapshots":
        - "CreateVolumePermissions":
            - "Group": "GroupName"
              "UserId": "user-123"
          "DataEncryptionKeyId":
          "Description": "Copied for destinationAmi..."
          "Encrypted": false
          "KmsKeyId":
          "OwnerAlias":
          "OwnerId": "123456789012"
          "Progress": "100%"
          "SnapshotId": "snapshot-aaabbbccc123123"
          "StartTime": "2019-04-02T17:16:30Z"
          "State": "completed"
          "StateMessage":
          "Tags":
          "VolumeId": "vol-aaabbbccc123123"
          "VolumeSize": 16
        - "CreateVolumePermissions":
            - "Group": "GroupName"
              "UserId": "user-123"
          "DataEncryptionKeyId":
          "Description": "Copied for destinationAmi..."
          "Encrypted": true
          "KmsKeyId": "arn:aws:kms:us-east-1:123456789012:key/12345678-1234-1234-1234-123456789012"
          "OwnerAlias":
          "OwnerId": "123456789012"
          "Progress": "100%"
          "SnapshotId": "snapshot-aaabbbccc123123"
          "StartTime": "2019-04-02T17:16:30Z"
          "State": "completed"
          "StateMessage":
          "Tags":
          "VolumeId": "vol-aaabbbccc123123"
          "VolumeSize": 16
      "State": "in-use"
      "Tags": {}
      "TimeCreated": "2019-04-02T17:16:30.000Z"
      "VolumeId": "vol-aaabbbccc123123"
      "VolumeType": "gp2"
  - ExpectedResult: true
    Name: No Snapshots
    Resource:
      "ARN": "arn:aws:ec2:ap-southeast-2:123456789012:volume/vol-aaabbbccc123123"
      "AccountId": "123456789012"
      "Attachments":
        - "AttachTime": "2019-04-02T17:16:30Z"
          "DeleteOnTermination": true
          "Device": "/dev/sda1"
          "InstanceId": "instance-aabbcc123"
          "State": "attached"
          "VolumeId": "vol-aaabbbccc123123"
      "AvailabilityZone": "us-west-2b"
      "Encrypted": false
      "ID": "vol-aaabbbccc123123"
      "Iops": 100
      "KmsKeyId":
      "Region": "ap-southeast-2"
      "ResourceID": "arn:aws:ec2:ap-southeast-2:123456789012:volume/vol-aaabbbccc123123"
      "ResourceType": "AWS.EC2.Volume"
      "Size": 10
      "SnapshotId": "snap-abcdefg012345"
      "Snapshots":
      "State": "in-use"
      "Tags": {}
      "TimeCreated": "2019-04-02T17:16:30.000Z"
      "VolumeId": "vol-aaabbbccc123123"
      "VolumeType": "gp2"
