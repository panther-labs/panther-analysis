AnalysisType: policy
Description: >-
  This policy ensures that at least one CloudTrail has management (control plane)
  operations logged.
DisplayName: "AWS CloudTrail Management Events Enabled"
Enabled: true
Filename: aws_cloudtrail_enabled.py
PolicyID: "AWS.CloudTrail.Enabled"
Reference: 
  https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-user-guide.html
Reports:
  CIS:
    - 2.1
  MITRE ATT&CK:
    - TA0005:T1562
  PCI:
    - 10.5.4
ResourceTypes:
  - AWS.CloudTrail.Meta
Runbook: >-
  https://docs.runpanther.io/alert-runbooks/built-in-policies/aws-cloudtrail-enabled-in-all-regions
Severity: High
Tags:
  - AWS
  - Security Control
  - Defense Evasion:Impair Defenses
Tests:
  - ExpectedResult: true
    Name: Global CloudTrail Is Enabled
    Resource:
      "GlobalEventSelectors":
        - "DataResources":
          "IncludeManagementEvents": true
          "ReadWriteType": "All"
        - "DataResources":
            - "Type": "AWS::S3::Object"
              "Values":
                - "arn:aws:s3"
          "IncludeManagementEvents": true
          "ReadWriteType": "All"
      "Trails":
        - "trail1"
  - ExpectedResult: false
    Name: CloudTrail Enabled with ReadOnly Management Events
    Resource:
      "GlobalEventSelectors":
        - "DataResources":
          "IncludeManagementEvents": true
          "ReadWriteType": "Read"
      "Trails":
        - "trail1"
  - ExpectedResult: false
    Name: No Global CloudTrail Enabled
    Resource:
      "GlobalEventSelectors":
      "Trails": []
  - ExpectedResult: true
    Name: Advanced Selector With Management
    Resource:
      "GlobalAdvancedEventSelectors":
        - "FieldSelectors":
            - "Equals":
                - "Management"
              "Field": "eventCategory"
          "Name": "Management events selector"
        - "FieldSelectors":
            - "Equals":
                - "Data"
              "Field": "eventCategory"
            - "Equals":
                - "AWS::Lambda::Function"
              "Field": "resources.type"
          "Name": "LambdaDataEvents"
        - "FieldSelectors":
            - "Equals":
                - "Data"
              "Field": "eventCategory"
            - "Field": "eventName"
              "NotEquals":
                - "HeadObject"
                - "UploadPart"
            - "Equals":
                - "AWS::S3::Object"
              "Field": "resources.type"
          "Name": "S3DataEvents"
      "Trails":
        - "arn:aws:cloudtrail:us-east-1:123456789012:trail/write_to_bucket"
  - ExpectedResult: false
    Name: Advanced Selector With Management and readOnly
    Resource:
      "GlobalAdvancedEventSelectors":
        - "FieldSelectors":
            - "Equals":
                - "Management"
              "Field": "eventCategory"
            - "Equals":
                - "true"
              "Field": "readOnly"
          "Name": "Management events selector"
        - "FieldSelectors":
            - "Equals":
                - "Data"
              "Field": "eventCategory"
            - "Equals":
                - "AWS::Lambda::Function"
              "Field": "resources.type"
          "Name": "LambdaDataEvents"
        - "FieldSelectors":
            - "Equals":
                - "Data"
              "Field": "eventCategory"
            - "Field": "eventName"
              "NotEquals":
                - "HeadObject"
                - "UploadPart"
            - "Equals":
                - "AWS::S3::Object"
              "Field": "resources.type"
          "Name": "S3DataEvents"
      "Trails":
        - "arn:aws:cloudtrail:us-east-1:123456789012:trail/write_to_bucket"
  - ExpectedResult: true
    Name: None Global Selector, Valid Advanced Selector
    Resource:
      "AccountId": "123456789012"
      "GlobalAdvancedEventSelectors":
        - "FieldSelectors":
            - "EndsWith":
              "Equals":
                - "Data"
              "Field": "eventCategory"
              "NotEndsWith":
              "NotEquals":
              "NotStartsWith":
              "StartsWith":
            - "EndsWith":
              "Equals":
              "Field": "eventName"
              "NotEndsWith":
              "NotEquals":
                - "UploadPart"
                - "HeadObject"
              "NotStartsWith":
              "StartsWith":
            - "EndsWith":
              "Equals":
                - "AWS::S3::Object"
              "Field": "resources.type"
              "NotEndsWith":
              "NotEquals":
              "NotStartsWith":
              "StartsWith":
          "Name": "S3DataEvents"
        - "FieldSelectors":
            - "EndsWith":
              "Equals":
                - "Data"
              "Field": "eventCategory"
              "NotEndsWith":
              "NotEquals":
              "NotStartsWith":
              "StartsWith":
            - "EndsWith":
              "Equals":
                - "AWS::Lambda::Function"
              "Field": "resources.type"
              "NotEndsWith":
              "NotEquals":
              "NotStartsWith":
              "StartsWith":
          "Name": "LambdaDataEvents"
        - "FieldSelectors":
            - "EndsWith":
              "Equals":
                - "Management"
              "Field": "eventCategory"
              "NotEndsWith":
              "NotEquals":
              "NotStartsWith":
              "StartsWith":
          "Name": "Management events selector"
      "GlobalEventSelectors":
      "Name": "AWS.CloudTrail.Meta"
      "Region": "global"
      "ResourceId": "123456789012::AWS.CloudTrail.Meta"
      "ResourceType": "AWS.CloudTrail.Meta"
      "Trails":
        - "arn:aws:cloudtrail:us-east-1:123456789012/bucket"
