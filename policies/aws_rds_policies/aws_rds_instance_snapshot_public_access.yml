AnalysisType: policy
Description: >-
  This policy validates that RDS Instance snapshots are not publicly restorable. This
  would allow anyone to restore an old version of your database and have full access
  to its contents.
DisplayName: "AWS RDS Instance Snapshot Public Access"
Enabled: true
Filename: aws_rds_instance_snapshot_public_access.py
PolicyID: "AWS.RDS.Instance.SnapshotPublicAccess"
Reference: 
  https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_WorkingWithAutomatedBackups.html
Reports:
  MITRE ATT&CK:
    - TA0010:T1567
ResourceTypes:
  - AWS.RDS.Instance
Runbook: >-
  https://docs.runpanther.io/alert-runbooks/built-in-policies/aws-rds-instance-snapshots-are-not-publicly-accessible
Severity: Critical
Tags:
  - AWS
  - Data Protection
  - Exfiltration:Exfiltration Over Web Service
Tests:
  - ExpectedResult: true
    Name: Instance Has No Snapshots
    Resource:
      "AllocatedStorage": 20
      "AssociatedRoles":
      "AutoMinorVersionUpgrade": true
      "AvailabilityZone": "us-west-2a"
      "BackupRetentionPeriod": 7
      "CACertificateIdentifier": "rds-ca-2015"
      "CharacterSetName":
      "CopyTagsToSnapshot": false
      "DBClusterIdentifier":
      "DBInstanceArn": "arn:aws:rds:us-west-2:123456789012:db:example-instance"
      "DBInstanceClass": "db.m4.xlarge"
      "DBInstanceIdentifier": "example-instance"
      "DBInstanceStatus": "available"
      "DBName": "db_1"
      "DBParameterGroups":
        - "DBParameterGroupName": "default.mysql5.7"
          "ParameterApplyStatus": "in-sync"
      "DBSecurityGroups":
      "DBSubnetGroup":
        "DBSubnetGroupArn":
        "DBSubnetGroupDescription": "default"
        "DBSubnetGroupName": "default"
        "SubnetGroupStatus": "Complete"
        "Subnets":
          - "SubnetAvailabilityZone":
              "Name": "us-west-2b"
            "SubnetIdentifier": "subnet-111222333"
            "SubnetStatus": "Active"
          - "SubnetAvailabilityZone":
              "Name": "us-west-2d"
            "SubnetIdentifier": "subnet-444555666"
            "SubnetStatus": "Active"
        "VpcId": "vpc-111222333"
      "DbInstancePort": 0
      "DbiResourceId": "db-ABCDEFGHIJKLMNOP"
      "DeletionProtection": false
      "DomainMemberships":
      "EnabledCloudwatchLogsExports":
      "Endpoint":
        "Address": "example-instance.abcdefghijkl.us-west-2.rds.amazonaws.com"
        "HostedZoneId": "ABCDEF1234"
        "Port": 3306
      "Engine": "mysql"
      "EngineVersion": "5.7.22"
      "EnhancedMonitoringResourceArn":
      "IAMDatabaseAuthenticationEnabled": false
      "InstanceCreateTime": "2019-01-01T00:00:00.000Z"
      "Iops":
      "KmsKeyId": "arn:aws:kms:us-west-2:123456789012:key/111222333"
      "LatestRestorableTime": "2019-01-01T00:00:00Z"
      "LicenseModel": "general-public-license"
      "ListenerEndpoint":
      "MasterUsername": "superuser"
      "MaxAllocatedStorage":
      "MonitoringInterval": 0
      "MonitoringRoleArn":
      "MultiAZ": false
      "OptionGroupMemberships":
        - "OptionGroupName": "default:mysql-5-7"
          "Status": "in-sync"
      "PendingModifiedValues":
        "AllocatedStorage":
        "BackupRetentionPeriod":
        "CACertificateIdentifier":
        "DBInstanceClass":
        "DBInstanceIdentifier":
        "DBSubnetGroupName":
        "EngineVersion":
        "Iops":
        "LicenseModel":
        "MasterUserPassword":
        "MultiAZ":
        "PendingCloudwatchLogsExports":
        "Port":
        "ProcessorFeatures":
        "StorageType":
      "PerformanceInsightsEnabled": false
      "PerformanceInsightsKMSKeyId":
      "PerformanceInsightsRetentionPeriod":
      "PreferredBackupWindow": "07:31-08:01"
      "PreferredMaintenanceWindow": "thu:12:02-thu:12:32"
      "ProcessorFeatures":
      "PromotionTier":
      "PubliclyAccessible": true
      "ReadReplicaDBClusterIdentifiers":
      "ReadReplicaDBInstanceIdentifiers":
      "ReadReplicaSourceDBInstanceIdentifier":
      "SecondaryAvailabilityZone":
      "SnapshotAttributes":
      "StatusInfos":
      "StorageEncrypted": true
      "StorageType": "gp2"
      "TdeCredentialArn":
      "Timezone":
      "VpcSecurityGroups":
        - "Status": "active"
          "VpcSecurityGroupId": "sg-112233"
  - ExpectedResult: false
    Name: Instance Snapshot Can Be Returned By All
    Resource:
      "AllocatedStorage": 20
      "AssociatedRoles":
      "AutoMinorVersionUpgrade": true
      "AvailabilityZone": "us-west-2a"
      "BackupRetentionPeriod": 7
      "CACertificateIdentifier": "rds-ca-2015"
      "CharacterSetName":
      "CopyTagsToSnapshot": false
      "DBClusterIdentifier":
      "DBInstanceArn": "arn:aws:rds:us-west-2:123456789012:db:example-instance"
      "DBInstanceClass": "db.m4.xlarge"
      "DBInstanceIdentifier": "example-instance"
      "DBInstanceStatus": "available"
      "DBName": "db_1"
      "DBParameterGroups":
        - "DBParameterGroupName": "default.mysql5.7"
          "ParameterApplyStatus": "in-sync"
      "DBSecurityGroups":
      "DBSubnetGroup":
        "DBSubnetGroupArn":
        "DBSubnetGroupDescription": "default"
        "DBSubnetGroupName": "default"
        "SubnetGroupStatus": "Complete"
        "Subnets":
          - "SubnetAvailabilityZone":
              "Name": "us-west-2b"
            "SubnetIdentifier": "subnet-111222333"
            "SubnetStatus": "Active"
          - "SubnetAvailabilityZone":
              "Name": "us-west-2d"
            "SubnetIdentifier": "subnet-444555666"
            "SubnetStatus": "Active"
        "VpcId": "vpc-111222333"
      "DbInstancePort": 0
      "DbiResourceId": "db-ABCDEFGHIJKLMNOP"
      "DeletionProtection": false
      "DomainMemberships":
      "EnabledCloudwatchLogsExports":
      "Endpoint":
        "Address": "example-instance.abcdefghijkl.us-west-2.rds.amazonaws.com"
        "HostedZoneId": "ABCDEF1234"
        "Port": 3306
      "Engine": "mysql"
      "EngineVersion": "5.7.22"
      "EnhancedMonitoringResourceArn":
      "IAMDatabaseAuthenticationEnabled": false
      "InstanceCreateTime": "2019-01-01T00:00:00.000Z"
      "Iops":
      "KmsKeyId": "arn:aws:kms:us-west-2:123456789012:key/111222333"
      "LatestRestorableTime": "2019-01-01T00:00:00Z"
      "LicenseModel": "general-public-license"
      "ListenerEndpoint":
      "MasterUsername": "superuser"
      "MaxAllocatedStorage":
      "MonitoringInterval": 0
      "MonitoringRoleArn":
      "MultiAZ": false
      "OptionGroupMemberships":
        - "OptionGroupName": "default:mysql-5-7"
          "Status": "in-sync"
      "PendingModifiedValues":
        "AllocatedStorage":
        "BackupRetentionPeriod":
        "CACertificateIdentifier":
        "DBInstanceClass":
        "DBInstanceIdentifier":
        "DBSubnetGroupName":
        "EngineVersion":
        "Iops":
        "LicenseModel":
        "MasterUserPassword":
        "MultiAZ":
        "PendingCloudwatchLogsExports":
        "Port":
        "ProcessorFeatures":
        "StorageType":
      "PerformanceInsightsEnabled": false
      "PerformanceInsightsKMSKeyId":
      "PerformanceInsightsRetentionPeriod":
      "PreferredBackupWindow": "07:31-08:01"
      "PreferredMaintenanceWindow": "thu:12:02-thu:12:32"
      "ProcessorFeatures":
      "PromotionTier":
      "PubliclyAccessible": true
      "ReadReplicaDBClusterIdentifiers":
      "ReadReplicaDBInstanceIdentifiers":
      "ReadReplicaSourceDBInstanceIdentifier":
      "SecondaryAvailabilityZone":
      "SnapshotAttributes":
        - "DBSnapshotAttributes":
            - "AttributeName": "restore"
              "AttributeValues":
          "DBSnapshotIdentifier": "rds:example-instance-2019-01-01-07-36"
        - "DBSnapshotAttributes":
            - "AttributeName": "restore"
              "AttributeValues": "all"
          "DBSnapshotIdentifier": "rds:example-instance-2019-01-08-07-36"
      "StatusInfos":
      "StorageEncrypted": true
      "StorageType": "gp2"
      "TdeCredentialArn":
      "Timezone":
      "VpcSecurityGroups":
        - "Status": "active"
          "VpcSecurityGroupId": "sg-112233"
  - ExpectedResult: false
    Name: Instance Snapshot Can Be Returned By All In List
    Resource:
      "AllocatedStorage": 20
      "AssociatedRoles":
      "AutoMinorVersionUpgrade": true
      "AvailabilityZone": "us-west-2a"
      "BackupRetentionPeriod": 7
      "CACertificateIdentifier": "rds-ca-2015"
      "CharacterSetName":
      "CopyTagsToSnapshot": false
      "DBClusterIdentifier":
      "DBInstanceArn": "arn:aws:rds:us-west-2:123456789012:db:example-instance"
      "DBInstanceClass": "db.m4.xlarge"
      "DBInstanceIdentifier": "example-instance"
      "DBInstanceStatus": "available"
      "DBName": "db_1"
      "DBParameterGroups":
        - "DBParameterGroupName": "default.mysql5.7"
          "ParameterApplyStatus": "in-sync"
      "DBSecurityGroups":
      "DBSubnetGroup":
        "DBSubnetGroupArn":
        "DBSubnetGroupDescription": "default"
        "DBSubnetGroupName": "default"
        "SubnetGroupStatus": "Complete"
        "Subnets":
          - "SubnetAvailabilityZone":
              "Name": "us-west-2b"
            "SubnetIdentifier": "subnet-111222333"
            "SubnetStatus": "Active"
          - "SubnetAvailabilityZone":
              "Name": "us-west-2d"
            "SubnetIdentifier": "subnet-444555666"
            "SubnetStatus": "Active"
        "VpcId": "vpc-111222333"
      "DbInstancePort": 0
      "DbiResourceId": "db-ABCDEFGHIJKLMNOP"
      "DeletionProtection": false
      "DomainMemberships":
      "EnabledCloudwatchLogsExports":
      "Endpoint":
        "Address": "example-instance.abcdefghijkl.us-west-2.rds.amazonaws.com"
        "HostedZoneId": "ABCDEF1234"
        "Port": 3306
      "Engine": "mysql"
      "EngineVersion": "5.7.22"
      "EnhancedMonitoringResourceArn":
      "IAMDatabaseAuthenticationEnabled": false
      "InstanceCreateTime": "2019-01-01T00:00:00.000Z"
      "Iops":
      "KmsKeyId": "arn:aws:kms:us-west-2:123456789012:key/111222333"
      "LatestRestorableTime": "2019-01-01T00:00:00Z"
      "LicenseModel": "general-public-license"
      "ListenerEndpoint":
      "MasterUsername": "superuser"
      "MaxAllocatedStorage":
      "MonitoringInterval": 0
      "MonitoringRoleArn":
      "MultiAZ": false
      "OptionGroupMemberships":
        - "OptionGroupName": "default:mysql-5-7"
          "Status": "in-sync"
      "PendingModifiedValues":
        "AllocatedStorage":
        "BackupRetentionPeriod":
        "CACertificateIdentifier":
        "DBInstanceClass":
        "DBInstanceIdentifier":
        "DBSubnetGroupName":
        "EngineVersion":
        "Iops":
        "LicenseModel":
        "MasterUserPassword":
        "MultiAZ":
        "PendingCloudwatchLogsExports":
        "Port":
        "ProcessorFeatures":
        "StorageType":
      "PerformanceInsightsEnabled": false
      "PerformanceInsightsKMSKeyId":
      "PerformanceInsightsRetentionPeriod":
      "PreferredBackupWindow": "07:31-08:01"
      "PreferredMaintenanceWindow": "thu:12:02-thu:12:32"
      "ProcessorFeatures":
      "PromotionTier":
      "PubliclyAccessible": true
      "ReadReplicaDBClusterIdentifiers":
      "ReadReplicaDBInstanceIdentifiers":
      "ReadReplicaSourceDBInstanceIdentifier":
      "SecondaryAvailabilityZone":
      "SnapshotAttributes":
        - "DBSnapshotAttributes":
            - "AttributeName": "restore"
              "AttributeValues":
          "DBSnapshotIdentifier": "rds:example-instance-2019-01-01-07-36"
        - "DBSnapshotAttributes":
            - "AttributeName": "restore"
              "AttributeValues":
                - "some"
                - "all"
          "DBSnapshotIdentifier": "rds:example-instance-2019-01-08-07-36"
      "StatusInfos":
      "StorageEncrypted": true
      "StorageType": "gp2"
      "TdeCredentialArn":
      "Timezone":
      "VpcSecurityGroups":
        - "Status": "active"
          "VpcSecurityGroupId": "sg-112233"
  - ExpectedResult: true
    Name: Instance Snapshot Can Be Returned By Some
    Resource:
      "AllocatedStorage": 20
      "AssociatedRoles":
      "AutoMinorVersionUpgrade": true
      "AvailabilityZone": "us-west-2a"
      "BackupRetentionPeriod": 7
      "CACertificateIdentifier": "rds-ca-2015"
      "CharacterSetName":
      "CopyTagsToSnapshot": false
      "DBClusterIdentifier":
      "DBInstanceArn": "arn:aws:rds:us-west-2:123456789012:db:example-instance"
      "DBInstanceClass": "db.m4.xlarge"
      "DBInstanceIdentifier": "example-instance"
      "DBInstanceStatus": "available"
      "DBName": "db_1"
      "DBParameterGroups":
        - "DBParameterGroupName": "default.mysql5.7"
          "ParameterApplyStatus": "in-sync"
      "DBSecurityGroups":
      "DBSubnetGroup":
        "DBSubnetGroupArn":
        "DBSubnetGroupDescription": "default"
        "DBSubnetGroupName": "default"
        "SubnetGroupStatus": "Complete"
        "Subnets":
          - "SubnetAvailabilityZone":
              "Name": "us-west-2b"
            "SubnetIdentifier": "subnet-111222333"
            "SubnetStatus": "Active"
          - "SubnetAvailabilityZone":
              "Name": "us-west-2d"
            "SubnetIdentifier": "subnet-444555666"
            "SubnetStatus": "Active"
        "VpcId": "vpc-111222333"
      "DbInstancePort": 0
      "DbiResourceId": "db-ABCDEFGHIJKLMNOP"
      "DeletionProtection": false
      "DomainMemberships":
      "EnabledCloudwatchLogsExports":
      "Endpoint":
        "Address": "example-instance.abcdefghijkl.us-west-2.rds.amazonaws.com"
        "HostedZoneId": "ABCDEF1234"
        "Port": 3306
      "Engine": "mysql"
      "EngineVersion": "5.7.22"
      "EnhancedMonitoringResourceArn":
      "IAMDatabaseAuthenticationEnabled": false
      "InstanceCreateTime": "2019-01-01T00:00:00.000Z"
      "Iops":
      "KmsKeyId": "arn:aws:kms:us-west-2:123456789012:key/111222333"
      "LatestRestorableTime": "2019-01-01T00:00:00Z"
      "LicenseModel": "general-public-license"
      "ListenerEndpoint":
      "MasterUsername": "superuser"
      "MaxAllocatedStorage":
      "MonitoringInterval": 0
      "MonitoringRoleArn":
      "MultiAZ": false
      "OptionGroupMemberships":
        - "OptionGroupName": "default:mysql-5-7"
          "Status": "in-sync"
      "PendingModifiedValues":
        "AllocatedStorage":
        "BackupRetentionPeriod":
        "CACertificateIdentifier":
        "DBInstanceClass":
        "DBInstanceIdentifier":
        "DBSubnetGroupName":
        "EngineVersion":
        "Iops":
        "LicenseModel":
        "MasterUserPassword":
        "MultiAZ":
        "PendingCloudwatchLogsExports":
        "Port":
        "ProcessorFeatures":
        "StorageType":
      "PerformanceInsightsEnabled": false
      "PerformanceInsightsKMSKeyId":
      "PerformanceInsightsRetentionPeriod":
      "PreferredBackupWindow": "07:31-08:01"
      "PreferredMaintenanceWindow": "thu:12:02-thu:12:32"
      "ProcessorFeatures":
      "PromotionTier":
      "PubliclyAccessible": true
      "ReadReplicaDBClusterIdentifiers":
      "ReadReplicaDBInstanceIdentifiers":
      "ReadReplicaSourceDBInstanceIdentifier":
      "SecondaryAvailabilityZone":
      "SnapshotAttributes":
        - "DBSnapshotAttributes":
            - "AttributeName": "restore"
              "AttributeValues":
          "DBSnapshotIdentifier": "rds:example-instance-2019-01-01-07-36"
        - "DBSnapshotAttributes":
            - "AttributeName": "restore"
              "AttributeValues": "some"
          "DBSnapshotIdentifier": "rds:example-instance-2019-01-08-07-36"
      "StatusInfos":
      "StorageEncrypted": true
      "StorageType": "gp2"
      "TdeCredentialArn":
      "Timezone":
      "VpcSecurityGroups":
        - "Status": "active"
          "VpcSecurityGroupId": "sg-112233"
  - ExpectedResult: true
    Name: Instance Snapshot Cannot Be Restored By All
    Resource:
      "AllocatedStorage": 20
      "AssociatedRoles":
      "AutoMinorVersionUpgrade": true
      "AvailabilityZone": "us-west-2a"
      "BackupRetentionPeriod": 7
      "CACertificateIdentifier": "rds-ca-2015"
      "CharacterSetName":
      "CopyTagsToSnapshot": false
      "DBClusterIdentifier":
      "DBInstanceArn": "arn:aws:rds:us-west-2:123456789012:db:example-instance"
      "DBInstanceClass": "db.m4.xlarge"
      "DBInstanceIdentifier": "example-instance"
      "DBInstanceStatus": "available"
      "DBName": "db_1"
      "DBParameterGroups":
        - "DBParameterGroupName": "default.mysql5.7"
          "ParameterApplyStatus": "in-sync"
      "DBSecurityGroups":
      "DBSubnetGroup":
        "DBSubnetGroupArn":
        "DBSubnetGroupDescription": "default"
        "DBSubnetGroupName": "default"
        "SubnetGroupStatus": "Complete"
        "Subnets":
          - "SubnetAvailabilityZone":
              "Name": "us-west-2b"
            "SubnetIdentifier": "subnet-111222333"
            "SubnetStatus": "Active"
          - "SubnetAvailabilityZone":
              "Name": "us-west-2d"
            "SubnetIdentifier": "subnet-444555666"
            "SubnetStatus": "Active"
        "VpcId": "vpc-111222333"
      "DbInstancePort": 0
      "DbiResourceId": "db-ABCDEFGHIJKLMNOP"
      "DeletionProtection": false
      "DomainMemberships":
      "EnabledCloudwatchLogsExports":
      "Endpoint":
        "Address": "example-instance.abcdefghijkl.us-west-2.rds.amazonaws.com"
        "HostedZoneId": "ABCDEF1234"
        "Port": 3306
      "Engine": "mysql"
      "EngineVersion": "5.7.22"
      "EnhancedMonitoringResourceArn":
      "IAMDatabaseAuthenticationEnabled": false
      "InstanceCreateTime": "2019-01-01T00:00:00.000Z"
      "Iops":
      "KmsKeyId": "arn:aws:kms:us-west-2:123456789012:key/111222333"
      "LatestRestorableTime": "2019-01-01T00:00:00Z"
      "LicenseModel": "general-public-license"
      "ListenerEndpoint":
      "MasterUsername": "superuser"
      "MaxAllocatedStorage":
      "MonitoringInterval": 0
      "MonitoringRoleArn":
      "MultiAZ": false
      "OptionGroupMemberships":
        - "OptionGroupName": "default:mysql-5-7"
          "Status": "in-sync"
      "PendingModifiedValues":
        "AllocatedStorage":
        "BackupRetentionPeriod":
        "CACertificateIdentifier":
        "DBInstanceClass":
        "DBInstanceIdentifier":
        "DBSubnetGroupName":
        "EngineVersion":
        "Iops":
        "LicenseModel":
        "MasterUserPassword":
        "MultiAZ":
        "PendingCloudwatchLogsExports":
        "Port":
        "ProcessorFeatures":
        "StorageType":
      "PerformanceInsightsEnabled": false
      "PerformanceInsightsKMSKeyId":
      "PerformanceInsightsRetentionPeriod":
      "PreferredBackupWindow": "07:31-08:01"
      "PreferredMaintenanceWindow": "thu:12:02-thu:12:32"
      "ProcessorFeatures":
      "PromotionTier":
      "PubliclyAccessible": true
      "ReadReplicaDBClusterIdentifiers":
      "ReadReplicaDBInstanceIdentifiers":
      "ReadReplicaSourceDBInstanceIdentifier":
      "SecondaryAvailabilityZone":
      "SnapshotAttributes":
        - "DBSnapshotAttributes":
            - "AttributeName": "restore"
              "AttributeValues":
          "DBSnapshotIdentifier": "rds:example-instance-2019-01-01-07-36"
        - "DBSnapshotAttributes":
            - "AttributeName": "restore"
              "AttributeValues":
          "DBSnapshotIdentifier": "rds:example-instance-2019-01-08-07-36"
      "StatusInfos":
      "StorageEncrypted": true
      "StorageType": "gp2"
      "TdeCredentialArn":
      "Timezone":
      "VpcSecurityGroups":
        - "Status": "active"
          "VpcSecurityGroupId": "sg-112233"
