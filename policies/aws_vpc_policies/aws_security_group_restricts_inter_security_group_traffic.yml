AnalysisType: policy
Description: >-
  This policy validates that Security Groups have restrictions on inter Security Group
  traffic. Administrators may assume there is an implicit level of trust between Security
  Groups in the same account, but this is not always a good assumption in cases one
  Security Group contains far more sensitive data that another.
DisplayName: "AWS Security Group Restricts Inter-SG Traffic"
Enabled: false
Filename: aws_security_group_restricts_inter_security_group_traffic.py
PolicyID: "AWS.SecurityGroup.RestrictsInterSecurityGroupTraffic"
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-services-ec2-sg.html
Reports:
  MITRE ATT&CK:
    - TA0008:T1210
  PCI:
    - 1.2.1
ResourceTypes:
  - AWS.EC2.SecurityGroup
Runbook: >-
  Add appropriate restrictions to the Security Group peering connection.
Severity: Low
Tags:
  - AWS
  - PCI
  - Lateral Movement:Exploitation of Remote Services
Tests:
  - ExpectedResult: true
    Name: Security Group Restricts Inter Security Group Traffic
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort": 80
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort": 80
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
  - ExpectedResult: false
    Name: Security Group Does Not Restrict Inter Security Group Traffic
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
  - ExpectedResult: true
    Name: Security Group Does Not Restrict Internet Traffic
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
