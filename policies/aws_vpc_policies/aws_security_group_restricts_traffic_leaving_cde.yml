AnalysisType: policy
Description: >-
  This policy validates that there are restrictions on what type of traffic may leave
  Security Groups that are considered with the scope of the PCI CDE. These restrictions
  help ensure that cardholder data does not leave the CDE.
DisplayName: "AWS Security Group Restricts Traffic Leaving CDE"
Enabled: false
Filename: aws_security_group_restricts_traffic_leaving_cde.py
PolicyID: "AWS.SecurityGroup.RestrictsTrafficLeavingCDE"
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-services-ec2-sg.html
Reports:
  MITRE ATT&CK:
    - TA0010:T1567
ResourceTypes:
  - AWS.EC2.SecurityGroup
Runbook: >-
  Add appropriate restrictions to traffic leaving Security Groups considered a part
  of the CDE.
Severity: Medium
Tags:
  - AWS
  - PCI
  - Exfiltration:Exfiltration Over Web Service
Tests:
  - ExpectedResult: true
    Name: Security Group Restricts Traffic Leaving CDE
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
      "IpPermissionsEgress":
        - "FromPort": 22
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "10.0.10.0/24"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort": 22
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
  - ExpectedResult: false
    Name: Security Group Does Not Restrict Traffic Leaving CDE
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
