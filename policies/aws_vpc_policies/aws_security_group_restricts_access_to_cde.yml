AnalysisType: policy
Description: >-
  This policy validates that are considered part of the PCI CDE do not allow any access
  from public IP space.
DisplayName: "AWS Security Group Restricts Access To CDE"
Enabled: false
Filename: aws_security_group_restricts_access_to_cde.py
PolicyID: "AWS.SecurityGroup.RestrictsAccessToCDE"
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-services-ec2-sg.html
Reports:
  MITRE ATT&CK:
    - TA0001:T1190
  PCI:
    - 1.3.2
    - 1.3.5
ResourceTypes:
  - AWS.EC2.SecurityGroup
Runbook: >-
  Remove any IP permissions allowing inbound traffic from Public IP space to the CDE.
Severity: Medium
Tags:
  - AWS
  - PCI
  - Initial Access:Exploit Public-Facing Application
Tests:
  - ExpectedResult: true
    Name: In Scope Security Group Restricts Access
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "10.0.1.0/24"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
  - ExpectedResult: false
    Name: In Scope Security Group Does Not Restrict Access
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "1.1.1.1/32"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "192.0.2.0/24"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
  - ExpectedResult: true
    Name: Out Of Scope Security Group Does Not Restrict Access
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "192.0.2.0/24"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "192.0.2.0/24"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "dmz"
      "VpcId": "vpc-abc111222333"
