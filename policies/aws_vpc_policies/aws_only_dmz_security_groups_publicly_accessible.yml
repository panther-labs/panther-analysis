AnalysisType: policy
Description: >-
  This policy validates that only Security Groups designated as DMZs allow inbound
  traffic from public IP space. This helps ensure no traffic is bypassing the DMZ.
DisplayName: "AWS Security Group - Only DMZ Publicly Accessible"
Enabled: false
Filename: aws_only_dmz_security_groups_publicly_accessible.py
PolicyID: "AWS.SecurityGroup.OnlyDMZPubliclyAccessible"
Reference: https://en.wikipedia.org/wiki/DMZ_(computing)
Reports:
  MITRE ATT&CK:
    - TA0001:T1190
  PCI:
    - 1.3.1
    - 1.1.4
ResourceTypes:
  - AWS.EC2.SecurityGroup
Runbook: >-
  Remove the IP permissions in non-DMZ Security Groups that are allowing inbound traffic
  from public IP space.
Severity: Medium
Tags:
  - AWS
  - PCI
  - Initial Access:Exploit Public-Facing Application
Tests:
  - ExpectedResult: true
    Mocks:
      - objectName: DMZ_TAGS
        returnValue: '[["environment", "dmz"]]'
    Name: DMZ Security Group Does Allows Public Access
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "1.0.0.0/24"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "dmz"
      "VpcId": "vpc-abc111222333"
  - ExpectedResult: false
    Mocks:
      - objectName: DMZ_TAGS
        returnValue: '[["environment", "dmz"]]'
    Name: Non DMZ Security Group Allows Public Access
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "1.1.1.1/32"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "192.0.2.0/24"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
  - ExpectedResult: true
    Mocks:
      - objectName: DMZ_TAGS
        returnValue: '[["environment", "dmz"]]'
    Name: Non DMZ Security Group Does Not Allow Public Access
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "192.168.0.0/24"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "192.0.2.0/24"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
