AnalysisType: policy
Description: >-
  This policy validates that Security Groups have restrictive permission sets that
  both limit the total number of open ports, as well as limiting ports typically associated
  with insecure protocols.
DisplayName: "AWS Security Group Tightly Restricts Inbound Traffic"
Enabled: false
Filename: aws_security_group_tightly_restricts_inbound_traffic.py
PolicyID: "AWS.SecurityGroup.TightlyRestrictsInboundTraffic"
Reference: https://docs.aws.amazon.com/cli/latest/userguide/cli-services-ec2-sg.html
Reports:
  MITRE ATT&CK:
    - TA0001:T1190
  PCI:
    - 1.1.4
    - 1.2.1
    - 8.2.1
ResourceTypes:
  - AWS.EC2.SecurityGroup
Runbook: >-
  Add appropriate restrictions to inbound traffic on Security Groups via IP permissions.
Severity: Low
Tags:
  - AWS
  - PCI
  - Initial Access:Exploit Public-Facing Application
Tests:
  - ExpectedResult: true
    Name: Security Group Tightly Restricts Inbound Traffic
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort": 443
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort": 443
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
  - ExpectedResult: false
    Name: Security Group Does Not Restrict Inbound Traffic
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
  - ExpectedResult: false
    Name: Security Group Does Not Tightly Restrict Inbound Traffic
    Resource:
      "Description": "example VPC security group"
      "GroupId": "sg-abc123"
      "GroupName": "default"
      "IpPermissions":
        - "FromPort": 20
          "IpProtocol": "-1"
          "IpRanges":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort": 50000
          "UserIdGroupPairs":
            - "Description":
              "GroupId": "sg-def123"
              "GroupName":
              "PeeringStatus":
              "UserId": "123456789012"
              "VpcId":
              "VpcPeeringConnectionId":
      "IpPermissionsEgress":
        - "FromPort":
          "IpProtocol": "-1"
          "IpRanges":
            - "CidrIp": "0.0.0.0/0"
              "Description":
          "Ipv6Ranges":
          "PrefixListIds":
          "ToPort":
          "UserIdGroupPairs":
      "OwnerId": "123456789012"
      "Tags":
        "environment": "pci"
      "VpcId": "vpc-abc111222333"
