AnalysisType: policy
Description: >-
  This policy validates that AWS VPCs (Virtual Private Clouds) have network flow logging
  enabled.
DisplayName: "AWS VPC Flow Logs"
Enabled: true
Filename: aws_vpc_flow_logs.py
PolicyID: "AWS.VPC.FlowLogs"
Reference: https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html
Reports:
  CIS:
    - 2.9
  MITRE ATT&CK:
    - TA0005:T1562
ResourceTypes:
  - AWS.EC2.VPC
Runbook: >-
  https://docs.runpanther.io/alert-runbooks/built-in-policies/aws-vpc-flow-logging-enabled
Severity: Medium
Tags:
  - AWS
  - Security Control
  - Defense Evasion:Impair Defenses
Tests:
  - ExpectedResult: false
    Name: Flow Logging Not Enabled
    Resource:
      "CidrBlock": "172.31.0.0/16"
      "CidrBlockAssociationSet":
        - "AssociationId": "vpc-cidr-assoc-112233"
          "CidrBlock": "172.0.0.0/16"
          "CidrBlockState":
            "State": "associated"
            "StatusMessage":
      "DhcpOptionsId": "dopt-1122e3344"
      "FlowLogs":
      "InstanceTenancy": "default"
      "Ipv6CidrBlockAssociationSet":
      "IsDefault": true
      "NetworkAcls":
        - "Associations":
            - "NetworkAclAssociationId": "aclassoc-1122abc444"
              "NetworkAclId": "acl-123abc"
              "SubnetId": "subnet-123abc"
            - "NetworkAclAssociationId": "aclassoc-123abc"
              "NetworkAclId": "acl-1122abc"
              "SubnetId": "subnet-112233aabb"
          "Entries":
            - "CidrBlock": "0.0.0.0/0"
              "Egress": false
              "IcmpTypeCode":
              "Ipv6CidrBlock":
              "PortRange":
              "Protocol": "-1"
              "RuleAction": "deny"
              "RuleNumber": 12345
          "IsDefault": true
          "NetworkAclId": "acl-123aabb"
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-1234321"
      "OwnerId": "112233445566"
      "RouteTables":
        - "Associations":
            - "Main": true
              "RouteTableAssociationId": "rtbassoc-1122aa33"
              "RouteTableId": "rtb-1122abc33"
              "SubnetId":
          "OwnerId": "112233445566"
          "PropagatingVgws":
          "RouteTableId": "rtb-11223344"
          "Routes":
            - "DestinationCidrBlock": "0.0.0.0/0"
              "DestinationIpv6CidrBlock":
              "DestinationPrefixListId":
              "EgressOnlyInternetGatewayId":
              "GatewayId": "igw-abc123"
              "InstanceId":
              "InstanceOwnerId":
              "NatGatewayId":
              "NetworkInterfaceId":
              "Origin": "CreateRoute"
              "State": "active"
              "TransitGatewayId":
              "VpcPeeringConnectionId":
          "Tags":
          "VpcId": "vpc-11223344"
      "SecurityGroups":
        - "Description": "default VPC security group"
          "GroupId": "sg-abc123"
          "GroupName": "default"
          "IpPermissions":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
                - "Description":
                  "GroupId": "sg-abc123"
                  "GroupName":
                  "PeeringStatus":
                  "UserId": "1122334455"
                  "VpcId":
                  "VpcPeeringConnectionId":
          "IpPermissionsEgress":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
                - "CidrIp": "0.0.0.0/0"
                  "Description":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-123454321"
      "State": "available"
      "Tags":
      "VpcId": "vpc-1234321"
  - ExpectedResult: false
    Name: Flow Logs Enabled For Type ACCEPT
    Resource:
      "CidrBlock": "172.31.0.0/16"
      "CidrBlockAssociationSet":
        - "AssociationId": "vpc-cidr-assoc-112233"
          "CidrBlock": "172.0.0.0/16"
          "CidrBlockState":
            "State": "associated"
            "StatusMessage":
      "DhcpOptionsId": "dopt-1122e3344"
      "FlowLogs":
        - "CreationTime": "2019-07-09T17:42:04.677Z"
          "DeliverLogsErrorMessage":
          "DeliverLogsPermissionArn":
          "DeliverLogsStatus": "SUCCESS"
          "FlowLogId": "fl-09798935a87d0dbc6"
          "FlowLogStatus": "ACTIVE"
          "LogDestination": "arn:aws:s3:::panther-test-vpc-flow-logs"
          "LogDestinationType": "s3"
          "LogGroupName":
          "ResourceId": "vpc-094cd5323fa3206f6"
          "TrafficType": "ACCEPT"
      "InstanceTenancy": "default"
      "Ipv6CidrBlockAssociationSet":
      "IsDefault": true
      "NetworkAcls":
        - "Associations":
            - "NetworkAclAssociationId": "aclassoc-1122abc444"
              "NetworkAclId": "acl-123abc"
              "SubnetId": "subnet-123abc"
            - "NetworkAclAssociationId": "aclassoc-123abc"
              "NetworkAclId": "acl-1122abc"
              "SubnetId": "subnet-112233aabb"
          "Entries":
            - "CidrBlock": "0.0.0.0/0"
              "Egress": false
              "IcmpTypeCode":
              "Ipv6CidrBlock":
              "PortRange":
              "Protocol": "-1"
              "RuleAction": "deny"
              "RuleNumber": 12345
          "IsDefault": true
          "NetworkAclId": "acl-123aabb"
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-1234321"
      "OwnerId": "112233445566"
      "RouteTables":
        - "Associations":
            - "Main": true
              "RouteTableAssociationId": "rtbassoc-1122aa33"
              "RouteTableId": "rtb-1122abc33"
              "SubnetId":
          "OwnerId": "112233445566"
          "PropagatingVgws":
          "RouteTableId": "rtb-11223344"
          "Routes":
            - "DestinationCidrBlock": "0.0.0.0/0"
              "DestinationIpv6CidrBlock":
              "DestinationPrefixListId":
              "EgressOnlyInternetGatewayId":
              "GatewayId": "igw-abc123"
              "InstanceId":
              "InstanceOwnerId":
              "NatGatewayId":
              "NetworkInterfaceId":
              "Origin": "CreateRoute"
              "State": "active"
              "TransitGatewayId":
              "VpcPeeringConnectionId":
          "Tags":
          "VpcId": "vpc-11223344"
      "SecurityGroups":
        - "Description": "default VPC security group"
          "GroupId": "sg-abc123"
          "GroupName": "default"
          "IpPermissions":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
                - "Description":
                  "GroupId": "sg-abc123"
                  "GroupName":
                  "PeeringStatus":
                  "UserId": "1122334455"
                  "VpcId":
                  "VpcPeeringConnectionId":
          "IpPermissionsEgress":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
                - "CidrIp": "0.0.0.0/0"
                  "Description":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-123454321"
      "State": "available"
      "Tags":
      "VpcId": "vpc-1234321"
  - ExpectedResult: true
    Name: Flow Logs Enabled For Type ALL
    Resource:
      "CidrBlock": "172.31.0.0/16"
      "CidrBlockAssociationSet":
        - "AssociationId": "vpc-cidr-assoc-112233"
          "CidrBlock": "172.0.0.0/16"
          "CidrBlockState":
            "State": "associated"
            "StatusMessage":
      "DhcpOptionsId": "dopt-1122e3344"
      "FlowLogs":
        - "CreationTime": "2019-07-09T17:42:04.677Z"
          "DeliverLogsErrorMessage":
          "DeliverLogsPermissionArn":
          "DeliverLogsStatus": "SUCCESS"
          "FlowLogId": "fl-09798935a87d0dbc6"
          "FlowLogStatus": "ACTIVE"
          "LogDestination": "arn:aws:s3:::panther-test-vpc-flow-logs"
          "LogDestinationType": "s3"
          "LogGroupName":
          "ResourceId": "vpc-094cd5323fa3206f6"
          "TrafficType": "ALL"
      "InstanceTenancy": "default"
      "Ipv6CidrBlockAssociationSet":
      "IsDefault": true
      "NetworkAcls":
        - "Associations":
            - "NetworkAclAssociationId": "aclassoc-1122abc444"
              "NetworkAclId": "acl-123abc"
              "SubnetId": "subnet-123abc"
            - "NetworkAclAssociationId": "aclassoc-123abc"
              "NetworkAclId": "acl-1122abc"
              "SubnetId": "subnet-112233aabb"
          "Entries":
            - "CidrBlock": "0.0.0.0/0"
              "Egress": false
              "IcmpTypeCode":
              "Ipv6CidrBlock":
              "PortRange":
              "Protocol": "-1"
              "RuleAction": "deny"
              "RuleNumber": 12345
          "IsDefault": true
          "NetworkAclId": "acl-123aabb"
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-1234321"
      "OwnerId": "112233445566"
      "RouteTables":
        - "Associations":
            - "Main": true
              "RouteTableAssociationId": "rtbassoc-1122aa33"
              "RouteTableId": "rtb-1122abc33"
              "SubnetId":
          "OwnerId": "112233445566"
          "PropagatingVgws":
          "RouteTableId": "rtb-11223344"
          "Routes":
            - "DestinationCidrBlock": "0.0.0.0/0"
              "DestinationIpv6CidrBlock":
              "DestinationPrefixListId":
              "EgressOnlyInternetGatewayId":
              "GatewayId": "igw-abc123"
              "InstanceId":
              "InstanceOwnerId":
              "NatGatewayId":
              "NetworkInterfaceId":
              "Origin": "CreateRoute"
              "State": "active"
              "TransitGatewayId":
              "VpcPeeringConnectionId":
          "Tags":
          "VpcId": "vpc-11223344"
      "SecurityGroups":
        - "Description": "default VPC security group"
          "GroupId": "sg-abc123"
          "GroupName": "default"
          "IpPermissions":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
                - "Description":
                  "GroupId": "sg-abc123"
                  "GroupName":
                  "PeeringStatus":
                  "UserId": "1122334455"
                  "VpcId":
                  "VpcPeeringConnectionId":
          "IpPermissionsEgress":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
                - "CidrIp": "0.0.0.0/0"
                  "Description":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-123454321"
      "State": "available"
      "Tags":
      "VpcId": "vpc-1234321"
  - ExpectedResult: true
    Name: Flow Logs Enabled For Type REJECT
    Resource:
      "CidrBlock": "172.31.0.0/16"
      "CidrBlockAssociationSet":
        - "AssociationId": "vpc-cidr-assoc-112233"
          "CidrBlock": "172.0.0.0/16"
          "CidrBlockState":
            "State": "associated"
            "StatusMessage":
      "DhcpOptionsId": "dopt-1122e3344"
      "FlowLogs":
        - "CreationTime": "2019-07-09T17:42:04.677Z"
          "DeliverLogsErrorMessage":
          "DeliverLogsPermissionArn":
          "DeliverLogsStatus": "SUCCESS"
          "FlowLogId": "fl-09798935a87d0dbc6"
          "FlowLogStatus": "ACTIVE"
          "LogDestination": "arn:aws:s3:::panther-test-vpc-flow-logs"
          "LogDestinationType": "s3"
          "LogGroupName":
          "ResourceId": "vpc-094cd5323fa3206f6"
          "TrafficType": "REJECT"
      "InstanceTenancy": "default"
      "Ipv6CidrBlockAssociationSet":
      "IsDefault": true
      "NetworkAcls":
        - "Associations":
            - "NetworkAclAssociationId": "aclassoc-1122abc444"
              "NetworkAclId": "acl-123abc"
              "SubnetId": "subnet-123abc"
            - "NetworkAclAssociationId": "aclassoc-123abc"
              "NetworkAclId": "acl-1122abc"
              "SubnetId": "subnet-112233aabb"
          "Entries":
            - "CidrBlock": "0.0.0.0/0"
              "Egress": false
              "IcmpTypeCode":
              "Ipv6CidrBlock":
              "PortRange":
              "Protocol": "-1"
              "RuleAction": "deny"
              "RuleNumber": 12345
          "IsDefault": true
          "NetworkAclId": "acl-123aabb"
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-1234321"
      "OwnerId": "112233445566"
      "RouteTables":
        - "Associations":
            - "Main": true
              "RouteTableAssociationId": "rtbassoc-1122aa33"
              "RouteTableId": "rtb-1122abc33"
              "SubnetId":
          "OwnerId": "112233445566"
          "PropagatingVgws":
          "RouteTableId": "rtb-11223344"
          "Routes":
            - "DestinationCidrBlock": "0.0.0.0/0"
              "DestinationIpv6CidrBlock":
              "DestinationPrefixListId":
              "EgressOnlyInternetGatewayId":
              "GatewayId": "igw-abc123"
              "InstanceId":
              "InstanceOwnerId":
              "NatGatewayId":
              "NetworkInterfaceId":
              "Origin": "CreateRoute"
              "State": "active"
              "TransitGatewayId":
              "VpcPeeringConnectionId":
          "Tags":
          "VpcId": "vpc-11223344"
      "SecurityGroups":
        - "Description": "default VPC security group"
          "GroupId": "sg-abc123"
          "GroupName": "default"
          "IpPermissions":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
                - "Description":
                  "GroupId": "sg-abc123"
                  "GroupName":
                  "PeeringStatus":
                  "UserId": "1122334455"
                  "VpcId":
                  "VpcPeeringConnectionId":
          "IpPermissionsEgress":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
                - "CidrIp": "0.0.0.0/0"
                  "Description":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-123454321"
      "State": "available"
      "Tags":
      "VpcId": "vpc-1234321"
  - ExpectedResult: true
    Name: Flow Logs Enabled For Types ACCEPT, ALL
    Resource:
      "CidrBlock": "172.31.0.0/16"
      "CidrBlockAssociationSet":
        - "AssociationId": "vpc-cidr-assoc-112233"
          "CidrBlock": "172.0.0.0/16"
          "CidrBlockState":
            "State": "associated"
            "StatusMessage":
      "DhcpOptionsId": "dopt-1122e3344"
      "FlowLogs":
        - "CreationTime": "2019-07-09T17:42:04.677Z"
          "DeliverLogsErrorMessage":
          "DeliverLogsPermissionArn":
          "DeliverLogsStatus": "SUCCESS"
          "FlowLogId": "fl-09798935a87d0dbc6"
          "FlowLogStatus": "ACTIVE"
          "LogDestination": "arn:aws:s3:::panther-test-vpc-flow-logs"
          "LogDestinationType": "s3"
          "LogGroupName":
          "ResourceId": "vpc-094cd5323fa3206f6"
          "TrafficType": "ACCEPT"
        - "CreationTime": "2019-07-09T17:42:04.677Z"
          "DeliverLogsErrorMessage":
          "DeliverLogsPermissionArn":
          "DeliverLogsStatus": "SUCCESS"
          "FlowLogId": "fl-09798935a87d0dbc6"
          "FlowLogStatus": "ACTIVE"
          "LogDestination": "arn:aws:s3:::panther-test-vpc-flow-logs"
          "LogDestinationType": "s3"
          "LogGroupName":
          "ResourceId": "vpc-094cd5323fa3206f6"
          "TrafficType": "ALL"
      "InstanceTenancy": "default"
      "Ipv6CidrBlockAssociationSet":
      "IsDefault": true
      "NetworkAcls":
        - "Associations":
            - "NetworkAclAssociationId": "aclassoc-1122abc444"
              "NetworkAclId": "acl-123abc"
              "SubnetId": "subnet-123abc"
            - "NetworkAclAssociationId": "aclassoc-123abc"
              "NetworkAclId": "acl-1122abc"
              "SubnetId": "subnet-112233aabb"
          "Entries":
            - "CidrBlock": "0.0.0.0/0"
              "Egress": false
              "IcmpTypeCode":
              "Ipv6CidrBlock":
              "PortRange":
              "Protocol": "-1"
              "RuleAction": "deny"
              "RuleNumber": 12345
          "IsDefault": true
          "NetworkAclId": "acl-123aabb"
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-1234321"
      "OwnerId": "112233445566"
      "RouteTables":
        - "Associations":
            - "Main": true
              "RouteTableAssociationId": "rtbassoc-1122aa33"
              "RouteTableId": "rtb-1122abc33"
              "SubnetId":
          "OwnerId": "112233445566"
          "PropagatingVgws":
          "RouteTableId": "rtb-11223344"
          "Routes":
            - "DestinationCidrBlock": "0.0.0.0/0"
              "DestinationIpv6CidrBlock":
              "DestinationPrefixListId":
              "EgressOnlyInternetGatewayId":
              "GatewayId": "igw-abc123"
              "InstanceId":
              "InstanceOwnerId":
              "NatGatewayId":
              "NetworkInterfaceId":
              "Origin": "CreateRoute"
              "State": "active"
              "TransitGatewayId":
              "VpcPeeringConnectionId":
          "Tags":
          "VpcId": "vpc-11223344"
      "SecurityGroups":
        - "Description": "default VPC security group"
          "GroupId": "sg-abc123"
          "GroupName": "default"
          "IpPermissions":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
                - "Description":
                  "GroupId": "sg-abc123"
                  "GroupName":
                  "PeeringStatus":
                  "UserId": "1122334455"
                  "VpcId":
                  "VpcPeeringConnectionId":
          "IpPermissionsEgress":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
                - "CidrIp": "0.0.0.0/0"
                  "Description":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-123454321"
      "State": "available"
      "Tags":
      "VpcId": "vpc-1234321"
  - ExpectedResult: false
    Name: Flow Logs Inactive For Type ALL
    Resource:
      "CidrBlock": "172.31.0.0/16"
      "CidrBlockAssociationSet":
        - "AssociationId": "vpc-cidr-assoc-112233"
          "CidrBlock": "172.0.0.0/16"
          "CidrBlockState":
            "State": "associated"
            "StatusMessage":
      "DhcpOptionsId": "dopt-1122e3344"
      "FlowLogs":
        - "CreationTime": "2019-07-09T17:42:04.677Z"
          "DeliverLogsErrorMessage":
          "DeliverLogsPermissionArn":
          "DeliverLogsStatus": "SUCCESS"
          "FlowLogId": "fl-09798935a87d0dbc6"
          "FlowLogStatus": "INACTIVE"
          "LogDestination": "arn:aws:s3:::panther-test-vpc-flow-logs"
          "LogDestinationType": "s3"
          "LogGroupName":
          "ResourceId": "vpc-094cd5323fa3206f6"
          "TrafficType": "ACCEPT"
      "InstanceTenancy": "default"
      "Ipv6CidrBlockAssociationSet":
      "IsDefault": true
      "NetworkAcls":
        - "Associations":
            - "NetworkAclAssociationId": "aclassoc-1122abc444"
              "NetworkAclId": "acl-123abc"
              "SubnetId": "subnet-123abc"
            - "NetworkAclAssociationId": "aclassoc-123abc"
              "NetworkAclId": "acl-1122abc"
              "SubnetId": "subnet-112233aabb"
          "Entries":
            - "CidrBlock": "0.0.0.0/0"
              "Egress": false
              "IcmpTypeCode":
              "Ipv6CidrBlock":
              "PortRange":
              "Protocol": "-1"
              "RuleAction": "deny"
              "RuleNumber": 12345
          "IsDefault": true
          "NetworkAclId": "acl-123aabb"
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-1234321"
      "OwnerId": "112233445566"
      "RouteTables":
        - "Associations":
            - "Main": true
              "RouteTableAssociationId": "rtbassoc-1122aa33"
              "RouteTableId": "rtb-1122abc33"
              "SubnetId":
          "OwnerId": "112233445566"
          "PropagatingVgws":
          "RouteTableId": "rtb-11223344"
          "Routes":
            - "DestinationCidrBlock": "0.0.0.0/0"
              "DestinationIpv6CidrBlock":
              "DestinationPrefixListId":
              "EgressOnlyInternetGatewayId":
              "GatewayId": "igw-abc123"
              "InstanceId":
              "InstanceOwnerId":
              "NatGatewayId":
              "NetworkInterfaceId":
              "Origin": "CreateRoute"
              "State": "active"
              "TransitGatewayId":
              "VpcPeeringConnectionId":
          "Tags":
          "VpcId": "vpc-11223344"
      "SecurityGroups":
        - "Description": "default VPC security group"
          "GroupId": "sg-abc123"
          "GroupName": "default"
          "IpPermissions":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
                - "Description":
                  "GroupId": "sg-abc123"
                  "GroupName":
                  "PeeringStatus":
                  "UserId": "1122334455"
                  "VpcId":
                  "VpcPeeringConnectionId":
          "IpPermissionsEgress":
            - "FromPort":
              "IpProtocol": "-1"
              "IpRanges":
                - "CidrIp": "0.0.0.0/0"
                  "Description":
              "Ipv6Ranges":
              "PrefixListIds":
              "ToPort":
              "UserIdGroupPairs":
          "OwnerId": "112233445566"
          "Tags":
          "VpcId": "vpc-123454321"
      "State": "available"
      "Tags":
      "VpcId": "vpc-1234321"
