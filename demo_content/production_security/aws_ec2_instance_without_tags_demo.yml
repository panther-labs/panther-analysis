AnalysisType: rule
RuleID: "AWS.EC2.Instance.Launch.NoTags.Demo"
DisplayName: EC2 Instance Launched Without Required Tags
Enabled: true
Filename: aws_ec2_instance_without_tags_demo.py
LogTypes:
  - AWS.CloudTrail
Severity: High
Description: >
  Detects when an EC2 instance is launched without the required tags 'team_owner' or 'deployment_segment'.
  This may indicate a server spun up outside of normal processes, potentially for malicious purposes.
Tags:
  - aws.ec2
  - demo
  - resource.create
  - compliance.soc2
  - discovery.cloud_services
  - policy.change
  - defense_evasion.account_manipulation
InlineFilters:
  - KeyPath: eventSource
    Condition: Equals
    Value: ec2.amazonaws.com
  - KeyPath: eventName
    Condition: Equals
    Value: RunInstances
  - KeyPath: errorCode
    Condition: IsNullOrEmpty
  - KeyPath: errorMessage
    Condition: IsNullOrEmpty
Tests:
  # tagSpecificationSet: both tags present (should not alert)
  - Name: tagSpecificationSet - both tags present
    ExpectedResult: false
    Log:
      eventSource: ec2.amazonaws.com
      eventName: RunInstances
      requestParameters:
        tagSpecificationSet:
          items:
            - tags:
                - key: team_owner
                  value: security
                - key: deployment_segment
                  value: prod
  # tagSpecificationSet: missing one tag (should alert)
  - Name: tagSpecificationSet - missing deployment_segment
    ExpectedResult: true
    Log:
      eventSource: ec2.amazonaws.com
      eventName: RunInstances
      requestParameters:
        tagSpecificationSet:
          items:
            - tags:
                - key: team_owner
                  value: security
  # tagSpecification: both tags present (should not alert)
  - Name: tagSpecification - both tags present
    ExpectedResult: false
    Log:
      eventSource: ec2.amazonaws.com
      eventName: RunInstances
      requestParameters:
        tagSpecification:
          - tags:
              - key: team_owner
                value: security
              - key: deployment_segment
                value: prod
  # tagSpecification: missing one tag (should alert)
  - Name: tagSpecification - missing team_owner
    ExpectedResult: true
    Log:
      eventSource: ec2.amazonaws.com
      eventName: RunInstances
      requestParameters:
        tagSpecification:
          - tags:
              - key: deployment_segment
                value: prod
  # responseElements.instancesSet: both tags present (should not alert)
  - Name: responseElements.instancesSet - both tags present
    ExpectedResult: false
    Log:
      eventSource: ec2.amazonaws.com
      eventName: RunInstances
      responseElements:
        instancesSet:
          items:
            - tagSet:
                items:
                  - key: team_owner
                    value: security
                  - key: deployment_segment
                    value: prod
  # responseElements.instancesSet: missing one tag (should alert)
  - Name: responseElements.instancesSet - missing deployment_segment
    ExpectedResult: true
    Log:
      eventSource: ec2.amazonaws.com
      eventName: RunInstances
      responseElements:
        instancesSet:
          items:
            - tagSet:
                items:
                  - key: team_owner
                    value: security
  # No tags present anywhere (should alert)
  - Name: No tags present
    ExpectedResult: true
    Log:
      eventSource: ec2.amazonaws.com
      eventName: RunInstances
      requestParameters:
        tagSpecification: []
  # All tag locations present, both tags present (should not alert)
  - Name: All tag locations, both tags present
    ExpectedResult: false
    Log:
      eventSource: ec2.amazonaws.com
      eventName: RunInstances
      requestParameters:
        tagSpecificationSet:
          items:
            - tags:
                - key: team_owner
                  value: security
                - key: deployment_segment
                  value: prod
        tagSpecification:
          - tags:
              - key: team_owner
                value: security
              - key: deployment_segment
                value: prod
      responseElements:
        instancesSet:
          items:
            - tagSet:
                items:
                  - key: team_owner
                    value: security
                  - key: deployment_segment
                    value: prod 