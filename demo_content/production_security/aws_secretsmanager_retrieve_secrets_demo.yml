AnalysisType: rule
Filename: aws_secretsmanager_retrieve_secrets_demo.py
RuleID: "AWS.SecretsManager.RetrieveSecrets.Demo"
DisplayName: "AWS Secrets Manager Suspicious Activity"
Enabled: true
LogTypes:
  - AWS.CloudTrail
Tags:
  - Secret Access
  - Secret Management
  - Reconnaissance
Reports:
  MITRE ATT&CK:
    - TA0006:T1552 # Credentials from Password Stores
    - TA0007:T1087 # Account Discovery
Severity: Medium  # Dynamic severity in rule
Description: >
  Detects suspicious AWS Secrets Manager activity including reconnaissance (ListSecrets), 
  targeted investigation (DescribeSecret), and secret retrieval (GetSecretValue, BatchGetSecretValue). 
  Monitors for enumeration patterns that may indicate an attacker mapping available secrets 
  for lateral movement.
Runbook: >
  1. Identify the principal and verify if the activity is expected
  2. Check for progression from ListSecrets -> DescribeSecret -> GetSecretValue
  3. Review which specific secrets were accessed and their sensitivity
  4. Correlate with other suspicious activity from the same principal
  5. If unauthorized, rotate accessed secrets and revoke principal access
  6. Investigate how the principal obtained permissions to Secrets Manager
Reference: "https://stratus-red-team.cloud/attack-techniques/AWS/aws.credential-access.secretsmanager-retrieve-secrets/"
InlineFilters:
  - KeyPath: userIdentity.arn
    Condition: DoesNotContain
    Value: arn:aws:sts::904233115233:assumed-role/panther-ops-tools-function
Threshold: 1
DedupPeriodMinutes: 60
SummaryAttributes:
  - userIdentity.arn
  - eventName
  - sourceIpAddress
  - userAgent
Tests:
  - Name: ListSecrets reconnaissance triggers alert
    ExpectedResult: true
    Mocks:
      - objectName: get_string_set
        returnValue: '["1634567890", "1634567891"]'
      - objectName: add_to_string_set
        returnValue: '["1634567890", "1634567891", "1634567892"]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: ListSecrets
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      requestID: "1634567892"
      sourceIPAddress: "123.123.123.123"
      userIdentity:
        type: IAMUser
        principalId: "AIDAJ45Q7YFFAREXAMPLE"
        arn: "arn:aws:iam::123123123123:user/testuser"
        accountId: "123123123123"
        userName: "testuser"

  - Name: DescribeSecret enumeration triggers alert
    ExpectedResult: true
    Mocks:
      - objectName: get_string_set
        returnValue: '["secret1", "secret2", "secret3"]'
      - objectName: add_to_string_set
        returnValue: '["secret1", "secret2", "secret3", "secret4"]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: DescribeSecret
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      requestParameters:
        secretId: "arn:aws:secretsmanager:us-west-2:123123123123:secret:secret4"
      sourceIPAddress: "123.123.123.123"
      userIdentity:
        type: IAMUser
        principalId: "AIDAJ45Q7YFFAREXAMPLE"
        arn: "arn:aws:iam::123123123123:user/testuser"
        accountId: "123123123123"
        userName: "testuser"

  - Name: GetSecretValue retrieval triggers alert
    ExpectedResult: true
    Mocks:
      - objectName: get_string_set
        returnValue: '["secret1", "secret2", "secret3", "secret4"]'
      - objectName: add_to_string_set
        returnValue: '["secret1", "secret2", "secret3", "secret4", "secret5"]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: GetSecretValue
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      requestParameters:
        secretId: "arn:aws:secretsmanager:us-west-2:123123123123:secret:secret5"
      sourceIPAddress: "123.123.123.123"
      userIdentity:
        type: IAMUser
        principalId: "AIDAJ45Q7YFFAREXAMPLE"
        arn: "arn:aws:iam::123123123123:user/testuser"
        accountId: "123123123123"
        userName: "testuser"

  - Name: Single GetSecretValue does not trigger
    ExpectedResult: false
    Mocks:
      - objectName: get_string_set
        returnValue: '[]'
      - objectName: add_to_string_set
        returnValue: '["secret1"]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: GetSecretValue
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      requestParameters:
        secretId: "arn:aws:secretsmanager:us-west-2:123123123123:secret:secret1"
      sourceIPAddress: "123.123.123.123"
      userIdentity:
        type: IAMUser
        principalId: "AIDAJ45Q7YFFAREXAMPLE"
        arn: "arn:aws:iam::123123123123:user/testuser"
        accountId: "123123123123"
        userName: "testuser"

  - Name: Duplicate activity does not trigger
    ExpectedResult: false
    Mocks:
      - objectName: get_string_set
        returnValue: '["secret1", "secret2", "secret3"]'
      - objectName: add_to_string_set
        returnValue: '["secret1", "secret2", "secret3"]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: GetSecretValue
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      requestParameters:
        secretId: "arn:aws:secretsmanager:us-west-2:123123123123:secret:secret2"
      sourceIPAddress: "123.123.123.123"
      userIdentity:
        type: IAMUser
        principalId: "AIDAJ45Q7YFFAREXAMPLE"
        arn: "arn:aws:iam::123123123123:user/testuser"
        accountId: "123123123123"
        userName: "testuser"

  - Name: Missing requestID for ListSecrets does not trigger
    ExpectedResult: false
    Mocks:
      - objectName: get_string_set
        returnValue: '[]'
      - objectName: add_to_string_set
        returnValue: '[]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: ListSecrets
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      sourceIPAddress: "123.123.123.123"
      userIdentity:
        type: IAMUser
        principalId: "AIDAJ45Q7YFFAREXAMPLE"
        arn: "arn:aws:iam::123123123123:user/testuser"
        accountId: "123123123123"
        userName: "testuser"

  - Name: BatchGetSecretValue triggers immediately
    ExpectedResult: true
    Mocks:
      - objectName: get_string_set
        returnValue: '[]'
      - objectName: add_to_string_set
        returnValue: '["1634567890"]'
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: BatchGetSecretValue
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      requestID: "1634567890"
      sourceIPAddress: "123.123.123.123"
      userIdentity:
        type: IAMUser
        principalId: "AIDAJ45Q7YFFAREXAMPLE"
        arn: "arn:aws:iam::123123123123:user/testuser"
        accountId: "123123123123"
        userName: "testuser"

  - Name: Missing secretId for DescribeSecret does not trigger
    ExpectedResult: false
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: DescribeSecret
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      sourceIPAddress: "123.123.123.123"
      userIdentity:
        type: IAMUser
        principalId: "AIDAJ45Q7YFFAREXAMPLE"
        arn: "arn:aws:iam::123123123123:user/testuser"
        accountId: "123123123123"
        userName: "testuser"

  - Name: Failed request ignored
    ExpectedResult: false
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: GetSecretValue
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "123123123123"
      errorCode: "AccessDenied"
      errorMessage: "User is not authorized"
      requestParameters:
        secretId: "arn:aws:secretsmanager:us-west-2:123123123123:secret:secret1"
      sourceIPAddress: "123.123.123.123"
      userIdentity:
        type: IAMUser
        principalId: "AIDAJ45Q7YFFAREXAMPLE"
        arn: "arn:aws:iam::123123123123:user/testuser"
        accountId: "123123123123"
        userName: "testuser"

  - Name: Panther ops tools filtered out
    ExpectedResult: false
    Log:
      awsRegion: us-west-2
      eventCategory: Management
      eventID: "dfd6d93a-2ce6-4dbe-8939-86b8ba67c868"
      eventName: GetSecretValue
      eventSource: secretsmanager.amazonaws.com
      eventTime: "2024-10-17 21:48:45.000000000"
      eventType: AwsApiCall
      eventVersion: "1.09"
      managementEvent: true
      readOnly: true
      recipientAccountId: "904233115233"
      requestParameters:
        secretId: "panther-managed-admin-secret-904233115233"
      sourceIPAddress: "44.252.197.78"
      userIdentity:
        type: AssumedRole
        arn: "arn:aws:sts::904233115233:assumed-role/panther-ops-tools-function-20250710205949097300000005/panther-ops-tools"
        accountId: "904233115233"