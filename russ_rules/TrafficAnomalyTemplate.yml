AnalysisType: saved_query
QueryName: "TrafficAnomalyTemplate"
Query: "-- pragma: template  \n\n{% macro traffic_anomaly(tableName, lookbackDays=15) export %} \n\n-- run this 1hr after midnight each day\nWITH \n-- measure traffic\ntraffic_days as (\nSELECT\n   date(date_trunc('day', p_event_time)) as day,\n   count(1) as nrows\nFROM\n   panther_logs.public.{{tableName}}\nWHERE\n   p_occurs_since('{{2|add:lookbackDays}} days') -- pad by 2 days to avoid paritial data\nGROUP BY \n   day\n),\nenumerated_days as (\nSELECT\n   dateadd('day',-1*(ROW_NUMBER() OVER (ORDER BY seq4())), CURRENT_DATE()::date) as day, \n  0 as nrows \nFROM -- go back lookbackDays NOT including today (skip partial day)\n  TABLE(GENERATOR(ROWCOUNT => {{lookbackDays}})) v\n),\n-- merge enumerated days and traffic days (to add any 0 traffic days)\nfull_days as (\nSELECT \n  e.day as day, \n  IFNULL(t.nrows, e.nrows) as nrows\nFROM enumerated_days e LEFT OUTER JOIN traffic_days t USING(day)\n),\nfull_days_minus_current AS (\nSELECT * \nFROM full_days \nORDER BY day ASC LIMIT {{\"-1\"|integer|add:lookbackDays}} \n),\ncomputed_stats AS (\nSELECT\n AVG(nrows) as average,\n STDDEV(nrows) as std_deviation,\n (SELECT nrows FROM full_days ORDER BY day DESC LIMIT 1) as current_nrows,\n ABS( AVG(nrows) - (SELECT nrows FROM full_days ORDER BY day DESC LIMIT 1) ) as diff\nFROM full_days_minus_current\n)\n-- make a pretty report\nSELECT OBJECT_CONSTRUCT(\n        'tableName', '{{tableName}}',\n        'stats', OBJECT_CONSTRUCT(\n                     'current_nrows', current_nrows,\n                     'diff', diff,\n                     'avg', average,\n                     'stdev', std_deviation \n                   ),\n        'counts', (SELECT \n                       ARRAY_SORT(ARRAY_AGG(OBJECT_CONSTRUCT('day', day, 'nrows', nrows)))\n                   FROM full_days ORDER BY day DESC)\n) devation\nFROM computed_stats \nWHERE\n  diff > std_deviation\n\n{% endmacro %}\n\n"
