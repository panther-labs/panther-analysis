AnalysisType: correlation_rule
RuleID: "AWS.User.Takeover.Via.Password.Reset"
DisplayName: "AWS User Takeover Via Password Reset"
Enabled: true
Severity: High
Reports:
  MITRE ATT&CK:
    - TA0004:T1098.001 # Additional Cloud Credentials
Detection:
    - Sequence:
        - ID: Password Reset
          RuleID: AWS.CloudTrail.LoginProfileCreatedOrModified
        - ID: Login
          RuleID: AWS.Console.Login
      Transitions:
        - ID: Password Reset TO Login ON IP Addr
          From: Password Reset
          To: Login
          Match:
            - On: userIdentity.principalId
      Schedule:
        RateMinutes: 60
        TimeoutMinutes: 10
      LookbackWindowMinutes: 90
Tests:
    - Name: Password Reset, Then Login From Same user
      ExpectedResult: true
      RuleOutputs:
        - ID: Password Reset
          Matches:
            userIdentity.principalId:
                'ABCDE:alice':
                  - "2024-06-01T10:00:00Z"
        - ID: Login
          Matches:
            userIdentity.principalId:
                'ABCDE:alice':
                  - "2024-06-01T10:02:00Z"
    - Name: Password Reset, Then Login From Different users
      ExpectedResult: false
      RuleOutputs:
        - ID: Password Reset
          Matches:
            userIdentity.principalId:
                'ABCDE:alice':
                  - "2024-06-01T10:00:00Z"
        - ID: Login
          Matches:
            userIdentity.principalId:
                'ABCDE:bob':
                  - "2024-06-01T10:02:00Z"
    - Name: Password Reset Without Login
      ExpectedResult: false
      RuleOutputs:
        - ID: Password Reset
          Matches:
            userIdentity.principalId:
                'ABCDE:alice':
                  - "2024-06-01T10:00:00Z"
    - Name: Login Without Password Reset
      ExpectedResult: false
      RuleOutputs:
        - ID: Login
          Matches:
            userIdentity.principalId:
                'ABCDE:alice':
                  - "2024-06-01T10:00:00Z"
    - Name: Password Reset, Then Login From Same user after long time
      ExpectedResult: false
      RuleOutputs:
        - ID: Password Reset
          Matches:
            userIdentity.principalId:
                'ABCDE:alice':
                  - "2024-06-01T10:00:00Z"
        - ID: Login
          Matches:
            userIdentity.principalId:
                'ABCDE:alice':
                  - "2024-06-01T13:02:00Z"
