AnalysisType: correlation_rule
Detection:
  - LookbackWindowMinutes: 2160
    Schedule:
      RateMinutes: 1440
      TimeoutMinutes: 10
    Sequence:
      - ID: Password Reset
        RuleID: AWS.CloudTrail.LoginProfileCreatedOrModified
      - ID: Login
        RuleID: AWS.Console.Login
    Transitions:
      - From: Password Reset
        ID: Password Reset TO Login ON IP Addr
        Match:
          - On: p_alert_context.ip_and_username
        To: Login
        WithinTimeFrameMinutes: 60
DisplayName: "AWS User Takeover Via Password Reset"
Enabled: true
Reports:
  MITRE ATT&CK:
    - TA0004:T1098.001
RuleID: "AWS.User.Takeover.Via.Password.Reset"
Severity: High
Tests:
  - ExpectedResult: true
    Name: Password Reset, Then Login From Same IP
    RuleOutputs:
      - ID: Password Reset
        Matches:
          p_alert_context.ip_and_username:
            1.1.1.1alice:
              - '2024-06-01T10:01:01Z'
      - ID: Login
        Matches:
          p_alert_context.ip_and_username:
            1.1.1.1alice:
              - '2024-06-01T10:02:01Z'
  - ExpectedResult: false
    Name: Password Reset, Then Login From different user
    RuleOutputs:
      - ID: Password Reset
        Matches:
          p_alert_context.ip_and_username:
            1.1.1.1alice:
              - '2024-06-01T10:01:01Z'
      - ID: Login
        Matches:
          p_alert_context.ip_and_username:
            1.1.1.1bob:
              - '2024-06-01T10:02:01Z'
  - ExpectedResult: false
    Name: Password Reset, Then Login From Different IPs
    RuleOutputs:
      - ID: Password Reset
        Matches:
          p_alert_context.ip_and_username:
            1.1.1.1alice:
              - '2024-06-01T10:01:01Z'
      - ID: Login
        Matches:
          p_alert_context.ip_and_username:
            2.2.2.2alice:
              - '2024-06-01T10:02:01Z'
  - ExpectedResult: false
    Name: Password Reset Without Login
    RuleOutputs:
      - ID: Password Reset
        Matches:
          p_alert_context.ip_and_username:
            1.1.1.1alice:
              - '2024-06-01T10:01:01Z'
  - ExpectedResult: false
    Name: Login Without Password Reset
    RuleOutputs:
      - ID: Login
        Matches:
          p_alert_context.ip_and_username:
            1.1.1.1alice:
              - '2024-06-01T10:01:01Z'
