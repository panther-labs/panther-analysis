AnalysisType: correlation_rule
Description: >-
  Detects a sequence of events that could indicate a privilege escalation attempt
  via GCP's tag-based access control. The sequence includes: 1. Enumeration of IAM
  policies and tags 2. Creation of a tag binding 3. Performance of a privileged operation
Detection:
  - LookbackWindowMinutes: 2160
    Schedule:
      RateMinutes: 1440
      TimeoutMinutes: 5
    Sequence:
      - ID: Enumeration
        RuleID: GCP.IAM.Tag.Enumeration
      - ID: TagBinding
        RuleID: GCP.Tag.Binding.Creation
      - ID: PrivilegedOperation
        RuleID: GCP.Privileged.Operation
    Transitions:
      - From: Enumeration
        ID: Enumeration FOLLOWED BY TagBinding
        Match:
          - On: p_alert_context.principal
        To: TagBinding
        WithinTimeFrameMinutes: 15
      - From: TagBinding
        ID: TagBinding FOLLOWED BY PrivilegedOperation
        Match:
          - On: p_alert_context.principal
        To: PrivilegedOperation
        WithinTimeFrameMinutes: 15
DisplayName: "GCP Privilege Escalation via TagBinding"
Enabled: true
Reference: https://cloud.google.com/resource-manager/docs/tags/tags-overview
Reports:
  MITRE ATT&CK:
    - TA0004:T1548
RuleID: "GCP.Privilege.Escalation.Via.TagBinding"
Runbook: >-
  Verify if the user has legitimate business need for this sequence of operations.
  If unauthorized, revoke the tag binding and review IAM policies.
Severity: Info
Tags:
  - attack.privilege_escalation
  - attack.t1548
  - gcp
  - iam
  - tagbinding
  - Beta
Tests:
  - ExpectedResult: true
    Name: Complete Attack Sequence
    RuleOutputs:
      - ID: Enumeration
        Matches:
          p_alert_context.principal:
            test@example.com:
              - '2024-06-01T10:00:00Z'
      - ID: TagBinding
        Matches:
          p_alert_context.principal:
            test@example.com:
              - '2024-06-01T10:00:05Z'
      - ID: PrivilegedOperation
        Matches:
          p_alert_context.principal:
            test@example.com:
              - '2024-06-01T10:00:10Z'
  - ExpectedResult: false
    Name: Incomplete Sequence
    RuleOutputs:
      - ID: Enumeration
        Matches:
          p_alert_context.principal:
            test@example.com:
              - '2024-06-01T10:00:00Z'
      - ID: PrivilegedOperation
        Matches:
          p_alert_context.principal:
            test@example.com:
              - '2024-06-01T10:00:10Z'
