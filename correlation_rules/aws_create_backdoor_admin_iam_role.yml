AnalysisType: correlation_rule
Description: >-
  Identifies when CreateRole and AttachAdminRolePolicy CloudTrail events occur in
  a short period of time. This sequence could indicate a potential security breach.
Detection:
  - LookbackWindowMinutes: 2160
    Schedule:
      RateMinutes: 1440
      TimeoutMinutes: 5
    Sequence:
      - ID: CreateRole
        RuleID: AWS.IAM.CreateRole
      - ID: AttachAdminRolePolicy
        RuleID: AWS.IAM.AttachAdminRolePolicy
    Transitions:
      - From: CreateRole
        ID: CreateRole FOLLOWED BY AttachAdminRolePolicy
        Match:
          - On: p_alert_context.request_rolename
        To: AttachAdminRolePolicy
        WithinTimeFrameMinutes: 60
DisplayName: "AWS Backdoor Administrative IAM Role Created"
Enabled: true
Reference: https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html
Reports:
  MITRE ATT&CK:
    - TA0007:T1078
RuleID: "AWS.Backdoor.Administrative.IAM.Role.Created"
Severity: High
Tests:
  - ExpectedResult: true
    Name: Role Created, Followed By Policy Attachment
    RuleOutputs:
      - ID: CreateRole
        Matches:
          p_alert_context.request_rolename:
            new-role:
              - '2024-06-01T10:00:01Z'
      - ID: AttachAdminRolePolicy
        Matches:
          p_alert_context.request_rolename:
            new-role:
              - '2024-06-01T10:30:01Z'
  - ExpectedResult: false
    Name: Role Created, Not Followed By Policy Attachment
    RuleOutputs:
      - ID: CreateRole
        Matches:
          p_alert_context.request_rolename:
            new-role:
              - '2024-06-01T10:00:01Z'
