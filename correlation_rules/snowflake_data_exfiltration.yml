AnalysisType: correlation_rule
RuleID: "Snowflake.Data.Exfiltration"
DisplayName: "Snowflake Temp Stage Created FOLLOWED BY Copy Into Stage FOLLOWED BY Data Download"
Enabled: true
Severity: Critical
Description: In April 2024, Mandiant received threat intelligence on database records that were subsequently determined to have originated from a victim’s Snowflake instance. Mandiant notified the victim, who then engaged Mandiant to investigate suspected data theft involving their Snowflake instance. During this investigation, Mandiant determined that the organization’s Snowflake instance had been compromised by a threat actor using credentials previously stolen via infostealer malware. The threat actor used these stolen credentials to access the customer’s Snowflake instance and ultimately exfiltrate valuable data. At the time of the compromise, the account did not have multi-factor authentication (MFA) enabled.
Reference: https://cloud.google.com/blog/topics/threat-intelligence/unc5537-snowflake-data-theft-extortion/
Detection:
- Sequence:
    - ID: SnowflakeTempStageCreated
      RuleID: Snowflake.TempStageCreated
    - ID: SnowflakeCopyIntoStage
      RuleID: Snowflake.CopyIntoStage
    - ID: SnowflakeFileDownloaded
      RuleID: Snowflake.FileDownloaded

  Transitions:
    - ID: Match SnowflakeTempStageCreated and SnowflakeCopyIntoStage on stage
      From: SnowflakeTempStageCreated   
      To: SnowflakeCopyIntoStage
      Match:
        - On: stage

    - ID: Match SnowflakeCopyIntoStage and SnowflakeFileDownloaded on path
      From: SnowflakeCopyIntoStage   
      To: SnowflakeFileDownloaded
      Match:
        - On: path
  
  Schedule:
    RateMinutes: 720
    TimeoutMinutes: 2
    
  LookbackWindowMinutes: 1440
Tests:
    - Name: Test-663425
      ExpectedResult: true
      RuleOutputs:
        - ID: SnowflakeTempStageCreated
          Matches:
            stage:
                LOGS.PUBLIC.data_exfil:
                    - "2006-01-02T15:04:05Z"
                    - "2006-01-02T15:04:06Z"
        - ID: SnowflakeCopyIntoStage
          Matches:
            stage:
                LOGS.PUBLIC.data_exfil:
                    - "2006-01-02T15:04:05Z"
                    - "2006-01-02T15:04:06Z"
            path:
                LOGS.PUBLIC.data_exfil/DATA.csv:
                    - "2006-01-02T15:04:05Z"
                    - "2006-01-02T15:04:06Z"
        - ID: SnowflakeFileDownloaded
          Matches:
            path:
                LOGS.PUBLIC.data_exfil/DATA.csv:
                    - "2006-01-02T15:04:05Z"
                    - "2006-01-02T15:04:06Z"