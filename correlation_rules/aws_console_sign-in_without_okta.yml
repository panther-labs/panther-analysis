AnalysisType: correlation_rule
Description: >-
  A user has logged into the AWS console without authenticating via Okta.  This rule
  requires AWS SSO via Okta and both log sources configured.
Detection:
  - LookbackWindowMinutes: 2160
    Schedule:
      RateMinutes: 1440
      TimeoutMinutes: 5
    Sequence:
      - Absence: true
        ID: Okta SSO to AWS
        RuleID: Okta.SSO.to.AWS
      - ID: AWS Console Sign-In
        RuleID: AWS.Console.Sign-In
    Transitions:
      - From: Okta SSO to AWS
        ID: Okta SSO to AWS TO AWS Console Sign-In ON username
        Match:
          - From: p_alert_context.actor
            To: userIdentity.userName
        To: AWS Console Sign-In
        WithinTimeFrameMinutes: 15
DisplayName: "AWS Console Sign-In NOT PRECEDED BY Okta Redirect"
Enabled: false
RuleID: "AWS.Console.Sign-In.NOT.PRECEDED.BY.Okta"
Severity: High
Tags:
  - AWS
  - Configuration Required
  - Okta
  - Actor Profiles
Tests:
  - ExpectedResult: false
    Name: AWS Console Sign-In PRECEDED BY Okta Redirect
    RuleOutputs:
      - ID: Okta SSO to AWS
        Matches:
          p_alert_context.actor:
            igor.stravinsky:
              - 0
      - ID: AWS Console Sign-In
        Matches:
          userIdentity.userName:
            igor.stravinsky:
              - 2
  - ExpectedResult: true
    Name: AWS Console Sign-In NOT PRECEDED BY Okta Redirect
    RuleOutputs:
      - ID: AWS Console Sign-In
        Matches:
          userIdentity.userName:
            igor.stravinsky:
              - 2
