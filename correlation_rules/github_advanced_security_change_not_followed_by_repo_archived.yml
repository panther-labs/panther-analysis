AnalysisType: correlation_rule
Description: >-
  Identifies when advances security change was made not to archive a repo. Eliminates
  false positives in the Advances Security Change Rule when the repo is archived.
Detection:
  - EventEvaluationOrder: Chronological
    Group:
      - ID: GHASChange
        RuleID: GitHub.Advanced.Security.Change
      - Absence: true
        ID: RepoArchived
        RuleID: Github.Repo.Archived
    LookbackWindowMinutes: 90
    MatchCriteria:
      field_name:
        - GroupID: GHASChange
          Match: p_alert_context.repo
        - GroupID: RepoArchived
          Match: p_alert_context.repo
    Schedule:
      RateMinutes: 60
      TimeoutMinutes: 10
DisplayName: "GitHub Advanced Security Change WITHOUT Repo Archived"
Enabled: true
Reference: 
  https://docs.github.com/en/code-security/getting-started/auditing-security-alerts
RuleID: "GitHub.Advanced.Security.Change.NOT.FOLLOWED.BY.Repo.Archived"
Severity: Critical
Tests:
  - ExpectedResult: false
    Name: Security Change on Repo, Followed By Same Repo Archived
    RuleOutputs:
      - ID: RepoArchived
        Matches:
          p_alert_context.repo:
            my-org/example-repo:
              - '2024-06-01T10:00:05Z'
      - ID: GHASChange
        Matches:
          p_alert_context.repo:
            my-org/example-repo:
              - '2024-06-01T10:00:01Z'
  - ExpectedResult: false
    Name: Repo Archived followed by GHAS change on same repo
    RuleOutputs:
      - ID: RepoArchived
        Matches:
          p_alert_context.repo:
            my-org/example-repo:
              - '2024-06-01T10:00:01Z'
      - ID: GHASChange
        Matches:
          p_alert_context.repo:
            my-org/example-repo:
              - '2024-06-01T10:00:05Z'
  - ExpectedResult: true
    Name: Security Change on Repo, Followed By Different Repo Archived
    RuleOutputs:
      - ID: GHASChange
        Matches:
          p_alert_context.repo:
            my-org/example-repo:
              - '2024-06-01T10:00:00Z'
      - ID: RepoArchived
        Matches:
          p_alert_context.repo:
            my-org/other-repo:
              - '2024-06-01T10:00:01Z'
  - ExpectedResult: true
    Name: Security Change on Repo, Not Followed By Repo Archived
    RuleOutputs:
      - ID: GHASChange
        Matches:
          p_alert_context.repo:
            my-org/example-repo:
              - '2024-06-01T10:00:00Z'
