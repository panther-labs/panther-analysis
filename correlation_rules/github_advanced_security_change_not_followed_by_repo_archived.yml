AnalysisType: correlation_rule
RuleID: "GitHub.Advanced.Security.Change.NOT.FOLLOWED.BY.Repo.Archived"
DisplayName: "GitHub Advanced Security Change WITHOUT Repo Archived"
Enabled: true
Severity: Critical
Tags:
  - GitHub
  - Code Security
  - Defense Evasion
  - Configuration Change
Reports:
  MITRE ATT&CK:
    - TA0005:T1562.001
Description: >
  This correlation rule identifies when GitHub Advanced Security (GHAS) settings are modified or disabled on a repository without the repository being archived within 90 minutes. GitHub Advanced Security provides critical security capabilities including code scanning, secret scanning, and dependency review that detect vulnerabilities and exposed credentials in code. Disabling or weakening these security controls without archiving the repository is suspicious behavior that could indicate an attacker attempting to hide malicious code changes, prevent detection of newly introduced secrets or vulnerabilities, or establish persistence without triggering security alerts. Legitimate use cases for disabling GHAS typically involve archiving the repository since archived repositories are read-only and no longer under active development. This rule eliminates false positives by only alerting when GHAS is modified but the repository remains active and unarchived, suggesting potential defense evasion. An attacker with sufficient permissions could disable GHAS to facilitate malicious activities such as committing backdoors, exfiltrating secrets, introducing supply chain attacks, or modifying CI/CD pipelines without detection. Organizations should investigate any GHAS modifications that are not followed by repository archival to ensure they are authorized and have legitimate business justification.
Runbook: |
  1. Review the alert details to identify the repository where GitHub Advanced Security settings were modified and the user/account that made the change
  2. Navigate to the GitHub repository audit log (organization settings > Audit log) and filter for the specific repository and timeframe to identify the GHAS change (look for "advanced_security.disable", "secret_scanning.disable", or "code_scanning.disable" events)
  3. Verify whether the repository was archived after the GHAS change by checking for "repo.archived" events within the 90-minute lookback window
  4. Contact the user who made the GHAS configuration change to verify if this was an authorized action and check if there is a corresponding change request or approval in your change management system
  5. Review recent commits to the repository (before and after the GHAS change) to identify any suspicious code changes, new secrets, backdoors, or malicious modifications, and examine CI/CD configuration files for unauthorized modifications
  6. Use GitHub's secret scanning history and code scanning alerts to check if any new secrets or vulnerabilities were committed around the time GHAS was disabled
  7. Check the repository's branch protection rules and required status checks to ensure security controls remain in place, and review the user account's recent activity across all repositories
  8. If the GHAS change was unauthorized: Immediately re-enable all GitHub Advanced Security features (code scanning, secret scanning, dependency review) on the affected repository
  9. If malicious code or secrets were introduced: Rotate any exposed credentials, remove malicious code, force-push to revert unauthorized commits (if safe to do so), and scan for indicators of compromise; if the account was compromised: revoke access tokens, require password reset, and enable MFA
  10. Document the incident in your security incident management system and consider implementing required approvals or branch protection rules that prevent individuals from unilaterally disabling GHAS on critical repositories
Reference: https://docs.github.com/en/code-security/getting-started/auditing-security-alerts
Detection:
  - Group:
      - ID: GHASChange
        RuleID: GitHub.Advanced.Security.Change
      - ID: RepoArchived
        RuleID: Github.Repo.Archived
        Absence: true
    MatchCriteria: 
      field_name:
      - GroupID: GHASChange
        Match: p_alert_context.repo
      - GroupID: RepoArchived
        Match: p_alert_context.repo
    EventEvaluationOrder: Chronological
    LookbackWindowMinutes: 90
    Schedule:
      RateMinutes: 60
      TimeoutMinutes: 10
Tests:
    - Name: Security Change on Repo, Followed By Same Repo Archived
      ExpectedResult: false
      RuleOutputs:
        - ID: RepoArchived
          Matches:
            p_alert_context.repo:
              my-org/example-repo:
                - "2024-06-01T10:00:05Z"
        - ID: GHASChange
          Matches:
            p_alert_context.repo:
              my-org/example-repo:
                - "2024-06-01T10:00:01Z"
    - Name: Repo Archived followed by GHAS change on same repo
      ExpectedResult: false
      RuleOutputs:
        - ID: RepoArchived
          Matches:
            p_alert_context.repo:
              my-org/example-repo:
                - "2024-06-01T10:00:01Z"
        - ID: GHASChange
          Matches:
            p_alert_context.repo:
              my-org/example-repo:
                - "2024-06-01T10:00:05Z"
    - Name: Security Change on Repo, Followed By Different Repo Archived
      ExpectedResult: true
      RuleOutputs:
        - ID: GHASChange
          Matches:
            p_alert_context.repo:
              my-org/example-repo:
                - "2024-06-01T10:00:00Z"
        - ID: RepoArchived
          Matches:
            p_alert_context.repo:
              my-org/other-repo:
                - "2024-06-01T10:00:01Z"
    - Name: Security Change on Repo, Not Followed By Repo Archived
      ExpectedResult: true
      RuleOutputs:
        - ID: GHASChange
          Matches:
            p_alert_context.repo:
              my-org/example-repo:
                - "2024-06-01T10:00:00Z"