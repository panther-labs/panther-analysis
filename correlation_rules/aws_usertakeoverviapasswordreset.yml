AnalysisType: correlation_rule
RuleID: "AWS.UserTakeoverViaPasswordReset"
DisplayName: "AWS.UserTakeoverViaPasswordReset"
Enabled: true
Severity: High
Detection:
    - Sequence:
        - ID: Password Reset
          RuleID: AWS.CloudTrail.LoginProfileCreatedOrModified
          MinMatchCount: 1
          # TODO add a discovery step
        - ID: Login
          RuleID: AWS.Console.Login
          MinMatchCount: 1
      Transitions:
        - ID: Password Reset TO Login ON IP Addr
          From: Password Reset
          To: Login
          Match:
            - On: sourceIPAddress
      Schedule:
        RateMinutes: 15
        TimeoutMinutes: 2
      LookbackWindowMinutes: 60
Tests:
    - Name: Password Reset, Then Login From Same IP
      ExpectedResult: true
      RuleOutputs:
        - ID: Password Reset
          Matches:
            sourceIPAddress:
              '1.1.1.1': [0]
        - ID: Login
          Matches:
            sourceIPAddress:
              '1.1.1.1': [5]
    - Name: Password Reset, Then Login From Different IPs
      ExpectedResult: false
      RuleOutputs:
        - ID: Password Reset
          Matches:
            sourceIPAddress:
              '1.1.1.1': [0]
        - ID: Login
          Matches:
            sourceIPAddress:
              '2.2.2.2': [5]
    - Name: Password Reset Without Login
      ExpectedResult: false
      RuleOutputs:
        - ID: Password Reset
          Matches:
            sourceIPAddress:
              '1.1.1.1': [0]
    - Name: Login Without Password Reset
      ExpectedResult: false
      RuleOutputs:
        - ID: Login
          Matches:
            sourceIPAddress:
              '1.1.1.1': [5]
