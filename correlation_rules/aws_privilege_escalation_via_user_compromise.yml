AnalysisType: correlation_rule
Detection:
  - LookbackWindowMinutes: 2160
    Schedule:
      RateMinutes: 1440
      TimeoutMinutes: 10
    Sequence:
      - ID: User Backdoored
        RuleID: AWS.IAM.Backdoor.User.Keys
      - ID: User Accessed
        RuleID: AWS.CloudTrail.UserAccessKeyAuth
    Transitions:
      - From: User Backdoored
        ID: User Backdoored TO User Accessed ON IP Addr
        Match:
          - On: p_alert_context.ip_accessKeyId
        To: User Accessed
        WithinTimeFrameMinutes: 60
DisplayName: "AWS Privilege Escalation Via User Compromise"
Enabled: true
Reports:
  MITRE ATT&CK:
    - TA0004:T1098.001
RuleID: "AWS.Privilege.Escalation.Via.User.Compromise"
Severity: Medium
Tests:
  - ExpectedResult: true
    Name: Access Key Created and Used from Same IP
    RuleOutputs:
      - ID: User Backdoored
        Matches:
          p_alert_context.ip_accessKeyId:
            1.1.1.1-FAKE_ACCESS_KEY_ID:
              - 0
      - ID: User Accessed
        Matches:
          p_alert_context.ip_accessKeyId:
            1.1.1.1-FAKE_ACCESS_KEY_ID:
              - 30
  - ExpectedResult: false
    Name: Access Key Created and Used from Different IPs
    RuleOutputs:
      - ID: User Backdoored
        Matches:
          p_alert_context.ip_accessKeyId:
            1.1.1.1-FAKE_ACCESS_KEY_ID:
              - 0
      - ID: User Accessed
        Matches:
          p_alert_context.ip_accessKeyId:
            2.2.2.2-FAKE_ACCESS_KEY_ID:
              - 30
  - ExpectedResult: false
    Name: Single IP Creates Access Key, Uses Different Key
    RuleOutputs:
      - ID: User Backdoored
        Matches:
          p_alert_context.ip_accessKeyId:
            1.1.1.1-FAKE_ACCESS_KEY_ID:
              - 0
      - ID: User Accessed
        Matches:
          p_alert_context.ip_accessKeyId:
            1.1.1.1-OTHER_ACCESS_KEY_ID:
              - 30
  - ExpectedResult: false
    Name: Access Key Created But Not Used
    RuleOutputs:
      - ID: User Backdoored
        Matches:
          p_alert_context.ip_accessKeyId:
            1.1.1.1-FAKE_ACCESS_KEY_ID:
              - 0
  - ExpectedResult: false
    Name: Access Key Used But Not Created
    RuleOutputs:
      - ID: User Accessed
        Matches:
          p_alert_context.ip_accessKeyId:
            1.1.1.1-FAKE_ACCESS_KEY_ID:
              - 30
