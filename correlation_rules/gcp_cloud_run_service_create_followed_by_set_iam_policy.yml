AnalysisType: correlation_rule
RuleID: "GCP.Cloud.Run.Service.Created.FOLLOWED.BY.Set.IAM.Policy"
DisplayName: "GCP Cloud Run Service Created FOLLOWED BY Set IAM Policy"
Enabled: true
Severity: High
Description: Detects run.services.create method for privilege escalation in GCP. The exploit creates a new Cloud Run 
  Service that, when invoked, returns the Service Accountâ€™s access token by accessing the metadata API of the server 
  it is running on.
Reference: https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/
Runbook: Confirm this was authorized and necessary behavior
Reports:
    MITRE ATT&CK:
        - TA0004:T1548  # Abuse Elevation Control Mechanism
Detection:
    - Sequence:
        # Create a list of rules to correlate
        - ID: ID.1
          RuleID: GCP.Cloud.Run.Service.Created
          MinMatchCount: 1
        - ID: ID.2
          RuleID: GCP.Cloud.Run.Set.IAM.Policy
          MinMatchCount: 1
      Transitions:
        # Add conditions for each transition, if needed (otherwise, the rules and rule groups will simply follow a default sequence)
        - ID: TR1
          From: ID.1
          To: ID.2
          WithinTimeFrameMinutes: 60
          Match:
            - On: p_alert_context.caller_ip
      LookbackWindowMinutes: 60
      Schedule:
        # Required scheduled rule settings
        RateMinutes: 60 # or CronExpression, required field
        TimeoutMinutes: 1