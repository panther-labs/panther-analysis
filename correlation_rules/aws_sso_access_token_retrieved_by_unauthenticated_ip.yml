AnalysisType: correlation_rule
Description: >-
  When using AWS in an enterprise environment, best practices dictate to use a single
  sign-on service for identity and access management. AWS SSO is a popular solution,
  integrating with third-party providers such as Okta and allowing to centrally manage
  roles and permissions in multiple AWS accounts.


  In this post, we demonstrate that AWS SSO is vulnerable by design to device code
  authentication phishing â€“ just like any identity provider implementing OpenID Connect
  device code authentication. This technique was first demonstrated by Dr. Nestori
  Syynimaa for Azure AD. The feature provides a powerful phishing vector for attackers,
  rendering ineffective controls such as MFA (including Yubikeys) or IP allow-listing
  at the IdP level.
Detection:
  - LookbackWindowMinutes: 2160
    Schedule:
      RateMinutes: 1440
      TimeoutMinutes: 5
    Sequence:
      - Absence: true
        ID: Absent CLI Prompt
        RuleID: Sign-in.with.AWS.CLI.prompt
      - ID: SSO Access Token Retrieved
        RuleID: Retrieve.SSO.access.token
    Transitions:
      - From: Absent CLI Prompt
        ID: Absent CLI Prompt TO Access Token Retrieved ON IP Addr
        Match:
          - On: sourceIPAddress
        To: SSO Access Token Retrieved
        WithinTimeFrameMinutes: 120
DisplayName: "AWS SSO Access Token Retrieved by Unauthenticated IP"
Enabled: true
Reference: 
  https://blog.christophetd.fr/phishing-for-aws-credentials-via-aws-sso-device-code-authentication/
RuleID: "AWS.SSO.Access.Token.Retrieved.by.Unauthenticated.IP"
Severity: Medium
Tests:
  - ExpectedResult: false
    Name: AWS SSO Access Token Retrieved by Authenticated IP
    RuleOutputs:
      - ID: Absent CLI Prompt
        Matches:
          sourceIPAddress:
            1.2.3.4:
              - 0
      - ID: SSO Access Token Retrieved
        Matches:
          sourceIPAddress:
            1.2.3.4:
              - 2
  - ExpectedResult: true
    Name: AWS SSO Access Token Retrieved by Unauthenticated IP
    RuleOutputs:
      - ID: SSO Access Token Retrieved
        Matches:
          sourceIPAddress:
            1.2.3.4:
              - 2
