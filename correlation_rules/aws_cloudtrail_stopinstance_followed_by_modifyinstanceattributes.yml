AnalysisType: correlation_rule
Description: >-
  Identifies when StopInstance and ModifyInstanceAttributes CloudTrail events occur
  in a short period of time. Since EC2 startup scripts cannot be modified without
  first stopping the instance, StopInstances should be a signal.
Detection:
  - LookbackWindowMinutes: 2160
    Schedule:
      RateMinutes: 1440
      TimeoutMinutes: 5
    Sequence:
      - ID: StopInstance
        RuleID: AWS.EC2.StopInstances
      - ID: StartupScriptChange
        RuleID: AWS.EC2.Startup.Script.Change
    Transitions:
      - From: StopInstance
        ID: StopInstance FOLLOWED BY StartupScriptChange
        Match:
          - On: p_alert_context.instance_ids
        To: StartupScriptChange
        WithinTimeFrameMinutes: 90
DisplayName: "StopInstance FOLLOWED BY ModifyInstanceAttributes"
Enabled: true
Reference: 
  https://unit42.paloaltonetworks.com/malicious-operations-of-exposed-iam-keys-cryptojacking/
Reports:
  MITRE ATT&CK:
    - TA0002:T1059
RuleID: "AWS.EC2.StopInstance.FOLLOWED.BY.ModifyInstanceAttributes"
Severity: High
Tests:
  - ExpectedResult: true
    Name: Instance Stopped, Followed By Script Change
    RuleOutputs:
      - ID: StopInstance
        Matches:
          p_alert_context.instance_ids:
            i-abcdef0123456789a:
              - '2024-06-01T10:00:01Z'
      - ID: StartupScriptChange
        Matches:
          p_alert_context.instance_ids:
            i-abcdef0123456789a:
              - '2024-06-01T10:01:01Z'
  - ExpectedResult: false
    Name: Instance Stopped, Not Followed By Script Change
    RuleOutputs:
      - ID: StopInstance
        Matches:
          p_alert_context.instance_ids:
            i-abcdef0123456789a:
              - '2024-06-01T10:00:01Z'
