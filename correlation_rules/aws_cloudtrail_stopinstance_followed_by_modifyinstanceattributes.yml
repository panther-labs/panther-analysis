AnalysisType: correlation_rule
RuleID: "AWS.CloudTrail.StopInstance.FOLLOWED.BY.ModifyInstanceAttributes"
DisplayName: "StopInstance FOLLOWED BY ModifyInstanceAttributes"
Enabled: true
Severity: High
Description: Identifies when StopInstance and ModifyInstanceAttributes CloudTrail events occur in a short period of time. Since EC2 startup scripts cannot be modified without first stopping the instance, StopInstances should be a signal.
Reference: https://unit42.paloaltonetworks.com/malicious-operations-of-exposed-iam-keys-cryptojacking/
Detection:
    - Sequence:
        - ID: StopInstance
          RuleID: AWS.CloudTrail.StopInstances
        - ID: StartupScriptChange
          RuleID: AWS.EC2.Startup.Script.Change
      Transitions:
        - ID: StopInstance FOLLOWED BY StartupScriptChange
          From: StopInstance
          To: StartupScriptChange
          Match:
            - On: p_alert_context.instance_id
            # TODO: instance_id in StopInstance is a list, but in StartupScriptChange it is a string
      LookbackWindowMinutes: 90
      Schedule:
        RateMinutes: 60 
        TimeoutMinutes: 1
