AnalysisType: correlation_rule
RuleID: "AWS.CloudTrail.StopInstance.FOLLOWED.BY.ModifyInstanceAttributes"
DisplayName: "StopInstance FOLLOWED BY ModifyInstanceAttributes"
Enabled: true
Severity: High
Description: Identifies when StopInstance and ModifyInstanceAttributes CloudTrail events occur in a short period of time. Since EC2 startup scripts cannot be modified without first stopping the instance, StopInstances should be a signal.
Reference: https://unit42.paloaltonetworks.com/malicious-operations-of-exposed-iam-keys-cryptojacking/
Detection:
    - Sequence:
        # Create a list of rules to correlate
        - ID: ID.1
          RuleID: AWS.CloudTrail.StopInstances
          MinMatchCount: 1
        - ID: ID.2
          RuleID: AWS.EC2.Startup.Script.Change
          MinMatchCount: 1
      Transitions:
        # Add conditions for each transition, if needed (otherwise, the rules and rule groups will simply follow a default sequence)
        - ID: TR1
          From: ID.1
          To: ID.2
          WithinTimeFrameMinutes: 60
          Match:
            - On: p_alert_context.instance_id
      LookbackWindowMinutes: 60
      Schedule:
        # Required scheduled rule settings 
        RateMinutes: 60 # or CronExpression, required field 
        TimeoutMinutes: 1
