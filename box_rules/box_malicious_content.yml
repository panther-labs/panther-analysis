AnalysisType: rule
Filename: box_malicious_content.py
RuleID: Box.Malicious.Content
DisplayName: Malicious Content Detected
Enabled: true
LogTypes:
  - Box.Event
Tags:
  - Box
Severity: High
Description: >
  Box has detect malicious content, such as a virus. 
Reference: >
  https://developer.box.com/guides/events/shield-alert-events/, 
  https://developer.box.com/reference/resources/event/
Runbook: >
  Investigate whether this is a false positive or if the virus needs to be contained appropriately.
SummaryAttributes:
  - event_type
Tests:
  -
    Name: Regular Event
    ExpectedResult: false
    Log:
      {
        "type": "event",
        "additional_details": {
          "key": "value"
        },
        "created_by": {
          "id": 12345678,
          "type": "user",
          "login": "cat@example",
          "name": "Bob Cat"
        },
        "event_type": "DELETE",
        "source": {
          "item_id": 123456789012,
          "item_name": "regular_file.pdf",
          "item_type": "file",
          "owned_by": {
            "id": 12345678,
            "type": "user",
            "login": "cat@example",
            "name": "Bob Cat"
          },
          "parent": {
            "id": 12345,
            "type": "folder",
            "etag": 1,
            "name": "Parent_Folder",
            "sequence_id": 2
          }
        }
      }
  -
    Name: File marked malicious
    ExpectedResult: true
    Log:
      {
        "type": "event",
        "additional_details": {
          "key": "value"
        },
        "created_by": {
          "id": 12345678,
          "type": "user",
          "login": "cat@example",
          "name": "Bob Cat"
        },
        "event_type": "FILE_MARKED_MALICIOUS",
        "source": {
          "item_id": 123456789012,
          "item_name": "bad_file.pdf",
          "item_type": "file",
          "owned_by": {
            "id": 12345678,
            "type": "user",
            "login": "cat@example",
            "name": "Bob"
          },
          "parent": {
            "id": 12345,
            "type": "folder",
            "etag": 1,
            "name": "Parent_Folder",
            "sequence_id": 2
          }
        }
      }
  -
    Name: Malicious Content
    ExpectedResult: true
    Log:
      {
        "type": "event",
        "additional_details":{
          "shield_alert":{
            "rule_category":"Malicious Content",
            "rule_id":123,
            "rule_name":"Viruses and stuff",
            "risk_score":100,
            "alert_summary":{
              "upload_activity":{
                "occurred_at":"2020-01-20T01:37:05-08:00",
                "event_type":"Upload",
                "item_name":"malware.exe",
                "item_type":"file",
                "item_id":"123",
                "item_path":"path/to/file",
                "sha1_hash":"",
                "ip_info":{
                  "ip":"1.2.3.4",
                  "latitude":"25.44444",
                  "longitude":"-110.55555",
                  "registrant":"A Company",
                  "country_code":"US",
                  "city_name":"San Jose",
                  "region_name":"California"
                },
                "service_name":"A service"
              }
            },
            "malware_info":{
              "file_id":123,
              "file_name":"malware.exe",
              "file_version":123456789,
              "file_created":"2020-01-20T01:37:05-08:00",
              "file_created_by":{
                "id":1234,
                "name":"Bob",
                "email":"cat@example"
              },
              "file_version_uploaded_by":{
                "id":1011,
                "name":"Mountain",
                "email":"lion@example"
              },
              "status":"Malicious",
              "categories":[
                "Adware",
                "SpyWare"
              ],
              "tags":[
                "FILE_MALICIOUS_EXECUTION",
                "FILE_OTHER_TAG"
              ],
              "description":"A bad file containing malicious content",
              "malware_name":"ReallyBadStuff",
              "first_seen":"2020-01-19T01:37:05-08:00",
              "last_seen":"2020-01-20T01:37:05-08:00",
              "family":"FamilyOfMalware"
            },
            "alert_id":1234,
            "priority":"high",
            "user":{
              "id":5555,
              "name":"Bob",
              "email":"cat@example"
            },
            "link":"https://app.box.com/master/shield/alerts/1234",
            "created_at":"2020-01-20T01:37:15-08:00"
          }
        },
        "created_by": {
          "id": 12345678,
          "type": "user",
          "login": "bob@example",
          "name": "Bob Cat"
        },
        "event_type": "SHIELD_ALERT",
        "source": {
          "id": 12345678,
          "type": "user",
          "created_at": "2012-12-12T10:53:43-08:00",
          "language": "en",
          "login": "bob@example",
          "max_upload_size": 88999900,
          "modified_at": "2012-12-12T10:53:43-08:00",
          "name": "Bob Cat",
          "notification_email": {
            "email": "notifications@example",
            "is_confirmed": true
          },
          "phone": 1234567890,
          "status": "active",
        }
      } 