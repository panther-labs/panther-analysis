{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Panther Rule",
    "description": "A Detection for security events which is based on log data",
  
    "type": "object",
    "properties": {
      "AnalysisType": {
        "$ref": "#/definitions/AnalysisType"
      },
      "DisplayName": {
        "$ref": "#/definitions/DisplayName"
      },
      "Enabled": {
        "$ref": "#/definitions/Enabled"
      },
      "Filename": {
        "$ref": "#/definitions/Filename"
      },
      "RuleID": {
        "$ref": "#/definitions/RuleID"
      },
      "Severity": {
        "$ref": "#/definitions/Severity"
      },
      "Tests": {
        "type": "array",
        "items": {"$ref": "#/definitions/UnitTestCase"}
      },
      "Description": {
        "$ref": "#/definitions/Description"
      },
      "LogTypes": {
        "$ref": "#/definitions/LogTypes"
      },
      "Tags": {
        "$ref": "#/definitions/Tags"
      },
      "Runbook": {
        "$ref": "#/definitions/Runbook"
      },
      "SummaryAttributes": {
        "$ref": "#/definitions/SummaryAttributes"
      },
      "DedupPeriodMinutes": {
        "$ref": "#/definitions/DedupPeriodMinutes"
      },
      "Reports": {
        "$ref": "#/definitions/Reports"
      },
      "Reference": {
        "$ref": "#/definitions/Reference"
      },
      "Threshold": {
        "$ref": "#/definitions/Threshold"
      },
      "ScheduledQueries": {
        "$ref": "#/definitions/ScheduledQueries"
      }
    },
    "required": [
      "AnalysisType",
      "DisplayName", 
      "Enabled",
      "Filename",
      "RuleID", 
      "Severity",
      "Tests"
    ],
    "additionalProperties": false,
    "definitions": {
      "AnalysisType": {
        "description": "what kind of detection",
        "type": "string",
        "enum": [
          "rule",
          "scheduled_rule"
        ],
        "default": "rule"
      },
      "DisplayName": {
        "description": "A DisplayName of the detection",
        "default": "A human friendly name for your detection",
        "type": "string",
        "minLength": 1
      },
      "Enabled": {
        "description": "Should this rule run automatically",
        "type": "boolean",
        "default": true
      },
      "Filename": {
        "title": "Filename to the python file that acommpanies this detection.",
        "description": "Python file with the detection logic",
        "type": "string",
        "default": "this_file.py"
      },
      "RuleID": {
        "$comment": "https://docs.panther.com/detections/writing-and-editing-detections",
        "description": "A unique string to identify this rule",
        "default": "LogType.DetectionClassification.Specific",
        "type": "string"
      },
      "Description": {
        "$comment": "https://docs.panther.com/detections/writing-and-editing-detections/rules",
        "description": "Description is a short sentence that describes what the detection detects.",
        "type": "string"
      },
      "DedupPeriodMinutes": {
        "$comment": "https://docs.panther.com/detections/writing-and-editing-detections/rules",
        "description": "A number of minutes to supress additional alerts, based on the output of the dedup function",
        "type": "integer"
      },
      "Reference": {
        "$comment": "https://docs.panther.com/detections/writing-and-editing-detections/rules",
        "description": "Reference material for alert. This might be a description or a link",
        "type": "string"
      },
      "Reports": {
        "$comment": "https://docs.panther.com/detections/writing-and-editing-detections/rules",
        "description": "Reports describe which Benchmarks might apply to the detection, like CIS or ATT&CK",
        "type": "object"
      },
      "ScheduledQueries": {
        "$comment": "Which scheduled queries feed input to this rule",
        "description": "Scheduled Query IDs",
        "type": "string"
      },
      "Severity": {
        "$comment": "What severity should emitted alerts possess?",
        "description": "Alert severity",
        "default": "Medium",
        "type": "string",
        "enum": [
            "Info",
            "Low",
            "Medium",
            "High",
            "Critical"
          ]
      },
      "Threshold": {
        "$comment": "How many events should match this rule before an alert is fired",
        "description": "Threshold of event matches before alerting",
        "default": 1,
        "type": "integer"
      },
      "SummaryAttributes": {
        "$comment": "Enter the attributes you want to showcase in the alerts that are triggered by this detection",
        "description": "Enter the attributes you want to showcase in the alerts that are triggered by this detection",
        "type": "array",
        "items": [
          {"type": "string"}
        ]
      },
      "Tags": {
        "$comment": "Enter custom tags to help you understand the rule at a glance",
        "description": "Enter custom tags to help you understand the rule at a glance",
        "type": "array",
        "items": [
          {"type": "string"}
        ]
      },
      "LogTypes": {
        "id": "LogTypes",
        "description": "which log types should this work against",
        "type": "array",
        "items": [
          {"type": "string"}
        ],
        "minItems": 1
      },
      "Runbook": {
        "$comment": "https://docs.panther.com/detections/writing-and-editing-detections",
        "description": "Runbook instructions go here",
        "default": "What should people do when this alert fires?",
        "type": "string",
        "minLength": 1
      },
      "Tests": {
        "$comment": "https://docs.panther.com/detections/writing-and-editing-detections",
        "description": "Unit test cases",
        "type": "array",
        "items": { "$ref": "#/definitions/UnitTestCase"}
      },
      "UnitTestCase": {
        "type": "object",
        "properties": {
          "Name": {
            "type": "string",
            "default": "Unit test case name"
          },
          "ExpectedResult": {
            "type": "boolean",
            "$comment": "If this test case should alert or not",
            "description": "true for Alert, false for NotAlert.",
            "default": true
          },
          "Log": {
            "anyOf": [
              {
                "if": {
                  "properties": { "AnalysisType": {"enum": ["rule"]} }
                },
                "then": { 
                  "type": "object",
                  "comment": "A log entry, json or yaml formatted",
                  "description": "the log data"
                },
                "else": false
              }
            ]
          },
          "Resource": {
            "anyOf": [
              {
                "if": {
                  "properties": { "AnalysisType": {"enum": ["scheduled_rule"]} }
                },
                "then": { 
                  "type": "object",
                  "comment": "A resource definition entry, json or yaml formatted",
                  "description": "the resource data"
                },
                "else": false
              }
            ]
          }
        },
        "allOf": [
          {
            "if": {
              "properties": { "AnalysisType": {"enum": ["rule"]} }
            },
            "then": { 
              "required": [ "Name", "ExpectedResult", "Log" ] 
            }
          }
        ]
      }
    }
  }