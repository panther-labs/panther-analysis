on:
  pull_request:
  merge_group:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'ECR image tag to use (default: panther-analysis-latest)'
        required: false
        default: 'panther-analysis-latest'

permissions:
  contents: read

jobs:
  test:
    if: github.event.pull_request.head.repo.fork == true
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout panther-analysis
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2

      - name: Set python version
        uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 #v5.4.0
        with:
          python-version: "3.11"

      - name: Install pipenv
        run: pip install pipenv

      - name: Setup venv
        run: make venv

      - name: test
        run: |
          make data-models-unit-test global-helpers-unit-test
          pipenv run panther_analysis_tool test --show-failures-only

  test-authenticated:
    if: github.event.pull_request.head.repo.fork == false
    name: Test
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    env:
      API_HOST: ${{ secrets.API_HOST }}
      API_TOKEN: ${{ secrets.API_TOKEN }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@ececac1a45f3b08a01d2dd070d28d111c5fe6722
        with:
          role-to-assume: arn:aws:iam::349240696275:role/DockerCI
          aws-region: us-west-2
          role-session-name: docker
      
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076
      
      - name: Checkout panther-analysis
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 #v4.2.2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@f7ce87c1d6bead3e36075b2ce75da1f6cc28aaca

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.event.inputs.image_tag || 'panther-analysis-latest' }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Validate Secrets
        if: ${{ env.API_HOST == '' || env.API_TOKEN == '' }}
        run: |
          echo "API_HOST or API_TOKEN not set"
          exit 0
          
      - name: Pull and run tests
        env:
          ECR_REGISTRY: 349240696275.dkr.ecr.us-west-2.amazonaws.com
          IMAGE_TAG: ${{ github.event.inputs.image_tag || 'panther-analysis-latest' }}
        run: |
          # Pull with buildx to use cache
          docker buildx imagetools inspect $ECR_REGISTRY/panther-community:$IMAGE_TAG || docker pull $ECR_REGISTRY/panther-community:$IMAGE_TAG
          docker run --rm -v $(pwd):/home/panther-analysis $ECR_REGISTRY/panther-community:$IMAGE_TAG pipenv run panther_analysis_tool test --api-host $API_HOST --api-token $API_TOKEN --show-failures-only
